---
layout: default
---

<!-- ... 所有的 Liquid, HTML, 和 CSS 内容保持完全不变 ... -->

<style>
  /* ... 所有样式保持不变 ... */
</style>

{% include site-header.html %}
<div class="doc-nav-overlay"></div>
<button class="doc-nav-fab" aria-label="Open documentation navigation">
  <!-- ... SVG ... -->
</button>

<main class="main container container--doc layout-doc {% if show_toc %}has-right-toc{% endif %}">
  <!-- ... main 标签内的所有内容保持不变 ... -->
</main>

<!-- JavaScripts section with Dual-Insurance implementation -->
<script>
/***********************************************************************
 * --- MODIFICATION: Dual-Insurance Scroll Restoration ---
 *
 * The DocNavController object is now defined in the parent scope so that
 * both 'DOMContentLoaded' and 'load' event listeners can access it.
 ***********************************************************************/

const DocNavController = {
  SCROLL_STORAGE_KEY: 'docNavScrollPos',
  EXPAND_STORAGE_KEY: 'docNavExpandedItems',
  body: document.body,
  fab: document.querySelector('.doc-nav-fab'),
  overlay: document.querySelector('.doc-nav-overlay'),
  navContainer: document.querySelector('.doc-nav-container'),
  closeButton: document.querySelector('.doc-nav-close'),
  scrollArea: document.querySelector('.doc-nav-scroll-area'),

  init: function() {
    if (!this.navContainer) return;
    this.setupMobileHeight();
    // The first, optimistic attempt to apply state happens here.
    this.applyStoredState(); 
    this.bindEvents();
  },

  applyStoredState: function() {
    // This function can now be safely called multiple times.
    const expandedItems = JSON.parse(sessionStorage.getItem(this.EXPAND_STORAGE_KEY));
    if (expandedItems) {
      document.querySelectorAll('.doc-nav-item[data-url]').forEach(item => {
        if (expandedItems.includes(item.dataset.url)) {
          item.classList.add('is-expanded');
        }
      });
    } else {
      document.querySelectorAll('.doc-nav-item--l1[data-url]').forEach(item => {
        item.classList.add('is-expanded');
      });
    }
    
    const scrollPos = sessionStorage.getItem(this.SCROLL_STORAGE_KEY);
    if (scrollPos && this.scrollArea) {
      this.scrollArea.scrollTop = parseInt(scrollPos, 10);
    }
  },

  saveState: function() {
    if (!this.scrollArea) return;
    sessionStorage.setItem(this.SCROLL_STORAGE_KEY, this.scrollArea.scrollTop);
    const expandedUrls = [];
    document.querySelectorAll('.doc-nav-item.is-expanded[data-url]').forEach(item => {
      expandedUrls.push(item.dataset.url);
    });
    sessionStorage.setItem(this.EXPAND_STORAGE_KEY, JSON.stringify(expandedUrls));
  },

  bindEvents: function() {
    if (this.fab) this.fab.addEventListener('click', this.openNav.bind(this));
    if (this.overlay) this.overlay.addEventListener('click', this.closeNav.bind(this));
    if (this.closeButton) this.closeButton.addEventListener('click', this.closeNav.bind(this));

    this.navContainer.addEventListener('click', e => {
      const toggle = e.target.closest('.doc-nav-toggle-wrapper');
      if (toggle) {
        toggle.closest('.doc-nav-item').classList.toggle('is-expanded');
        this.saveState();
      }
      
      const link = e.target.closest('.doc-nav-link');
      if (link) {
        const parentItem = link.closest('.doc-nav-item');
        if (parentItem && parentItem.querySelector('.doc-nav-list') && !parentItem.classList.contains('is-expanded')) {
          parentItem.classList.add('is-expanded');
        }
        this.saveState();
      }
    });

    window.addEventListener('resize', this.debounce(this.setupMobileHeight.bind(this), 150));
  },

  openNav: function() { this.body.classList.add('doc-nav-open'); },
  closeNav: function() { this.body.classList.remove('doc-nav-open'); },
  
  setupMobileHeight: function() {
    const vh = window.innerHeight * 0.01;
    document.documentElement.style.setProperty('--vh', `${vh}px`);
    document.documentElement.style.setProperty('--doc-nav-dynamic-height', `${window.innerHeight}px`);
  },

  debounce: function(func, delay) {
    let timeout;
    return function(...args) {
      const later = () => {
        clearTimeout(timeout);
        func.apply(this, args);
      };
      clearTimeout(timeout);
      timeout = setTimeout(later, delay);
    };
  }
};

/***********************************************************************
 * --- MODIFICATION: Implementing the Dual-Insurance Listeners ---
 ***********************************************************************/

// 1. First Insurance: The fast, optimistic attempt.
// We initialize the entire controller here, which includes the first
// call to applyStoredState().
document.addEventListener('DOMContentLoaded', () => {
  DocNavController.init();
});

// 2. Second Insurance: The guaranteed, corrective attempt.
// We only call applyStoredState() again. This will correct any errors
// from the first attempt that occurred due to slow-loading resources.
window.addEventListener('load', () => {
  DocNavController.applyStoredState();
});

</script>
<script>/* Image path script (unchanged) */ document.addEventListener('DOMContentLoaded',function(){const e="{{ page.collection }}";if(!e)return;const t=`/uploads/${e}/`,o=document.querySelector(".article--doc");if(!o)return;o.querySelectorAll("img").forEach(e=>{const o=e.getAttribute("src");if(o&&o.startsWith("./")){const s=o.substring(2),n=t+s;e.setAttribute("src",n)}})});</script>

{% include tts-reader.html %}
{% include content-toc.html %}
{% include site-footer.html %}