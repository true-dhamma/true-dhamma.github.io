---
layout: default
---

{%- comment %}
  ============================================================================
  PART 1: DATA PREPARATION (Jekyll/Liquid) - (已重构)
  ============================================================================
{%- endcomment %}

{%- comment %} --- 判断是否需要渲染TOC的HTML骨架 --- {% endcomment %}
{%- assign show_toc_feature = false -%}
{%- if page.toc == true -%}
  {%- assign show_toc_feature = true -%}
{%- endif -%}

{%- comment %} --- 判断是否启用三栏布局 (右侧TOC)，必须有TOC且没有aside --- {% endcomment %}
{%- assign show_right_container = false -%}
{%- if show_toc_feature == true and page.aside != true -%}
  {%- assign show_right_container = true -%}
{%- endif -%}

{%- comment %} --- 左侧书籍导航数据 --- {% endcomment %}
{%- assign collection_name = page.collection -%}
{%- assign book_data = site.data.books[collection_name] -%}
{%- assign book_title = book_data.title | default: collection_name | capitalize -%}
{%- assign book_chapters = book_data.chapters -%}

{%- comment %} --- 页面标题数据 --- {% endcomment %}
{%- assign page_title_from_data = "" -%}
{%- for chapter in book_chapters -%}
  {%- if chapter.url == page.url -%}{%- assign page_title_from_data = chapter.title -%}{% break %}{%- endif -%}
  {%- if chapter.subitems -%}
    {%- for subitem in chapter.subitems -%}
      {%- if subitem.url == page.url -%}{%- assign page_title_from_data = subitem.title -%}{% break %}{%- endif -%}
       {%- if subitem.subitems -%}
        {%- for subsubitem in subitem.subitems -%}
          {%- if subsubitem.url == page.url -%}{%- assign page_title_from_data = subsubitem.title -%}{% break %}{%- endif -%}
        {%- endfor -%}
        {%- if page_title_from_data != "" %}{% break %}{% endif %}
       {%- endif -%}
    {%- endfor -%}
    {%- if page_title_from_data != "" %}{% break %}{% endif %}
  {%- endif -%}
{%- endfor -%}
{%- assign page_title_to_display = page_title_from_data | default: page.title | default: "Untitled" -%}

{%- comment %}
  ============================================================================
  PART 2: INLINE CSS - (已更新命名)
  ============================================================================
{%- endcomment %}
<style>
  .doc-nav-container, .doc-chapter-toc { display: none; }
  .doc-nav-fab { position: fixed; bottom: 30px; left: 30px; width: 56px; height: 56px; background-color: #2c3e50; color: white; border-radius: 50%; border: none; display: flex; justify-content: center; align-items: center; box-shadow: 0 4px 12px rgba(0,0,0,0.2); cursor: pointer; z-index: 1001; transition: transform 0.2s ease-in-out; }
  .doc-nav-fab:hover { transform: scale(1.05); }
  .doc-nav-fab .icon { width: 24px; height: 24px; fill: currentColor; }
  .doc-nav-mobile-menu { position: fixed; top: 0; left: 0; width: 80%; max-width: 320px; height: 100%; background-color: white; z-index: 1002; transform: translateX(-100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); box-shadow: 0 0 20px rgba(0,0,0,0.2); overflow-y: auto; }
  .doc-nav-mobile-menu.is-open { transform: translateX(0); }
  .doc-nav-mobile-menu .doc-nav-scroll-area { padding-top: 2em; }
  .doc-nav-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 1000; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s; }
  .doc-nav-overlay.is-visible { opacity: 1; visibility: visible; }
  
  /* ★ 更新: 中间TOC容器样式 */
  .toc-middle-container {
    display: none; margin: 2em 0; padding: 1.2em 1.5em; border: 1px solid #e0e0e0; border-radius: 8px; background-color: #f8f9fa;
  }
  .toc-middle-container h3 { margin-top: 0; }

  @media screen and (min-width: 1200px) {
    .doc-nav-fab, .doc-nav-mobile-menu, .doc-nav-overlay, #toc-middle-container { display: none !important; }
    .main.container--doc { display: flex; gap: 2.5em; max-width: 1420px; margin: 0 auto; align-items: flex-start; }
    .doc-nav-container { display: block; flex: 0 0 280px; position: sticky; top: 2rem; max-height: calc(100vh - 4rem); }
    .article--doc { flex: 1 1 auto; min-width: 0; }
    /* ★ 更新: has-right-toc 这个class现在由Liquid更智能地控制 */
    .main.container--doc.has-right-toc .doc-chapter-toc { display: block; flex: 0 0 260px; position: sticky; top: 2rem; max-height: calc(100vh - 4rem); overflow-y: auto; }
  }

  @media screen and (min-width: 1600px) {
    .main.container--doc { max-width: 1600px; gap: 3em; }
    .doc-nav-container { flex-basis: 320px; }
  }

  .doc-nav-scroll-area { height: 100%; overflow-y: auto; background-color: #f1f3f5; border: 1px solid #e0e0e0; border-radius: 8px; padding: 1em; }
  .doc-nav-container h3 { display: none; }
  .doc-nav-container ul { list-style: none; padding: 0; margin: 0; }
  .doc-nav-container li { position: relative; }
  .doc-nav-container a { display: block; padding: 0.4em 0.5em; text-decoration: none; color: #666666; font-weight: normal; }
  .doc-nav-container li.active > a { color: #000; font-weight: 600; }
  .doc-nav-container ul ul { padding-left: 1em; }

  /* ★ 更新: 通用TOC标题样式 */
  #toc-right-container h3, .toc-middle-container h3 { margin: 0 0 1em; font-size: 1.1em; font-weight: 600; color: #333; }
  .toc-list { margin: 0; padding: 0; list-style: none; }
  .toc-list-item { margin-bottom: 5px; }
  .toc-list .toc-list { padding-left: 1.25em; }
  .toc-link { display: block; padding: 4px 10px; border-left: 2px solid #EEE; color: #777; font-size: 0.875em; line-height: 1.5; transition: all 0.2s ease-in-out; text-decoration: none !important; }
  .toc-link:hover { color: #333; border-left-color: #AAA; }
  .is-active-link { color: #007bff; font-weight: 600; border-left-color: #007bff; background-color: #f0f7ff; }
</style>

{%- comment %}
  ============================================================================
  PART 3: HTML STRUCTURE - (已重构)
  ============================================================================
{%- endcomment %}

{% include site-header.html %}

{%- capture nav_list_html %} ... 左侧导航HTML，无需改动 ... {% endcapture %}

<!-- ★ 更新: main的class现在由 show_right_container 变量控制 -->
<main class="main container container--doc {% if show_right_container %}has-right-toc{% endif %}">
  
  <aside class="doc-nav-container"> ... 左侧导航容器 ... </aside>

  <article class="article article--doc content typeset js-toc-content">
    <h1>{{ page_title_to_display }}</h1>
    
    <!-- ★ 更新: 准备中间TOC容器，预置标题和目标div -->
    {% if show_toc_feature %}
    <div id="toc-middle-container" class="toc-middle-container">
      <h3>Index</h3>
      <div class="js-toc-middle"></div>
    </div>
    {% endif %}

    {{ content }}
  </article>

  <!-- ★ 更新: 仅在需要显示右侧容器时才渲染此aside -->
  {% if show_right_container %}
  <aside class="doc-chapter-toc">
    <!-- ★ 更新: 右侧TOC容器，预置标题和目标div -->
    <div id="toc-right-container">
      <h3>Index</h3>
      <div class="js-toc-right"></div>
    </div>
  </aside>
  {% endif %}

</main>

<!-- MOBILE Navigation Elements -->
... 此部分无需改动 ...

{% include site-footer.html %}

{%- comment %}
  ============================================================================
  PART 4: JAVASCRIPT LOGIC (★ 核心重构部分)
  ============================================================================
{%- endcomment %}

<!-- ★ 更新: 仅在启用了TOC功能时才加载脚本 -->
{% if show_toc_feature %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.27.18/tocbot.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
  const DESKTOP_BREAKPOINT = 1200;
  // ★ 更新: 将 page.aside 的值传递给JS
  const pageHasAside = {{ page.aside | default: false }};

  const middleTocContainer = document.getElementById('toc-middle-container');
  // ★ 更新: 右侧容器可能不存在于DOM中，所以需要安全检查
  const rightTocContainer = document.getElementById('toc-right-container'); 
  const contentArea = document.querySelector('.js-toc-content');

  // 如果连内容区和中间TOC容器都没有，就退出
  if (!contentArea || !middleTocContainer) {
    return;
  }

  function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
      const later = () => { clearTimeout(timeout); func(...args); };
      clearTimeout(timeout);
      timeout = setTimeout(later, wait);
    };
  }
  
  function determineHeadingSelector() {
    if (contentArea.querySelector('h2')) return 'h2, h3';
    if (contentArea.querySelector('h3')) return 'h3, h4';
    if (contentArea.querySelector('h4')) return 'h4, h5';
    return null;
  }

  function setupTocbot() {
    tocbot.destroy();

    const headingSelector = determineHeadingSelector();
    if (!headingSelector) {
      middleTocContainer.style.display = 'none';
      if (rightTocContainer) rightTocContainer.style.display = 'none';
      return;
    }
    
    // ★ 更新: 核心显示逻辑
    const showMiddleToc = (window.innerWidth < DESKTOP_BREAKPOINT) || pageHasAside;

    if (showMiddleToc) {
      // --- 显示中间TOC的逻辑 ---
      if (rightTocContainer) rightTocContainer.style.display = 'none'; // 隐藏右侧
      middleTocContainer.style.display = 'block'; // 显示中间
      
      tocbot.init({
        tocSelector: '.js-toc-middle',
        contentSelector: '.js-toc-content',
        headingSelector: headingSelector,
        hasInnerContainers: true,
        scrollSmooth: true,
        scrollSmoothOffset: -20,
        headingsOffset: 20
      });

    } else if (rightTocContainer) {
      // --- 显示右侧TOC的逻辑 (前提是rightTocContainer存在) ---
      middleTocContainer.style.display = 'none'; // 隐藏中间
      rightTocContainer.style.display = 'block'; // 显示右侧 (CSS媒体查询也会做，但JS确保万无一失)
      
      tocbot.init({
        tocSelector: '.js-toc-right',
        contentSelector: '.js-toc-content',
        headingSelector: headingSelector,
        hasInnerContainers: true,
        scrollSmooth: true,
        scrollSmoothOffset: -80,
        headingsOffset: 80
      });
    } else {
      // 既不显示中间，也没有右侧容器（例如宽屏但有aside的特殊情况），确保中间的也隐藏
      middleTocContainer.style.display = 'none';
    }
  }

  setupTocbot();
  window.addEventListener('resize', debounce(setupTocbot, 150));
});
</script>
{% endif %}


