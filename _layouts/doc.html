---
layout: default
---

{%- comment %}
  ============================================================================
  PART 1: DATA PREPARATION (Jekyll/Liquid)
  ============================================================================
{%- endcomment %}

{%- comment %} --- 右侧章节目录 (Tocbot) 的数据准备 --- {% endcomment %}
{%- assign has_right_toc = false -%}
{%- assign right_toc_html = "" -%}
{%- comment %}
  --- 修正后的逻辑：将复杂的单行if拆分为嵌套if，以消除Liquid警告 ---
{%- endcomment %}
{%- if page.toc == true -%}
  {%- if content contains '<h2' or content contains '<h3' or content contains '<h4' -%}
    {%- capture captured_toc -%}{% include toc.html content=content %}{%- endcapture -%}
    {%- assign toc_trimmed = captured_toc | strip -%}
    {%- if toc_trimmed != "" -%}
      {%- assign has_right_toc = true -%}
      {%- assign right_toc_html = captured_toc -%}
    {%- endif -%}
  {%- endif -%}
{%- endif -%}

{%- comment %} --- 左侧书籍导航的数据准备 (从YAML文件加载) --- {% endcomment %}
{%- assign collection_name = page.collection -%}
{%- assign book_data = site.data.books[collection_name] -%}
{%- assign book_title = book_data.title | default: collection_name | capitalize -%}
{%- assign book_chapters = book_data.chapters -%}

{%- comment %} --- 从YAML数据中查找当前页面的标题 --- {% endcomment %}
{%- assign page_title_from_data = "" -%}
{%- for chapter in book_chapters -%}
  {%- if chapter.url == page.url -%}{%- assign page_title_from_data = chapter.title -%}{% break %}{%- endif -%}
  {%- if chapter.subitems -%}
    {%- for subitem in chapter.subitems -%}
      {%- if subitem.url == page.url -%}{%- assign page_title_from_data = subitem.title -%}{% break %}{%- endif -%}
       {%- if subitem.subitems -%}
        {%- for subsubitem in subitem.subitems -%}
          {%- if subsubitem.url == page.url -%}{%- assign page_title_from_data = subsubitem.title -%}{% break %}{%- endif -%}
        {%- endfor -%}
        {%- if page_title_from_data != "" %}{% break %}{% endif %}
       {%- endif -%}
    {%- endfor -%}
    {%- if page_title_from_data != "" %}{% break %}{% endif %}
  {%- endif -%}
{%- endfor -%}
{%- assign page_title_to_display = page_title_from_data | default: page.title | default: "Untitled" -%}

{%- comment %}
  ============================================================================
  PART 2: INLINE CSS (方案A集成版)
  ============================================================================
{%- endcomment %}
<style>
  /* --- BASE DOC LAYOUT STYLES --- */
  @media screen and (min-width: 1200px) {
    .main.container--doc { position: relative; display: flex; align-items: flex-start; gap: 2.5em; }
    .article--doc { flex: 1 1 auto; min-width: 0; }
  }

  /* --- LEFT BOOK NAVIGATION (DESKTOP) --- */
  .doc-nav-container { display: none; }
  @media screen and (min-width: 1200px) {
    .doc-nav-container {
      display: block;
      flex: 0 0 280px;
      position: sticky; top: 2rem;
      max-height: calc(100vh - 4rem);
      font-size: 18px; /* 保留字号 */
    }
    .doc-nav-scroll-area {
      height: 100%; overflow-y: auto;
      background-color: #f1f3f5; /* 保留背景色 */
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      padding: 1em;
    }
    .doc-nav-container h3 {
      display: none;
    }
    .doc-nav-container ul { list-style: none; padding: 0; margin: 0; }
    .doc-nav-container li { position: relative; }

    /* --- 最终修正的极简样式 --- */
    
    /* (默认状态) #666灰色，不加粗 */
    .doc-nav-container a {
      display: block;
      padding: 0.4em 0.5em;
      text-decoration: none;
      color: #666666;
      font-weight: normal;
    }
    
    /* (悬停状态) 无效果 */
    .doc-nav-container a:hover {
      text-decoration: none;
    }
    
    /* (当前页面状态) 黑色，加粗 */
    .doc-nav-container li.active > a {
      color: #000;
      font-weight: 600;
    }
    
    /* (子目录) 仅保留缩进 */
    .doc-nav-container ul ul {
      padding-left: 1em;
    }
  }

  /* --- MOBILE NAVIGATION (FAB & OFF-CANVAS MENU) --- */
  .doc-nav-fab { position: fixed; bottom: 30px; left: 30px; width: 56px; height: 56px; background-color: #2c3e50; color: white; border-radius: 50%; border: none; display: flex; justify-content: center; align-items: center; box-shadow: 0 4px 12px rgba(0,0,0,0.2); cursor: pointer; z-index: 1001; transition: transform 0.2s ease-in-out; }
  .doc-nav-fab:hover { transform: scale(1.05); }
  .doc-nav-fab .icon { width: 24px; height: 24px; fill: currentColor; }
  .doc-nav-mobile-menu { position: fixed; top: 0; left: 0; width: 80%; max-width: 320px; height: 100%; background-color: white; z-index: 1002; transform: translateX(-100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); box-shadow: 0 0 20px rgba(0,0,0,0.2); overflow-y: auto; }
  .doc-nav-mobile-menu.is-open { transform: translateX(0); }
  .doc-nav-mobile-menu .doc-nav-scroll-area { padding-top: 2em; }
  .doc-nav-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 1000; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s; }
  .doc-nav-overlay.is-visible { opacity: 1; visibility: visible; }
  @media screen and (min-width: 1200px) { .doc-nav-fab, .doc-nav-mobile-menu, .doc-nav-overlay { display: none; } }

  /* --- RIGHT TOCBOT STYLES --- */
  .doc-chapter-toc { display: none; }
  @media screen and (min-width: 1200px) { .main.container--doc.has-right-toc .doc-chapter-toc { display: block; flex: 0 0 260px; position: sticky; top: 2rem; max-height: calc(100vh - 4rem); overflow-y: auto; } }
  .doc-chapter-toc h3 { margin: 0 0 1em; font-size: 1.1em; font-weight: 600; color: #333; }
  .toc-list { margin: 0; padding: 0; list-style: none; }
  .toc-link { display: block; padding: 4px 10px; border-left: 2px solid #EEE; color: #777; text-decoration: none; font-size: 0.875em; line-height: 1.5; transition: all 0.2s ease-in-out; }
  .is-active-link { color: #007bff; font-weight: 600; border-left-color: #007bff; background-color: #f0f7ff; }
  .toc-mobile-container { display: block; margin: 2em 0; padding: 1em; border: 1px solid #eee; border-radius: 4px; background-color: #f9f9f9; }
  .toc-mobile-container h3 { margin-top: 0; }
  @media screen and (min-width: 1200px) { .toc-mobile-container { display: none; } }

  /* --- ULTRA-WIDE SCREEN ENHANCEMENTS (方案 A) --- */
  @media screen and (min-width: 1600px) {
    .doc-nav-container { flex-basis: 320px; }
    .main.container--doc { max-width: 1400px; margin-left: auto; margin-right: auto; }
  }
</style>

{%- comment %}
  ============================================================================
  PART 3: HTML STRUCTURE
  ============================================================================
{%- endcomment %}

{% include site-header.html %}

{%- comment %}
  --- 生成多级导航列表HTML (已修正，移除parent-active) ---
  使用 `capture` 生成一次，然后在桌面和移动视图中重复使用。
{%- endcomment %}
{%- capture nav_list_html %}
<ul>
  {%- for item_l1 in book_chapters %}
    <li class="{% if page.url == item_l1.url %}active{% endif %}">
      <a href="{{ item_l1.url | relative_url }}">{{ item_l1.title }}</a>
      
      {%- if item_l1.subitems %}
      <ul>
        {%- for item_l2 in item_l1.subitems %}
          <li class="{% if page.url == item_l2.url %}active{% endif %}">
            <a href="{{ item_l2.url | relative_url }}">{{ item_l2.title }}</a>
            
            {%- if item_l2.subitems %}
            <ul>
              {%- for item_l3 in item_l2.subitems %}
                <li class="{% if page.url == item_l3.url %}active{% endif %}">
                  <a href="{{ item_l3.url | relative_url }}">{{ item_l3.title }}</a>
                </li>
              {%- endfor %}
            </ul>
            {%- endif %}
          </li>
        {%- endfor %}
      </ul>
      {%- endif %}
    </li>
  {%- endfor %}
</ul>
{%- endcapture %}

<!-- 主体内容 -->
<main class="main container container--doc {% if has_right_toc %}has-right-toc{% endif %}">
  
  <aside class="doc-nav-container">
    <div class="doc-nav-scroll-area">
      <h3>{{ book_title }}</h3>
      {{ nav_list_html }}
    </div>
  </aside>

  <article class="article article--doc content typeset js-toc-content">
    <h1>{{ page_title_to_display }}</h1>
    {% if has_right_toc %}<div id="mobile-toc-anchor"></div>{% endif %}
    {{ content }}
  </article>

  {% if has_right_toc %}
  <aside class="doc-chapter-toc">
    <h3>本章目录</h3>
    <div class="js-toc">{{ right_toc_html }}</div>
  </aside>
  {% endif %}

</main>

<!-- MOBILE Navigation Elements -->
<div class="doc-nav-mobile-container">
  <div id="doc-nav-overlay" class="doc-nav-overlay"></div>
  <nav id="doc-nav-mobile-menu" class="doc-nav-mobile-menu">
    <div class="doc-nav-scroll-area">
      <h3>{{ book_title }}</h3>
      {{ nav_list_html }}
    </div>
  </nav>
  <button id="doc-nav-fab" class="doc-nav-fab" aria-label="打开目录">
    <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg>
  </button>
</div>

{% include site-footer.html %}

{%- comment %}
  ============================================================================
  PART 4: JAVASCRIPT LOGIC
  ============================================================================
{%- endcomment %}

<!-- Tocbot JS (条件性加载) -->
{% if has_right_toc %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.27.18/tocbot.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
  const desktopBreakpoint = 1200;
  if (window.innerWidth >= desktopBreakpoint && document.querySelector('.js-toc')) {
    
    // --- 修正后的PC端初始化代码 ---
    // 这个配置让Tocbot使用.js-toc中由Jekyll生成的静态HTML，而不是自己扫描内容生成目录
    tocbot.init({
      // Where to render the table of contents.
      tocSelector: '.js-toc',
      // The following two options are removed to use existing HTML
      // contentSelector: '.js-toc-content', 不需要，用toc.html生成的文内目录
      // headingSelector: 'h2, h3, h4', 不需要，用toc.html生成的文内目录
      
      // For more decorative styles.
      hasInnerContainers: true,
      // Smooth scrolling enabled
      scrollSmooth: true,
      // Offset for sticky headers (if you have one)
      scrollSmoothOffset: -80,
    });

  } else {
    // 移动端逻辑保持不变，它本来就是正确的
    const mobileAnchor = document.getElementById('mobile-toc-anchor');
    const rawTocHtml = document.querySelector('.js-toc')?.innerHTML;
    if (mobileAnchor && rawTocHtml) {
      const mobileWrapper = document.createElement('div');
      mobileWrapper.className = 'toc-mobile-container';
      mobileWrapper.innerHTML = `<h3>本章目录</h3><div class="toc-content-wrapper">${rawTocHtml}</div>`;
      mobileAnchor.parentNode.insertBefore(mobileWrapper, mobileAnchor.nextSibling);
      mobileAnchor.parentNode.removeChild(mobileAnchor);
    }
  }
});
</script>
{% endif %}

<!-- Mobile Navigation FAB & Menu JS -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const fab = document.getElementById('doc-nav-fab');
    const menu = document.getElementById('doc-nav-mobile-menu');
    const overlay = document.getElementById('doc-nav-overlay');
    if (!fab || !menu || !overlay) return;
    function openMenu() { menu.classList.add('is-open'); overlay.classList.add('is-visible'); document.body.style.overflow = 'hidden'; }
    function closeMenu() { menu.classList.remove('is-open'); overlay.classList.remove('is-visible'); document.body.style.overflow = ''; }
    fab.addEventListener('click', openMenu);
    overlay.addEventListener('click', closeMenu);
    menu.addEventListener('click', function(event) { if (event.target.closest('a')) { closeMenu(); } });
    document.addEventListener('keydown', function(event) { if (event.key === 'Escape' && menu.classList.contains('is-open')) { closeMenu(); } });
});
</script>

<!-- 
  ==========================================================================
  PART 5: DYNAMIC IMAGE PATH CORRECTION SCRIPT (v4 - Universal Rewrite)
  ==========================================================================
  - This script rewrites all relative image paths starting with './'
    to an absolute path based on the collection.
  - It handles any subdirectory structure within your Markdown files.
-->
<script>
document.addEventListener('DOMContentLoaded', function() {
  const collectionName = '{{ page.collection }}';
  if (!collectionName) { return; }

  // Define the base path where all book assets are stored.
  const assetBasePath = `/uploads/${collectionName}/`;

  const contentArea = document.querySelector('.article--doc');
  if (!contentArea) { return; }
  
  const images = contentArea.querySelectorAll('img');

  images.forEach(img => {
    const originalSrc = img.getAttribute('src');

    // We only process paths that start with './'
    if (originalSrc && originalSrc.startsWith('./')) {
      
      // Remove the leading './' to get the pure relative path
      const relativePath = originalSrc.substring(2);
      
      // Construct the new, absolute path
      const newSrc = assetBasePath + relativePath;
      
      img.setAttribute('src', newSrc);
      
      console.log(`Universal Image Rewrite: ${originalSrc} -> ${newSrc}`);
    }
  });
});
</script>