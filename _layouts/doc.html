---
layout: default
---

{%- comment %} --- Data Preparation --- {% endcomment %}
{%- assign collection_name = page.collection -%}
{%- assign doc_data = site.data.docs[collection_name] -%}
{%- assign doc_title = doc_data.title | default: collection_name | capitalize -%}
{%- assign doc_chapters = doc_data.chapters -%}
{%- assign page_title_from_data = "" -%}
{%- for chapter in doc_chapters -%}{%- if chapter.url == page.url -%}{%- assign page_title_from_data = chapter.title -%}{% break %}{%- endif -%}{%- if chapter.subitems -%}{%- for subitem in chapter.subitems -%}{%- if subitem.url == page.url -%}{%- assign page_title_from_data = subitem.title -%}{% break %}{%- endif -%}{%- if subitem.subitems -%}{%- for subsubitem in subitem.subitems -%}{%- if subsubitem.url == page.url -%}{%- assign page_title_from_data = subsubitem.title -%}{% break %}{%- endif -%}{%- if subsubitem.subitems -%}{%- for subsubsubitem in subsubitem.subitems -%}{%- if subsubsubitem.url == page.url -%}{%- assign page_title_from_data = subsubsubitem.title -%}{% break %}{%- endif -%}{%- endfor -%}{%- if page_title_from_data != "" %}{% break %}{% endif %}{%- endif -%}{%- endfor -%}{%- if page_title_from_data != "" %}{% break %}{% endif %}{%- endif -%}{%- endfor -%}{%- if page_title_from_data != "" %}{% break %}{% endif %}{%- endif -%}{%- endfor -%}
{%- assign page_title_to_display = page_title_from_data | default: page.title | default: "Untitled" -%}

<style>
/* --- Base layout styles for DOC --- */
.main.container--doc {
  display: flex;
  gap: 2em;
  max-width: 960px;
  margin: 0 auto;
  align-items: flex-start;
}
.article--doc {
  flex: 1 1 auto;
  min-width: 0;
}

/* --- New Doc Navigation Styles --- */
:root {
  --doc-nav-width-md: 260px;
  --doc-nav-width-lg: 280px;
  --doc-nav-width-xl: 300px;
  --doc-nav-indent: 0.6em;
  --doc-nav-transition: transform 0.3s ease, opacity 0.3s ease;
}

/* --- Mobile FAB --- */
.doc-nav-fab {
  display: flex; /* Initially visible on mobile */
  justify-content: center;
  align-items: center;
  position: fixed;
  bottom: 25px;
  left: 25px;
  width: 50px;
  height: 50px;
  background-color: #2c3e50;
  color: white;
  border-radius: 50%;
  border: none;
  box-shadow: 0 4px 12px rgba(0,0,0,0.2);
  cursor: pointer;
  z-index: 1001;
  transition: transform 0.2s ease;
}
.doc-nav-fab:hover {
  transform: scale(1.05);
}
.doc-nav-fab svg {
  width: 24px;
  height: 24px;
}

/* --- Mobile Overlay --- */
.doc-nav-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.5);
  z-index: 1002;
  opacity: 0;
  visibility: hidden;
  transition: var(--doc-nav-transition);
}

/* --- Navigation Container (Mobile Drawer Style by Default) --- */
.doc-nav-container {
  position: fixed;
  top: 0;
  left: 0;
  width: 85%;
  max-width: 320px;
  height: 100vh; /* Fallback */
  height: 100dvh; /* Better for mobile browsers with dynamic toolbars */
  background-color: #fff;
  z-index: 1003;
  display: flex;
  flex-direction: column;
  transform: translateX(-100%);
  transition: var(--doc-nav-transition);
  box-shadow: 0 0 20px rgba(0,0,0,0.1);
}

/* --- Open State for Mobile --- */
body.doc-nav-is-open {
  overflow: hidden; /* Lock background scroll */
}
body.doc-nav-is-open .doc-nav-overlay {
  opacity: 1;
  visibility: visible;
}
body.doc-nav-is-open .doc-nav-container {
  transform: translateX(0);
}

/* --- Nav Header --- */
.doc-nav-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 1rem 1.2rem;
  border-bottom: 1px solid #e0e0e0;
  flex-shrink: 0;
}
.doc-nav-header h3 {
  margin: 0;
  font-size: 1.1em;
  font-weight: 600;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.doc-nav-close-btn {
  background: none;
  border: none;
  cursor: pointer;
  padding: 0.5rem;
  margin: -0.5rem; /* Enlarge tap area */
  color: #555;
}
.doc-nav-close-btn:hover { color: #000; }
.doc-nav-close-btn svg { width: 20px; height: 20px; }


/* --- Nav Scrollable Area & List --- */
.doc-nav-scroll-area {
  flex-grow: 1;
  overflow-y: auto;
  -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
  overscroll-behavior-y: contain; /* Prevent scrolling parent */
  padding: 1rem 0;
}

.doc-nav-list {
  list-style: none;
  padding: 0;
  margin: 0;
}
.doc-nav-list .doc-nav-list {
  padding-left: var(--doc-nav-indent);
  max-height: 0;
  overflow: hidden;
  transition: max-height 0.3s ease-in-out;
}

/* --- Nav Item & Link --- */
.doc-nav-item {
  display: flex;
  flex-wrap: wrap;
  align-items: center;
  padding-right: 0.5rem; /* Space for toggle button */
}

.doc-nav-link {
  display: block;
  font-size: 0.9em;
  color: #333;
  text-decoration: none;
  padding: 0.5em 1.2em;
  flex-grow: 1;
  transition: background-color 0.2s ease, color 0.2s ease;
  border-radius: 4px;
  margin: 1px 0;
}
.doc-nav-item > a:hover {
  background-color: #f0f0f0;
  color: #000;
}
.doc-nav-item.is-active > .doc-nav-link {
  background-color: #e7f5ff;
  color: #007bff;
  font-weight: 600;
}

/* --- Toggle Button --- */
.doc-nav-toggle-btn {
  background: transparent;
  border: none;
  cursor: pointer;
  padding: 0.5em; /* Larger clickable area */
  margin-left: auto;
  flex-shrink: 0;
  border-radius: 4px;
  line-height: 1;
  color: #777;
}
.doc-nav-toggle-btn:hover { background-color: #e0e0e0; }
.doc-nav-toggle-btn svg {
  width: 14px;
  height: 14px;
  transition: transform 0.2s ease;
}
/* Icon points right by default */
.doc-nav-item.has-children.is-expanded > .doc-nav-toggle-btn svg {
  transform: rotate(90deg); /* Icon points down when expanded */
}

/* --- Expand/Collapse Logic --- */
.doc-nav-item.has-children.is-expanded > .doc-nav-list {
  max-height: 1000px; /* A large enough value to show content */
}

/* --- Indentation per level --- */
.doc-nav-item--l2 > .doc-nav-link { padding-left: calc(1.2em + var(--doc-nav-indent)); }
.doc-nav-item--l3 > .doc-nav-link { padding-left: calc(1.2em + var(--doc-nav-indent) * 2); }
.doc-nav-item--l4 > .doc-nav-link { padding-left: calc(1.2em + var(--doc-nav-indent) * 3); }


/* --- Desktop Layout (min-width: 768px) --- */
@media screen and (min-width: 768px) {
  .doc-nav-fab, .doc-nav-overlay, .doc-nav-close-btn { display: none; }
  body.doc-nav-is-open { overflow: auto; } /* Re-enable scroll */

  .doc-nav-container {
    display: flex;
    flex: 0 0 var(--doc-nav-width-md);
    position: sticky;
    top: 2rem;
    max-height: calc(100vh - 4rem); /* Prevent covering footer */
    transform: none;
    box-shadow: none;
    border-right: 1px solid #e0e0e0;
    transition: none;
    width: auto;
    background-color: transparent;
  }
  .doc-nav-header { padding: 0 0 1rem 0; border-bottom: none; }
  .doc-nav-header h3 { font-size: 1.3em; }
  .doc-nav-scroll-area { padding: 0; }
  .doc-nav-link { padding: 0.5em 0.75em; }
  .doc-nav-item--l2 > .doc-nav-link { padding-left: calc(0.75em + var(--doc-nav-indent)); }
  .doc-nav-item--l3 > .doc-nav-link { padding-left: calc(0.75em + var(--doc-nav-indent) * 2); }
  .doc-nav-item--l4 > .doc-nav-link { padding-left: calc(0.75em + var(--doc-nav-indent) * 3); }
}

/* 3-column */
@media screen and (min-width: 1200px) {
  .main.container--doc { max-width: 1440px; gap: 2.5em; justify-content: center; }
  .doc-nav-container { flex-basis: var(--doc-nav-width-lg); }
  .article--doc { flex-grow: 1; flex-basis: auto; max-width: 800px; }
  .main.container--doc .content-toc-right-wrapper { display: block; flex: 0 0 260px; position: sticky; top: 2rem; max-height: calc(100vh - 4rem); overflow-y: auto; }
}

/* Ultra-wide */
@media screen and (min-width: 1800px) {
  .main.container--doc { max-width: 2200px; width: 90%; justify-content: space-between; }
  .doc-nav-container { flex: 0 0 var(--doc-nav-width-xl); }
  .article--doc { flex: 0 0 800px; }
  .main.container--doc .content-toc-right-wrapper { flex: 0 0 280px; }
}
</style>

{% include site-header.html %}

<main class="main container container--doc {% if page.toc %}has-right-toc{% endif %}">

  <aside class="doc-nav-container" id="doc-nav-container">
    <div class="doc-nav-header">
      <h3>{{ doc_title }}</h3>
      <button class="doc-nav-close-btn" aria-label="Close Navigation">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
      </button>
    </div>
    <div class="doc-nav-scroll-area" id="doc-nav-scroll-area">
      <ul class="doc-nav-list">
        {% for item_l1 in doc_chapters %}
          <li class="doc-nav-item doc-nav-item--l1 {% if item_l1.subitems %}has-children{% endif %} {% if page.url == item_l1.url %}is-active{% endif %} {% if item_l1.subitems %}is-expanded{% endif %}" data-path="{{ item_l1.url | relative_url }}">
            <a href="{{ item_l1.url | relative_url }}#doc-content-anchor" class="doc-nav-link">{{ item_l1.title }}</a>
            {% if item_l1.subitems %}
              <button class="doc-nav-toggle-btn" aria-label="Toggle Submenu">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"></path></svg>
              </button>
              <ul class="doc-nav-list">
                {% for item_l2 in item_l1.subitems %}
                  <li class="doc-nav-item doc-nav-item--l2 {% if item_l2.subitems %}has-children{% endif %} {% if page.url == item_l2.url %}is-active{% endif %} {% if item_l2.subitems %}is-expanded{% endif %}" data-path="{{ item_l2.url | relative_url }}">
                    <a href="{{ item_l2.url | relative_url }}#doc-content-anchor" class="doc-nav-link">{{ item_l2.title }}</a>
                    {% if item_l2.subitems %}
                      <button class="doc-nav-toggle-btn" aria-label="Toggle Submenu">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"></path></svg>
                      </button>
                      <ul class="doc-nav-list">
                        {% for item_l3 in item_l2.subitems %}
                          <li class="doc-nav-item doc-nav-item--l3 {% if item_l3.subitems %}has-children{% endif %} {% if page.url == item_l3.url %}is-active{% endif %}" data-path="{{ item_l3.url | relative_url }}">
                            <a href="{{ item_l3.url | relative_url }}#doc-content-anchor" class="doc-nav-link">{{ item_l3.title }}</a>
                            {% if item_l3.subitems %}
                              <button class="doc-nav-toggle-btn" aria-label="Toggle Submenu">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"></path></svg>
                              </button>
                              <ul class="doc-nav-list">
                                {% for item_l4 in item_l3.subitems %}
                                  <li class="doc-nav-item doc-nav-item--l4 {% if page.url == item_l4.url %}is-active{% endif %}" data-path="{{ item_l4.url | relative_url }}">
                                    <a href="{{ item_l4.url | relative_url }}#doc-content-anchor" class="doc-nav-link">{{ item_l4.title }}</a>
                                  </li>
                                {% endfor %}
                              </ul>
                            {% endif %}
                          </li>
                        {% endfor %}
                      </ul>
                    {% endif %}
                  </li>
                {% endfor %}
              </ul>
            {% endif %}
          </li>
        {% endfor %}
      </ul>
    </div>
  </aside>

  <article id="doc-content-anchor" class="article article--doc content typeset js-toc-content">
    <h1>{{ page_title_to_display }}</h1>
    
    {% if page.toc %}
    <div id="toc-middle-container" class="toc-middle-container">
      <h3 class="toc-title">Index</h3>
      <div class="js-toc-middle"></div>
    </div>
    {% endif %}

    <div class="content-body">
      {{ content }}
    </div>
  </article>

  {% if page.toc %}
  <aside class="content-toc-right-wrapper">
    <div id="toc-right-container">
      <h3 class="toc-title">Index</h3>
      <div class="js-toc-right"></div>
    </div>
  </aside>
  {% endif %}

</main>

<!-- Mobile Navigation Elements -->
<div class="doc-nav-overlay"></div>
<button class="doc-nav-fab" aria-label="Open Navigation">
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"></path></svg>
</button>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // --- Image Path Fixer ---
  const collectionName = '{{ page.collection }}';
  if (collectionName) {
    const assetBasePath = `/uploads/${collectionName}/`;
    const contentArea = document.querySelector('.article--doc');
    if (contentArea) {
      const images = contentArea.querySelectorAll('img');
      images.forEach(img => {
        const originalSrc = img.getAttribute('src');
        if (originalSrc && originalSrc.startsWith('./')) {
          const newSrc = assetBasePath + originalSrc.substring(2);
          img.setAttribute('src', newSrc);
        }
      });
    }
  }

  // --- Doc Navigation Logic ---
  const docNavModule = function() {
    const navContainer = document.getElementById('doc-nav-container');
    if (!navContainer) return;

    const fab = document.querySelector('.doc-nav-fab');
    const overlay = document.querySelector('.doc-nav-overlay');
    const closeBtn = document.querySelector('.doc-nav-close-btn');
    const scrollArea = document.getElementById('doc-nav-scroll-area');
    const storageKey = `docNavState_{{ page.collection }}`;

    // Debounce utility
    const debounce = (func, wait) => {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    };

    const openNav = () => document.body.classList.add('doc-nav-is-open');
    const closeNav = () => document.body.classList.remove('doc-nav-is-open');

    const saveState = () => {
      const expandedItems = [];
      navContainer.querySelectorAll('.doc-nav-item.is-expanded').forEach(item => {
        expandedItems.push(item.dataset.path);
      });
      const state = {
        scrollPos: scrollArea.scrollTop,
        expanded: expandedItems,
      };
      sessionStorage.setItem(storageKey, JSON.stringify(state));
    };

    const debouncedSaveState = debounce(saveState, 150);

    const restoreState = () => {
      const stateString = sessionStorage.getItem(storageKey);
      if (!stateString) return;
      
      try {
        const state = JSON.parse(stateString);
        
        // First, collapse all expandable items that are expanded by default
        navContainer.querySelectorAll('.doc-nav-item.has-children').forEach(item => {
          item.classList.remove('is-expanded');
        });

        // Then, expand items from saved state
        if (state.expanded && state.expanded.length > 0) {
          state.expanded.forEach(path => {
            const item = navContainer.querySelector(`.doc-nav-item[data-path="${path}"]`);
            if (item) item.classList.add('is-expanded');
          });
        }
        
        // Restore scroll position
        if (state.scrollPos) {
          scrollArea.scrollTop = state.scrollPos;
        }

      } catch (e) {
        console.error("Failed to parse doc nav state:", e);
        sessionStorage.removeItem(storageKey);
      }
    };

    const handleToggle = (event) => {
      const target = event.target.closest('.doc-nav-toggle-btn');
      if (!target) return;
      
      const parentItem = target.closest('.doc-nav-item');
      if (parentItem) {
        parentItem.classList.toggle('is-expanded');
        saveState(); // Save state immediately on toggle
      }
    };

    // --- Initialize ---
    fab.addEventListener('click', openNav);
    overlay.addEventListener('click', closeNav);
    closeBtn.addEventListener('click', closeNav);
    navContainer.addEventListener('click', handleToggle);
    scrollArea.addEventListener('scroll', debouncedSaveState);
    window.addEventListener('beforeunload', saveState);

    restoreState();
  };

  docNavModule();
});
</script>


{% include tts-reader.html %}
{% include content-toc.html %}

{% include site-footer.html %}