---
layout: default
---

<!-- ... 所有的 Liquid, HTML, 和 CSS 内容保持完全不变 ... -->

<style>
  /* ... 所有样式保持不变 ... */
</style>

{% include site-header.html %}
<div class.doc-nav-overlay></div>
<button class="doc-nav-fab" aria-label="Open documentation navigation">
  <!-- ... SVG ... -->
</button>

<main class="main container container--doc layout-doc {% if show_toc %}has-right-toc{% endif %}">
  <!-- ... main 标签内的所有内容保持不变 ... -->
</main>

<!-- JavaScripts section with Double Insurance Logic -->
<script>
// Define the controller object in a scope accessible to multiple event listeners.
const DocNavController = {
  SCROLL_STORAGE_KEY: 'docNavScrollPos',
  EXPAND_STORAGE_KEY: 'docNavExpandedItems',
  
  // We will initialize these DOM elements later
  body: null,
  fab: null,
  overlay: null,
  navContainer: null,
  closeButton: null,
  scrollArea: null,

  // The main init function now only assigns DOM elements
  init: function() {
    this.body = document.body;
    this.fab = document.querySelector('.doc-nav-fab');
    this.overlay = document.querySelector('.doc-nav-overlay');
    this.navContainer = document.querySelector('.doc-nav-container');
    this.closeButton = document.querySelector('.doc-nav-close');
    this.scrollArea = document.querySelector('.doc-nav-scroll-area');

    if (!this.navContainer) return false;
    
    // Initial setup that can run early
    this.setupMobileHeight();
    this.bindEvents();
    return true;
  },

  // This function is now standalone, so it can be called multiple times
  applyStoredState: function() {
    if (!this.scrollArea) return; // Guard clause

    // Restore expanded/collapsed state (this is safe to run early)
    const expandedItems = JSON.parse(sessionStorage.getItem(this.EXPAND_STORAGE_KEY));
    if (expandedItems) {
      document.querySelectorAll('.doc-nav-item[data-url]').forEach(item => {
        item.classList.toggle('is-expanded', expandedItems.includes(item.dataset.url));
      });
    } else {
      document.querySelectorAll('.doc-nav-item--l1[data-url]').forEach(item => {
        item.classList.add('is-expanded');
      });
    }
    
    // Restore scroll position (this is the critical part)
    const scrollPos = sessionStorage.getItem(this.SCROLL_STORAGE_KEY);
    if (scrollPos) {
      this.scrollArea.scrollTop = parseInt(scrollPos, 10);
    }
  },

  saveState: function() {
    if (!this.scrollArea) return;
    sessionStorage.setItem(this.SCROLL_STORAGE_KEY, this.scrollArea.scrollTop);
    const expandedUrls = [];
    document.querySelectorAll('.doc-nav-item.is-expanded[data-url]').forEach(item => {
      expandedUrls.push(item.dataset.url);
    });
    sessionStorage.setItem(this.EXPAND_STORAGE_KEY, JSON.stringify(expandedUrls));
  },

  bindEvents: function() {
    if (this.fab) this.fab.addEventListener('click', this.openNav.bind(this));
    if (this.overlay) this.overlay.addEventListener('click', this.closeNav.bind(this));
    if (this.closeButton) this.closeButton.addEventListener('click', this.closeNav.bind(this));

    this.navContainer.addEventListener('click', e => {
      const toggle = e.target.closest('.doc-nav-toggle-wrapper');
      if (toggle) {
        toggle.closest('.doc-nav-item').classList.toggle('is-expanded');
        this.saveState();
      }
      
      const link = e.target.closest('.doc-nav-link');
      if (link) {
        const parentItem = link.closest('.doc-nav-item');
        if (parentItem && parentItem.querySelector('.doc-nav-list') && !parentItem.classList.contains('is-expanded')) {
          parentItem.classList.add('is-expanded');
        }
        this.saveState();
      }
    });

    window.addEventListener('resize', this.debounce(this.setupMobileHeight.bind(this), 150));
  },

  openNav: function() { this.body.classList.add('doc-nav-open'); },
  closeNav: function() { this.body.classList.remove('doc-nav-open'); },
  
  setupMobileHeight: function() {
    const vh = window.innerHeight * 0.01;
    document.documentElement.style.setProperty('--vh', `${vh}px`);
    document.documentElement.style.setProperty('--doc-nav-dynamic-height', `${window.innerHeight}px`);
  },

  debounce: function(func, delay) {
    let timeout;
    return function(...args) {
      const later = () => { clearTimeout(timeout); func.apply(this, args); };
      clearTimeout(timeout);
      timeout = setTimeout(later, delay);
    };
  }
};


/***********************************************************************
 * --- DOUBLE INSURANCE IMPLEMENTATION ---
 ***********************************************************************/

// Initialize the controller and bind events as soon as the DOM is ready.
const isControllerInitialized = DocNavController.init();

if (isControllerInitialized) {
  // --- ATTEMPT 1: The Fast Attempt ---
  // On DOMContentLoaded, we try to restore state immediately.
  // Using setTimeout queues this task to run after the browser's current painting cycle,
  // giving it a better chance of success on a fast connection.
  document.addEventListener('DOMContentLoaded', () => {
    setTimeout(() => {
      console.log('Attempt 1: Restoring state on DOMContentLoaded (quick attempt)');
      DocNavController.applyStoredState();
    }, 0);
  });

  // --- ATTEMPT 2: The Guaranteed Correction ---
  // On 'load', we run the state restoration again. This happens after all
  // assets like CSS and images are loaded, guaranteeing the layout is stable.
  // This will correct any misplacement from the first attempt.
  window.addEventListener('load', () => {
    console.log('Attempt 2: Restoring state on load (guaranteed correction)');
    DocNavController.applyStoredState();
  });
}
</script>

<script>/* Image path script (unchanged) */ document.addEventListener('DOMContentLoaded',function(){const e="{{ page.collection }}";if(!e)return;const t=`/uploads/${e}/`,o=document.querySelector(".article--doc");if(!o)return;o.querySelectorAll("img").forEach(e=>{const o=e.getAttribute("src");if(o&&o.startsWith("./")){const s=o.substring(2),n=t+s;e.setAttribute("src",n)}})});</script>

{% include tts-reader.html %}
{% include content-toc.html %}
{% include site-footer.html %}