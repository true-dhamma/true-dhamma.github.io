---
layout: default
---
<!-- _layouts/video.html -->

{% include site-header.html %}

<!-- 基础配置 -->
{% assign video_base_url = "https://download.true-dhamma.com/%E8%99%9A%E6%8B%9F%E6%BC%94%E6%92%AD%E5%AE%A4/%E8%A7%86%E9%A2%91/" %}
{% assign cover_base_url = "https://download.true-dhamma.com/%E8%99%9A%E6%8B%9F%E6%BC%94%E6%92%AD%E5%AE%A4/%E8%A7%86%E9%A2%91/cover/" %}
{% assign fallback_cover = cover_base_url | append: "general.jpg" %}

<link rel="stylesheet" href="https://cdn.plyr.io/3.7.8/plyr.css" />

<style>
/* --- 1. 全局布局修正 --- */

/* 强制覆盖侧边栏透明度 */
.aside--video-nav {
  opacity: 1 !important; 
}

/* PC端侧边栏固定 */
@media screen and (min-width: 40em) {
  .aside--video-nav .section {
    position: sticky;
    top: 2rem;
    max-height: 80vh;
    overflow-y: auto;
  }
}

/* --- 2. 导航样式 (完全复刻 Categories 缩进与布局) --- */

.video-nav-item {
  margin-bottom: 0.5rem;
}

/* 导航头部 (父级) */
.video-nav-header {
  cursor: pointer;
  display: flex;
  justify-content: flex-start; /* 左对齐 */
  align-items: center;
  color: #3A77D8; /* 网站主色 */
  font-weight: normal;
  padding: 0.2rem 0;
  transition: color 0.1s;
  user-select: none;
  gap: 0.5rem; /* 箭头和文字的间距 */
}

.video-nav-header:hover {
  color: #2e60ad;
}

.video-nav-header.active {
  color: #2e60ad;
  font-weight: 700;
}

/* 箭头小图标 (移到左侧) */
.nav-arrow {
  font-size: 0.7em;
  transition: transform 0.2s;
  color: #a8adac;
  width: 1em; /* 固定宽度确保文字对齐 */
  text-align: center;
}
.video-nav-header.open .nav-arrow {
  transform: rotate(90deg); /* 向下旋转 */
}

/* 子菜单列表 - 缩进对齐 */
.video-nav-sublist {
  padding-left: 1.5rem; /* 与上级文字对齐 */
  margin-top: 0.2rem;
  margin-bottom: 0.5rem;
  display: none; 
}

/* 子菜单项 */
.video-nav-subitem {
  cursor: pointer;
  display: block;
  padding: 0.2rem 0;
  color: #3A77D8; 
  font-size: 0.95rem;
  transition: color 0.1s;
}

.video-nav-subitem:hover {
  color: #2e60ad;
  text-decoration: underline;
}

.video-nav-subitem.active {
  color: #2e60ad;
  font-weight: 700;
}


/* --- 3. 视频卡片 (链接风格 H6) --- */

.video-category-section { display: none; }
.video-category-section.active { display: block; animation: fadeIn 0.3s ease-out; }

.video-grid {
  display: grid;
  grid-template-columns: 1fr;
  gap: 2rem;
  margin-top: 1.5rem;
}
@media screen and (min-width: 40em) {
  .video-grid { grid-template-columns: repeat(2, 1fr); }
}

.video-card {
  cursor: pointer;
  background: transparent;
  transition: transform 0.1s;
}

/* 缩略图容器：恢复圆角 8px */
.video-thumbnail-wrapper {
  position: relative;
  aspect-ratio: 16/9;
  background: #000;
  overflow: hidden;
  margin-bottom: 0.8rem;
  border-radius: 8px; /* 恢复圆角 */
  box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}

.video-thumbnail {
  width: 100%;
  height: 100%;
  object-fit: cover;
  transition: opacity 0.1s;
}
.video-card:hover .video-thumbnail {
  opacity: 0.85;
}

/* 假播放按钮：恢复原有样式 (非直角) */
.play-icon-overlay {
  position: absolute;
  top: 50%; left: 50%;
  transform: translate(-50%, -50%);
  width: 50px; height: 50px; /* 圆形 */
  background: rgba(0, 0, 0, 0.6);
  border-radius: 50%; /* 圆形 */
  border: 2px solid #fff;
  display: flex;
  align-items: center;
  justify-content: center;
  pointer-events: none;
  opacity: 0.9;
  transition: background 0.2s, transform 0.2s;
}
/* 鼠标悬停 */
.video-card:hover .play-icon-overlay {
  background: rgba(200, 0, 0, 0.8); /* 类似 YouTube 红 */
  border-color: rgba(200, 0, 0, 0.8);
  transform: translate(-50%, -50%) scale(1.1);
}
.play-icon-overlay::after {
  content: '';
  display: block;
  border-top: 8px solid transparent;
  border-bottom: 8px solid transparent;
  border-left: 14px solid #fff;
  margin-left: 4px;
}

/* 视频标题 H6 - 蓝色链接风格 */
.video-card-title {
  margin: 0;
  line-height: 1.4;
  color: #3A77D8; /* 默认蓝色 */
  font-weight: 700;
  transition: color 0.1s;
}
.video-card:hover .video-card-title {
  color: #2e60ad; /* Hover 深蓝 */
  text-decoration: underline;
  text-underline-offset: 4px;
}

/* --- 4. 弹窗播放器 (完全复刻 _includes/video.html 样式) --- */
.video-modal-overlay {
  position: fixed;
  top: 0; left: 0; width: 100%; height: 100%;
  background: rgba(0, 0, 0, 0.85);
  z-index: 9999;
  display: flex;
  align-items: center;
  justify-content: center;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.2s ease;
}
.video-modal-overlay.open {
  opacity: 1;
  pointer-events: auto;
}
.video-modal-content {
  width: 94%;
  max-width: 1000px;
  background: #000; /* 播放器背景通常黑 */
  border-radius: 8px; /* 圆角 */
  overflow: hidden;
  box-shadow: 0 10px 30px rgba(0,0,0,0.5);
  display: flex;
  flex-direction: column;
}

/* Plyr Wrapper: 恢复圆角 */
.video-player-wrapper {
  position: relative;
  width: 100%;
  aspect-ratio: 16/9;
  background: #000;
  border-radius: 8px 8px 0 0; 
  overflow: hidden;
}

/* 关键：强制 Plyr 控件在封面之上 */
.plyr__controls {
  z-index: 10 !important; 
}

.video-modal-info {
  padding: 1.2rem;
  background: #fff;
  display: flex;
  justify-content: space-between;
  align-items: center;
  border-radius: 0 0 8px 8px;
}
.modal-text h3 {
  margin: 0 0 0.4rem 0;
  font-size: 1.2rem;
  color: #2c3e50;
}
.modal-post-link {
  color: #3A77D8;
  font-weight: 700;
  text-decoration: none;
  font-size: 0.95rem;
}
.modal-post-link:hover {
  color: #2e60ad;
  text-decoration: underline;
}
.modal-close-btn {
  background: none;
  border: none;
  font-size: 2rem;
  color: #666; 
  cursor: pointer;
  padding: 0 0 0 1rem;
  line-height: 1;
  transition: color 0.1s;
}
.modal-close-btn:hover {
  color: #000;
}

/* 封面层: 1.5s 动画 */
.custom-cover-layer {
  position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
  background-size: contain; background-repeat: no-repeat; background-position: center; 
  background-color: #000; 
  z-index: 5; /* 低于 plyr__controls (10) */
  transition: opacity 1.5s ease-in-out; /* 复刻 1.5s */
  opacity: 1;
  pointer-events: none; 
}

@keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
</style>

<main class="main container">

  <!-- 左侧：侧边栏 -->
  <aside class="aside typeset aside--video-nav" style="margin-right: 4%;">
    <section class="section" style="padding-top: 0.5rem;"> <!-- 微调顶部 Padding -->
      <!-- 英文 Index -->
      <h3>Index</h3>
      {% include video-list.html %}
    </section>
  </aside>

  <!-- 右侧：视频内容 -->
  <div class="content typeset" style="padding-top: 0.6rem;"> <!-- 微调对齐 -->
    
    <!-- 页面大标题 H2 -->
    <h2 style="margin-top: 0; line-height: 1.2em;" id="page-title">视频库</h2>

    <!-- 遍历生成分类 -->
    {% assign all_categories = site.data.video.categories %}
    
    {% for cat in all_categories %}
      {% if cat.videos %}
        {% assign current_videos = cat.videos %}
        {% assign section_id = cat.id %}
        {% include video-section-template.html %}
      {% endif %}

      {% if cat.children %}
        {% for subcat in cat.children %}
          {% if subcat.videos %}
            {% assign current_videos = subcat.videos %}
            {% assign section_id = subcat.id %}
            {% include video-section-template.html %}
          {% endif %}
        {% endfor %}
      {% endif %}
    {% endfor %}

  </div>

</main>

<!-- 弹窗 -->
<div class="video-modal-overlay" id="videoModal">
  <div class="video-modal-content" onclick="event.stopPropagation()">
    <div class="video-player-wrapper plyr-custom-wrapper">
      <video id="mainPlayer" playsinline controls style="width: 100%; height: 100%;"></video>
      <div class="custom-cover-layer" id="modalCoverLayer"></div>
    </div>
    
    <div class="video-modal-info typeset">
      <div class="modal-text">
        <h3 id="modalTitle"></h3>
        <a href="#" target="_blank" class="modal-post-link" id="modalLink">阅读相关文章 &rarr;</a>
      </div>
      <button class="modal-close-btn" onclick="closeModal()" aria-label="Close">×</button>
    </div>
  </div>
</div>

{% include site-footer.html %}

<script src="https://cdn.plyr.io/3.7.8/plyr.js"></script>

<script>
(function() {
  const videoBaseUrl = "{{ video_base_url }}";
  const coverBaseUrl = "{{ cover_base_url }}";
  const fallbackCoverUrl = "{{ fallback_cover }}";
  
  let player = null;
  const modal = document.getElementById('videoModal');
  const videoElement = document.getElementById('mainPlayer');
  const coverLayer = document.getElementById('modalCoverLayer');
  
  // 状态标记：当前是否使用通用封面
  let isUsingFallbackCover = false;

  function initPlayer() {
    player = new Plyr(videoElement, {
      controls: ['play-large', 'play', 'progress', 'current-time', 'mute', 'volume', 'settings', 'pip', 'fullscreen'],
      settings: ['quality', 'speed', 'loop'],
      speed: { selected: 1, options: [0.5, 0.75, 1, 1.25, 1.5, 2] },
      ratio: '16:9',
      resetOnEnd: true,
      i18n: { speed: '速度', normal: '正常', quality: '画质' }
    });

    // 核心逻辑：复刻 video.html 的 10s 延迟淡出
    // 只有当不使用 fallback 封面时才执行淡出逻辑
    player.on('timeupdate', function() {
        if (isUsingFallbackCover) return; // 如果是通用封面，不做淡出操作（或者在 openVideo 时直接隐藏了）

        const delaySeconds = 10; // 设定为 10 秒
        if (player.currentTime > delaySeconds) {
            coverLayer.style.opacity = '0';
        } else {
            // 如果用户拖回 10s 内，是否恢复封面？原逻辑通常不恢复，这里保持简单：
            // 只有 > 10s 隐藏。如果需要回退显示，解除下面注释
             coverLayer.style.opacity = '1';
        }
    });

    player.on('ended', () => { coverLayer.style.opacity = '1'; });
  }

  // 随机打乱 Grid 中的子元素
  function shuffleGrid(gridElement) {
    for (let i = gridElement.children.length; i >= 0; i--) {
        gridElement.appendChild(gridElement.children[Math.random() * i | 0]);
    }
  }

  window.openVideo = function(cardElement) {
    if (!cardElement || !cardElement.dataset) return;
    const ds = cardElement.dataset;
    const filename = ds.filename;
    if (!filename) return;
    
    const encodedFilename = encodeURIComponent(filename);
    const videoSrc = videoBaseUrl + encodedFilename;
    const filenameNoExt = filename.substring(0, filename.lastIndexOf('.'));
    const coverSrc = coverBaseUrl + encodeURIComponent(filenameNoExt) + ".jpg";

    document.getElementById('modalTitle').innerText = ds.title;
    const linkEl = document.getElementById('modalLink');
    if(ds.postUrl) {
      linkEl.href = "{{ site.baseurl }}" + ds.postUrl;
      linkEl.innerText = ds.postTitle || "阅读相关文章";
      linkEl.style.display = 'inline-block';
    } else {
      linkEl.style.display = 'none';
    }

    // 重置状态
    coverLayer.style.opacity = '1';
    coverLayer.style.display = 'block';
    isUsingFallbackCover = false;

    // 加载封面逻辑
    const img = new Image();
    img.src = coverSrc;
    img.onload = () => { 
        coverLayer.style.backgroundImage = `url("${coverSrc}")`;
    };
    img.onerror = () => { 
        // 失败，使用通用封面
        coverLayer.style.backgroundImage = `url("${fallbackCoverUrl}")`; 
        isUsingFallbackCover = true;
        // 需求：如果是通用封面，则“没有这个功能”。
        // 解释为：不显示遮罩层，直接让用户看黑底视频播放
        coverLayer.style.display = 'none';
    };

    player.source = {
      type: 'video',
      sources: [{ src: videoSrc, type: 'video/mp4' }]
    };

    modal.classList.add('open');
    player.play().catch(e => console.warn("Auto-play blocked:", e));
  };

  window.closeModal = function() {
    modal.classList.remove('open');
    player.pause();
    setTimeout(() => { 
        coverLayer.style.opacity = '1'; 
        coverLayer.style.display = 'block'; 
    }, 300);
  };

  modal.addEventListener('click', (e) => {
    if (e.target === modal) closeModal();
  });

  window.switchCategory = function(id, el) {
    document.querySelectorAll('.video-nav-header, .video-nav-subitem').forEach(e => e.classList.remove('active'));
    if(el) el.classList.add('active');
    
    // 隐藏所有
    document.querySelectorAll('.video-category-section').forEach(s => s.classList.remove('active'));
    
    // 显示目标
    const target = document.getElementById('section-' + id);
    if(target) {
      target.classList.add('active');
      document.getElementById('page-title').innerText = el.innerText.trim();
      
      // 需求：每次显示列表时，随机打乱顺序 (增加新鲜感)
      const grid = target.querySelector('.video-grid');
      if (grid) shuffleGrid(grid);
    }
  };

  window.toggleSubmenu = function(headerEl) {
    headerEl.classList.toggle('open');
    const subList = headerEl.nextElementSibling;
    if(subList) {
      subList.style.display = (subList.style.display === 'block') ? 'none' : 'block';
    }
  };

  document.addEventListener('DOMContentLoaded', () => {
    initPlayer();
    const isPC = window.innerWidth >= 900; 
    
    // 导航逻辑
    const headers = document.querySelectorAll('.video-nav-header.has-children');
    headers.forEach(header => {
      const subList = header.nextElementSibling;
      if(subList) {
        if (isPC) {
          header.classList.add('open');
          subList.style.display = 'block';
        } else {
          header.classList.remove('open');
          subList.style.display = 'none';
        }
      }
    });

    // 默认点击第一个分类
    const firstTrigger = document.querySelector('.video-nav-subitem, .video-nav-header[data-target]');
    if(firstTrigger) {
      switchCategory(firstTrigger.getAttribute('data-target'), firstTrigger);
    }
  });

})();
</script>