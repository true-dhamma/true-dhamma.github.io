---
layout: default
---
<!-- _layouts/video.html https://cdn.plyr.io/3.7.8/plyr.css -->

{% include site-header.html %}

<!-- 基础配置 -->
{% assign video_base_url = "https://file.true-dhamma.com/%E8%99%9A%E6%8B%9F%E6%BC%94%E6%92%AD%E5%AE%A4/%E8%A7%86%E9%A2%91/" %}
{% assign cover_base_url = "https://file.true-dhamma.com/%E8%99%9A%E6%8B%9F%E6%BC%94%E6%92%AD%E5%AE%A4/%E8%A7%86%E9%A2%91/cover/" %}
{% assign fallback_cover = cover_base_url | append: "general.jpg" %}

<link rel="stylesheet" href="/assets/plyr.css" />

<style>
/* ==========================================================================
   1. 通用侧边栏导航 (Renamed to categ ory-nav)
   ========================================================================== */

/* 侧边栏容器 */
.aside--category-nav { opacity: 1 !important; }

/* PC端侧边栏固定 */
@media screen and (min-width: 40em) {
  .aside--category-nav .section {
    position: sticky; top: 2rem; max-height: 80vh; overflow-y: auto;
  }
}

.category-nav-item { margin-bottom: 0.5rem; }

/* 导航头部 (一级菜单) */
.category-nav-header {
  cursor: pointer;
  display: flex; align-items: center;
  color: #3A77D8;
  padding: 0.3rem 0 0.3rem 0.4rem;
  user-select: none;
}
.category-nav-header:hover { color: #2e60ad; }
.category-nav-header.active { color: #2e60ad; font-weight: 700; }

/* 纯CSS三角形图标 */
.nav-arrow-icon {
  width: 0; height: 0;
  border-top: 5px solid transparent;
  border-bottom: 5px solid transparent;
  border-left: 6px solid #a8adac;
  display: inline-block;
  margin-right: 0.6rem;
  transform-origin: center;
  transition: transform 0.2s;
  flex-shrink: 0;
}
.category-nav-header.open .nav-arrow-icon {
  transform: rotate(90deg);
  border-left-color: #3A77D8;
}

/* 子菜单列表容器 */
.category-nav-sublist {
  margin-left: 0.44em; 
  margin-top: -0.35em;
  margin-bottom: 0.5rem;
  display: none; 
  border-left: 1px solid #e0e0e0;
  padding-left: 0.5em !important;
}

/* 子菜单项 (二级菜单) */
.category-nav-subitem {
  cursor: pointer;
  display: block;
  /* 左侧 padding 确保文字不贴线 */
  padding: 0.3rem 0 0.3rem 0.8rem; 
  color: #3A77D8;
  transition: color 0.1s;
  font-size: 1.1rem !important;
  line-height: 1.5;
}

/* 手机版二级标题字号放大 */
@media screen and (max-width: 40em) {
  .category-nav-subitem {
    font-size: 1.3rem !important; 
  }
}

.category-nav-subitem:hover { color: #2e60ad; text-decoration: underline; }
.category-nav-subitem.active { color: #2e60ad; font-weight: 700; }


/* ==========================================================================
   2. 视频列表与卡片 (Grid) - 保持 video 前缀，因为内容展示仍是视频专用的
   ========================================================================== */

.video-category-section { display: none; }
.video-category-section.active { display: block; animation: fadeIn 0.3s ease-out; }

/* Grid 间距 */
.video-grid {
  display: grid;
  grid-template-columns: 1fr;
  column-gap: 2rem;
  row-gap: 1.8rem; 
  margin-top: 1.5rem;
}
@media screen and (min-width: 40em) {
  .video-grid { grid-template-columns: repeat(2, 1fr); }
}

.video-card {
  cursor: pointer;
  background: transparent;
  transition: transform 0.1s;
}

/* 缩略图 */
.video-thumbnail-wrapper {
  position: relative;
  aspect-ratio: 16/9;
  background: #000;
  overflow: hidden;
  margin-bottom: 0.5rem; 
  border-radius: 8px;
  box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}
.video-thumbnail {
  width: 100%; height: 100%; object-fit: cover; 
  transition: none; opacity: 1;
}

/* 列表页播放按钮 - Plyr Blue */
.play-icon-overlay {
  position: absolute; top: 50%; left: 50%;
  transform: translate(-50%, -50%);
  width: 60px; height: 60px;
  background: rgba(0, 179, 255, 0.9);
  border-radius: 50%;
  display: flex; align-items: center; justify-content: center;
  pointer-events: none;
  box-shadow: 0 4px 15px rgba(0,0,0,0.3);
  opacity: 0;
  transition: opacity 0.2s, transform 0.2s;
}
.video-card:hover .play-icon-overlay {
  opacity: 1;
  transform: translate(-50%, -50%) scale(1.05);
}
.play-icon-overlay::after {
  content: ''; display: block; width: 0; height: 0;
  border-top: 10px solid transparent; border-bottom: 10px solid transparent;
  border-left: 18px solid #fff; margin-left: 6px;
}

/* 列表页标题 H6 - 蓝色 */
.video-card-title {
  margin: 0 !important;
  padding: 0 !important;
  line-height: 1.35 !important; 
  color: #3A77D8 !important;
  font-weight: 700;
  transition: color 0.1s;
}
.video-card:hover .video-card-title {
  color: #2e60ad !important;
  text-decoration: none !important; 
}


/* ==========================================================================
   3. 弹窗播放器
   ========================================================================== */

.video-modal-overlay {
  position: fixed; top: 0; left: 0; width: 100%; height: 100%;
  background: rgba(0, 0, 0, 0.85); z-index: 9999;
  display: flex; align-items: center; justify-content: center;
  opacity: 0; pointer-events: none; transition: opacity 0.2s ease;
  touch-action: none;
}
.video-modal-overlay.open { opacity: 1; pointer-events: auto; }

.video-modal-content {
  width: 94%; max-width: 1000px;
  background: #fff;
  border-radius: 8px;
  overflow: hidden;
  box-shadow: 0 10px 30px rgba(0,0,0,0.5);
  display: flex; flex-direction: column;
}

/* Plyr Wrapper */
.video-player-wrapper {
  position: relative;
  width: 100%;
  aspect-ratio: 16/9;
  background: #000;
  border-radius: 8px 8px 0 0; 
}
.plyr--fullscreen-enabled {
  border-radius: 0 !important;
}

/* 自定义封面层 */
.custom-cover-layer {
  position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
  background-size: contain; background-repeat: no-repeat; background-position: center; 
  background-color: #000; 
  z-index: 2; 
  transition: opacity 1.5s ease-in-out;
  opacity: 1;
  pointer-events: none;
}

/* 弹窗底部信息栏 */
.video-modal-info {
  padding: 0.8rem 1rem;
  background: #fff;
  display: flex; justify-content: space-between; align-items: flex-start;
  border-top: 1px solid #eee;
  border-radius: 0 0 8px 8px;
}
.modal-text {
  flex: 1;
  padding-right: 1rem;
}
.modal-text h6 { 
  margin: 0 0 0.3rem 0 !important; 
  font-size: 1.2rem !important; 
  color: #2c3e50 !important; 
  line-height: 1.3 !important; 
  font-weight: 700;
}
.modal-post-link { 
  color: #3A77D8; 
  font-weight: normal; 
  text-decoration: none; 
  font-size: 1.1rem; 
  display: inline-block;
}
.modal-post-link:hover { color: #2e60ad; text-decoration: underline; }
.modal-close-btn { 
  background: none; border: none; font-size: 2rem; color: #999; 
  cursor: pointer; padding: 0; line-height: 0.8; 
  margin-top: -2px;
}
.modal-close-btn:hover { color: #333; }

@keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

@media screen and (min-width: 40em) {
  body.modal-open { overflow: hidden !important; }
}
</style>

<main class="main container">

  <!-- 左侧：通用分类侧边栏 -->
  <aside class="aside typeset aside--category-nav" style="margin-right: 4%;">
    <section class="section" style="padding-top: 0;"> 
      <h3>Index</h3>
      <!-- 这里文件名已变更为 video-categories.html -->
      {% include video-categories.html %}
    </section>
  </aside>

  <!-- 右侧：视频内容 -->
  <div class="content typeset" style="padding-top: 0.2rem;">
    
    <!-- 标题中会包含数目，需注意 update -->
    <h2 style="margin-top: 0; line-height: 1.2em;" id="page-title">视频库</h2>

    {% assign all_categories = site.data.video.categories %}
    
    {% for cat in all_categories %}
      {% if cat.videos %}
        {% assign current_videos = cat.videos %}
        {% assign section_id = cat.id %}
        {% include video-section-template.html %}
      {% endif %}

      {% if cat.children %}
        {% for subcat in cat.children %}
          {% if subcat.videos %}
            {% assign current_videos = subcat.videos %}
            {% assign section_id = subcat.id %}
            {% include video-section-template.html %}
          {% endif %}
        {% endfor %}
      {% endif %}
    {% endfor %}

  </div>

</main>

<div class="video-modal-overlay" id="videoModal">
  <div class="video-modal-content" onclick="event.stopPropagation()">
    <div class="video-player-wrapper plyr-custom-wrapper">
      <video id="mainPlayer" playsinline controls style="width: 100%; height: 100%;"></video>
      <div class="custom-cover-layer" id="modalCoverLayer" style="display:none;"></div>
    </div>
    
    <div class="video-modal-info typeset">
      <div class="modal-text">
        <h6 id="modalTitle"></h6>
        <a href="#" target="_blank" class="modal-post-link" id="modalLink">阅读相关文章 &rarr;</a>
      </div>
      <button class="modal-close-btn" onclick="closeModal()" aria-label="Close">×</button>
    </div>
  </div>
</div>

{% include site-footer.html %}

<script src="/assets/plyr.js"></script>

<script>
(function() {
  const videoBaseUrl = "{{ video_base_url }}";
  const coverBaseUrl = "{{ cover_base_url }}";
  const fallbackCoverUrl = "{{ fallback_cover }}";
  
  let player = null;
  const modal = document.getElementById('videoModal');
  const videoElement = document.getElementById('mainPlayer');
  const coverLayer = document.getElementById('modalCoverLayer');
  
  let scrollPosition = 0;
  let isUsingFallbackCover = false;

  // --- 工具函数：更严格的 URL 编码 ---
  // 修复：必须将括号 '(', ')' 转义为 %28, %29，
  // 否则文件名带括号时（如 "巴育陀(P...)"），某些服务器会报 404 错误。
  function fixedEncodeURIComponent(str) {
    return encodeURIComponent(str).replace(/[!'()*]/g, function(c) {
      return '%' + c.charCodeAt(0).toString(16);
    });
  }

  function initPlayer() {
    player = new Plyr(videoElement, {
      iconUrl: '/assets/plyr.svg',
      blankVideo: '/assets/blank.mp4',
      controls: ['play-large', 'play', 'progress', 'current-time', 'mute', 'volume', 'settings', 'pip', 'fullscreen'],
      settings: ['quality', 'speed', 'loop'],
      speed: { selected: 1, options: [0.5, 0.75, 1, 1.25, 1.5, 2] },
      ratio: '16:9',
      resetOnEnd: true,
      i18n: { speed: '速度', normal: '正常', quality: '画质' },
      fullscreen: { enabled: true, fallback: true, iosNative: true } 
    });

    var moveLayer = function() {
        if (player.elements && player.elements.container && coverLayer.parentNode !== player.elements.container) {
            player.elements.container.appendChild(coverLayer);
            if (!isUsingFallbackCover) {
                coverLayer.style.display = 'block';
            }
        }
    };
    
    player.on('ready', moveLayer);
    player.on('enterfullscreen', moveLayer);
    setTimeout(moveLayer, 100);

    player.on('play', function() {
        if (isUsingFallbackCover) {
            coverLayer.style.display = 'none';
        }
    });

    player.on('timeupdate', function() {
        if (isUsingFallbackCover) return; 
        const delaySeconds = 10; 
        if (player.currentTime > delaySeconds) {
            coverLayer.style.opacity = '0';
        } else {
            coverLayer.style.opacity = '1';
        }
    });

    player.on('ended', () => { 
        if (!isUsingFallbackCover) {
            coverLayer.style.display = 'block';
            setTimeout(() => { coverLayer.style.opacity = '1'; }, 10);
        }
    });
  }

  // --- 随机排序逻辑 ---
  let _seed = 0;
  function seededRandom() {
      _seed = (_seed * 9301 + 49297) % 233280;
      return _seed / 233280.0;
  }

  function shuffleGrid(gridElement) {
    if (!gridElement) return;
    const now = new Date();
    const dailySeed = now.getFullYear() * 10000 + (now.getMonth() + 1) * 100 + now.getDate();
    _seed = dailySeed + gridElement.children.length;

    let childrenArray = Array.prototype.slice.call(gridElement.children);
    for (let i = childrenArray.length - 1; i > 0; i--) {
        const j = Math.floor(seededRandom() * (i + 1));
        [childrenArray[i], childrenArray[j]] = [childrenArray[j], childrenArray[i]];
    }
    childrenArray.forEach(function(child) {
        gridElement.appendChild(child);
    });
  }

  function disableScroll() {
    scrollPosition = window.pageYOffset;
    document.body.style.overflow = 'hidden';
    document.body.style.position = 'fixed';
    document.body.style.top = `-${scrollPosition}px`;
    document.body.style.width = '100%';
    document.body.classList.add('modal-open');
  }

  function enableScroll() {
    document.body.style.removeProperty('overflow');
    document.body.style.removeProperty('position');
    document.body.style.removeProperty('top');
    document.body.style.removeProperty('width');
    window.scrollTo(0, scrollPosition);
    document.body.classList.remove('modal-open');
  }

  // --- 核心函数：打开视频 ---
  window.openVideo = function(cardElement) {
    if (!cardElement || !cardElement.dataset) return;
    const ds = cardElement.dataset;
    const filename = ds.filename; // 完整文件名，例如 "巴育陀(P. A. Payutto)...mp4"
    
    // 1. 处理视频地址：对整个文件名进行严格编码
    const encodedFilename = fixedEncodeURIComponent(filename);
    const videoSrc = videoBaseUrl + encodedFilename;
    
    // 2. 处理封面地址：【关键修复点】
    // 使用 lastIndexOf 从后往前找最后一个点，确保不会在文件名中间的点(P.)处截断
    const lastDotIndex = filename.lastIndexOf('.');
    let filenameNoExt = filename;
    
    if (lastDotIndex > 0) {
        filenameNoExt = filename.substring(0, lastDotIndex);
    }
    
    // 对去掉扩展名的文件名进行严格编码（包含括号转义），再加上 .jpg
    const encodedNoExt = fixedEncodeURIComponent(filenameNoExt);
    const coverSrc = coverBaseUrl + encodedNoExt + ".jpg";

    // 调试日志：如果还有问题，请在浏览器控制台查看这一行的输出
    console.log("Cover Request URL:", coverSrc);

    // 3. 更新 URL Hash，格式：#分类ID/编码后的文件名
    const section = cardElement.closest('.video-category-section');
    if (section) {
        const catId = section.id.replace('section-', '');
        if (history.replaceState) {
            history.replaceState(null, null, '#' + catId + '/' + encodedFilename);
        }
    }

    // 设置弹窗内容
    document.getElementById('modalTitle').innerText = ds.title;
    const linkEl = document.getElementById('modalLink');
    if(ds.postUrl) {
      linkEl.href = "{{ site.baseurl }}" + ds.postUrl;
      linkEl.innerText = ds.postTitle || "阅读相关文章";
      linkEl.style.display = 'inline-block';
    } else {
      linkEl.style.display = 'none';
    }

    // 重置封面状态
    isUsingFallbackCover = false;
    coverLayer.style.opacity = '1';
    coverLayer.style.display = 'block';

    // 加载封面图
    const img = new Image();
    img.src = coverSrc;
    img.onload = () => { 
        coverLayer.style.backgroundImage = `url("${coverSrc}")`;
    };
    img.onerror = () => { 
        console.warn("Cover load failed for:", coverSrc, "Using fallback.");
        coverLayer.style.backgroundImage = `url("${fallbackCoverUrl}")`; 
        isUsingFallbackCover = true;
        coverLayer.style.display = 'none'; 
    };

    // 设置 Plyr 源
    player.source = {
      type: 'video',
      sources: [{ src: videoSrc, type: 'video/mp4' }]
    };

    modal.classList.add('open');
    disableScroll(); 

    if (player.elements && player.elements.container) {
         player.elements.container.appendChild(coverLayer);
    }
    
    player.play().catch(e => console.warn("Auto-play blocked:", e));
  };

  window.closeModal = function() {
    modal.classList.remove('open');
    enableScroll(); 
    player.pause();
    
    // 关闭时，将 URL 还原为纯分类（去掉文件名部分）
    const currentHash = window.location.hash;
    if (currentHash && currentHash.includes('/')) {
        const catId = currentHash.split('/')[0]; 
        if (history.replaceState) {
            history.replaceState(null, null, catId);
        }
    }

    setTimeout(() => { 
        coverLayer.style.opacity = '1'; 
        if (!isUsingFallbackCover) coverLayer.style.display = 'block'; 
    }, 300);
  };

  modal.addEventListener('click', (e) => {
    if (e.target === modal) closeModal();
  });

  window.switchCategory = function(id, el) {
    document.querySelectorAll('.category-nav-header, .category-nav-subitem').forEach(e => e.classList.remove('active'));
    if(el) el.classList.add('active');
    
    document.querySelectorAll('.video-category-section').forEach(s => s.classList.remove('active'));
    
    const target = document.getElementById('section-' + id);
    if(target) {
      target.classList.add('active');
      const text = el.innerText || el.textContent;
      document.getElementById('page-title').innerText = text.trim();
      
      const grid = target.querySelector('.video-grid');
      if (grid) shuffleGrid(grid);

      // 仅在非弹窗状态下更新 Hash，避免覆盖视频链接
      if (!modal.classList.contains('open')) {
        if (history.replaceState) {
            history.replaceState(null, null, '#' + id);
        } else {
            window.location.hash = id;
        }
      }
    }
  };

  window.toggleSubmenu = function(headerEl) {
    headerEl.classList.toggle('open');
    const subList = headerEl.nextElementSibling;
    if(subList) {
      subList.style.display = (subList.style.display === 'block') ? 'none' : 'block';
    }
  };

  // --- 初始化逻辑 ---
  document.addEventListener('DOMContentLoaded', () => {
    initPlayer();
    const isPC = window.innerWidth >= 900; 
    
    // 展开侧边栏逻辑
    const headers = document.querySelectorAll('.category-nav-header.has-children');
    headers.forEach(header => {
      const subList = header.nextElementSibling;
      if(subList) {
        if (isPC) {
          header.classList.add('open');
          subList.style.display = 'block';
        } else {
          header.classList.remove('open');
          subList.style.display = 'none';
        }
      }
    });

    // 解析 URL Hash
    const rawHash = window.location.hash.substring(1); 
    let targetCatId = rawHash;
    let targetVideoFile = null;

    if (rawHash.includes('/')) {
        const parts = rawHash.split('/');
        targetCatId = parts[0];
        try {
            // 解码文件名，以便在 DOM 中查找
            targetVideoFile = decodeURIComponent(parts.slice(1).join('/'));
        } catch (e) {
            console.error("URL Decode Error:", e);
        }
    }

    // 定位并激活分类
    let targetEl = null;
    if (targetCatId) {
      targetEl = document.querySelector(`.category-nav-subitem[data-target="${targetCatId}"], .category-nav-header[data-target="${targetCatId}"]`);
    }
    
    if (!targetEl) {
      targetEl = document.querySelector('.category-nav-subitem, .category-nav-header[data-target]');
    }

    if(targetEl) {
      if (targetEl.classList.contains('category-nav-subitem')) {
        const parentUl = targetEl.parentElement;
        if (parentUl) {
           parentUl.style.display = 'block';
           const parentHeader = parentUl.previousElementSibling;
           if (parentHeader) parentHeader.classList.add('open');
        }
      }
      switchCategory(targetEl.getAttribute('data-target'), targetEl);

      // 如果 URL 包含视频文件名，自动播放
      if (targetVideoFile) {
        // 使用 CSS.escape 处理文件名中的特殊字符（如括号、引号）
        // 确保 querySelector 不会报错
        try {
            const escapedFilename = CSS.escape(targetVideoFile);
            const videoCard = document.querySelector(`.video-category-section.active .video-card[data-filename="${escapedFilename}"]`);
            
            if (videoCard) {
                setTimeout(() => {
                    openVideo(videoCard);
                }, 300);
            } else {
                console.warn("Shared video not found in DOM:", targetVideoFile);
            }
        } catch (e) {
            console.error("Auto-play selection error:", e);
        }
      }
    }
  });

})();
</script>