<!-- ======================================================================
     Jekyll Video Include (Plyr Ultimate v12 - High Contrast Subtitles)
     
     Updates:
     1. [画质增强] 修复全屏下字幕描边太细的问题。
        - 普通模式: 2px 描边 (精致)
        - 全屏模式: 4px 8方向重描边 (扎实，类似电影字幕效果)
     2. [原有功能] 保持自动加载、自动播放、字号智能缩放等所有逻辑不变。
     ====================================================================== -->

<div class="plyr-custom-wrapper" 
     data-video-url="{{ include.url }}" 
     data-delay="{{ include.delay | default: 10 }}" 
     style="width: 100%; margin-bottom: 1.5rem; position: relative; aspect-ratio: 16/9; background: #000; border-radius: 8px; overflow: hidden;">
    
    <!-- Video -->
    <video playsinline controls preload="metadata" crossorigin="anonymous" style="width: 100%; height: 100%;">
        <source src="{{ include.url }}" type="video/mp4">
    </video>

    <!-- Cover -->
    <div class="custom-cover-layer" 
         style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
                background-size: contain; background-repeat: no-repeat; background-color: #000;
                background-position: center; 
                z-index: 2; pointer-events: none; 
                transition: opacity 1.5s ease-in-out; opacity: 1;">
    </div>
</div>

<script>
(function() {
    var currentScript = document.currentScript;
    var wrapper = null;
    if (currentScript) {
        var prev = currentScript.previousElementSibling;
        while (prev) {
            if (prev.nodeType === 1 && prev.classList.contains('plyr-custom-wrapper')) {
                wrapper = prev;
                break;
            }
            prev = prev.previousElementSibling;
        }
    }
    if (!wrapper) return;

    // --- CSS 注入区 (本次核心修改都在这里) ---
    if (!document.getElementById('plyr-css-cdn')) {
        var cssLink = document.createElement('link');
        cssLink.id = 'plyr-css-cdn';
        cssLink.rel = 'stylesheet';
        cssLink.href = 'https://cdn.plyr.io/3.7.8/plyr.css';
        document.head.appendChild(cssLink);
        
        var style = document.createElement('style');
        style.innerHTML = `
            .plyr__controls { z-index: 5 !important; }
            
            /* 1. 字幕容器位置与字号 */
            .plyr__captions {
                display: block !important;
                font-family: system-ui, -apple-system, sans-serif !important;
                padding: 10px 0 20px 0 !important;
                transform: translateY(-5px);
                transition: font-size 0.3s ease; 
            }

            /* 普通窗口: 16px - 24px */
            .plyr-custom-wrapper .plyr__captions {
                font-size: clamp(16px, 3vw, 24px) !important;
            }

            /* 全屏模式: 2.5vw (约48px-100px) */
            .plyr-custom-wrapper.is-fullscreen-mode .plyr__captions {
                font-size: 2.5vw !important; 
                width: 90% !important;
                left: 5% !important;
                bottom: 8% !important; 
            }

            /* =========================================================
               2. 字幕文字本体 (描边增强核心)
               ========================================================= */
            
            /* [通用基础] 去除背景，白色文字 */
            .plyr__caption {
                background: transparent !important;
                color: #fff !important;
                font-weight: 700 !important;
                line-height: 1.3 !important;
                padding: 0 4px !important;
            }

            /* [状态 A: 普通模式] 
               描边较细 (2px)，适合小字号，避免糊成一团 
            */
            .plyr-custom-wrapper .plyr__caption {
                text-shadow: 
                     1.5px  0 0 #000, -1.5px  0 0 #000, 
                     0  1.5px 0 #000,  0 -1.5px 0 #000, 
                     1px 1px 2px rgba(0,0,0,0.8) !important;
            }

            /* [状态 B: 全屏模式] 
               描边加粗 (4px)，并在8个方向进行堆叠，确保在亮色背景下清晰可见
            */
            .plyr-custom-wrapper.is-fullscreen-mode .plyr__caption {
                /* 使用 CSS 变量或直接写死更粗的阴影 */
                text-shadow: 
                     3px  0 0 #000, -3px  0 0 #000, 
                     0  3px 0 #000,  0 -3px 0 #000, 
                     2px  2px 0 #000, -2px -2px 0 #000, 
                     2px -2px 0 #000, -2px  2px 0 #000,
                     2px 2px 5px rgba(0,0,0,1) !important; /* 加重的外发光投影 */
            }
        `;
        document.head.appendChild(style);
    }

    if (!window.plyrScriptLoading) {
        window.plyrScriptLoading = true;
        window.plyrReadyCallbacks = [];
        var jsScript = document.createElement('script');
        jsScript.src = 'https://cdn.plyr.io/3.7.8/plyr.js';
        jsScript.onload = function() {
            window.plyrLoaded = true;
            if (window.plyrReadyCallbacks) {
                window.plyrReadyCallbacks.forEach(function(cb) { cb(); });
                window.plyrReadyCallbacks = [];
            }
        };
        document.head.appendChild(jsScript);
    }

    if (!window.initSinglePlyrVideo) {
        window.initSinglePlyrVideo = function(wrapper) {
            if (wrapper.getAttribute('data-init-done')) return;
            wrapper.setAttribute('data-init-done', 'true');

            var videoUrl = wrapper.getAttribute('data-video-url');
            var delayAttr = wrapper.getAttribute('data-delay');
            var delaySeconds = delayAttr ? parseFloat(delayAttr) : 10;
            var videoEl = wrapper.querySelector('video');
            var coverLayer = wrapper.querySelector('.custom-cover-layer');

            if (!videoEl || !coverLayer) return;

            // [URL 解析]
            var basePath = null;
            var fileNameNoExt = null;
            if (videoUrl) {
                try {
                    var cleanUrl = videoUrl.split('?')[0];
                    var parts = cleanUrl.split('/');
                    var fileNameFull = parts.pop();
                    if (fileNameFull) {
                        var fileNameDecoded = decodeURIComponent(fileNameFull);
                        fileNameNoExt = fileNameDecoded.substring(0, fileNameDecoded.lastIndexOf('.'));
                        basePath = parts.join('/');
                    }
                } catch (e) { console.error(e); }
            }

            // [注入字幕]
            if (basePath && fileNameNoExt) {
                try {
                    var vttPath = basePath + '/vtt/' + encodeURIComponent(fileNameNoExt) + '.vtt';
                    var track = document.createElement('track');
                    track.kind = 'captions';
                    track.label = '中文';
                    track.srclang = 'zh';
                    track.src = vttPath;
                    track.default = true; 
                    videoEl.appendChild(track);
                } catch (e) { console.error(e); }
            }

            // [Plyr 初始化]
            var player = new Plyr(videoEl, {
                controls: [
                    'play-large', 'play', 'progress', 'current-time', 
                    'mute', 'volume', 'captions', 'settings', 'pip', 'fullscreen'
                ],
                settings: ['captions', 'quality', 'speed', 'loop'],
                speed: { selected: 1, options: [0.5, 0.75, 1, 1.25, 1.5, 2] },
                captions: { active: true, update: true, language: 'zh' },
                i18n: {
                    speed: '速度', normal: '正常', quality: '画质',
                    loop: '循环播放', play: '播放', pause: '暂停', pip: '画中画',
                    captions: '字幕', disabled: '关闭', enabled: '开启'
                },
                playsinline: true,
                resetOnEnd: true,
                ratio: '16:9' 
            });

            // [JS 事件监听: 切换全屏样式类]
            player.on('enterfullscreen', function() {
                wrapper.classList.add('is-fullscreen-mode');
            });
            player.on('exitfullscreen', function() {
                wrapper.classList.remove('is-fullscreen-mode');
            });

            // [封面逻辑]
            var moveLayer = function() {
                if (player.elements && player.elements.container && coverLayer.parentNode !== player.elements.container) {
                    player.elements.container.appendChild(coverLayer);
                }
            };
            moveLayer();
            player.on('ready', moveLayer);

            if (basePath && fileNameNoExt) {
                try {
                    var coverPath = basePath + '/cover/' + encodeURIComponent(fileNameNoExt) + '.jpg';
                    var img = new Image();
                    img.src = coverPath;
                    img.onload = function() {
                        coverLayer.style.backgroundImage = 'url("' + coverPath + '")';
                        player.on('timeupdate', function() {
                            if (player.currentTime > delaySeconds) {
                                coverLayer.style.opacity = '0';
                            } else {
                                coverLayer.style.opacity = '1';
                            }
                        });
                        player.on('ended', function() { coverLayer.style.opacity = '1'; });
                    };
                    img.onerror = function() { coverLayer.style.display = 'none'; };
                } catch (e) { console.error(e); }
            }

            player.on('loadedmetadata', function() {
                if (player.media.videoWidth && player.media.videoHeight) {
                    var ratio = player.media.videoWidth + ' / ' + player.media.videoHeight;
                    wrapper.style.aspectRatio = ratio;
                }
            });
        };
    }

    if (window.plyrLoaded) {
        window.initSinglePlyrVideo(wrapper);
    } else {
        if (!window.plyrReadyCallbacks) window.plyrReadyCallbacks = [];
        window.plyrReadyCallbacks.push(function() {
            window.initSinglePlyrVideo(wrapper);
        });
    }
})();
</script>