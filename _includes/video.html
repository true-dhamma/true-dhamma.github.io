<!-- ======================================================================
     Jekyll Video Include (Plyr + Auto Cover + 10s Delay)
     Fix: 解决封面遮挡进度条问题，增强多实例稳定性
     ====================================================================== -->

<div class="plyr-custom-wrapper" 
     id="plyr-wrapper-{{ include.url | slugify }}-{{ 'now' | date: '%s%N' }}"
     data-video-url="{{ include.url }}" 
     data-delay="10"
     style="width: 100%; margin-bottom: 1.5rem; position: relative; aspect-ratio: 16/9; background: #000; border-radius: 8px; overflow: hidden;">
    
    <!-- 1. 占位 Video -->
    <!-- 加上 playsinline 确保 iOS 不会强制全屏从而导致遮罩失效 -->
    <video playsinline controls preload="metadata" style="width: 100%; height: 100%; object-fit: cover;">
        <source src="{{ include.url }}" type="video/mp4">
    </video>

    <!-- 2. 封面层 (初始放在这里，JS 会把它移入 Plyr 内部) -->
    <div class="custom-cover-layer" 
         style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
                background-size: cover; background-position: center; 
                z-index: 2; pointer-events: none; 
                transition: opacity 0.5s ease; opacity: 1;">
    </div>
</div>

<script>
(function() {
    // 获取当前脚本紧邻的 Wrapper（使用 ID 辅助查找更安全，或者保留 previousElementSibling 方案但加容错）
    var currentScript = document.currentScript;
    // 容错处理：循环向前查找直到找到 div.plyr-custom-wrapper
    var wrapper = currentScript.previousElementSibling;
    while (wrapper && !wrapper.classList.contains('plyr-custom-wrapper')) {
        wrapper = wrapper.previousElementSibling;
    }
    
    if (!wrapper) { console.warn('Plyr wrapper not found for script'); return; }

    // --- A. 注入 CSS (单例模式) ---
    if (!document.getElementById('plyr-css-cdn')) {
        var cssLink = document.createElement('link');
        cssLink.id = 'plyr-css-cdn';
        cssLink.rel = 'stylesheet';
        cssLink.href = 'https://cdn.plyr.io/3.7.8/plyr.css';
        document.head.appendChild(cssLink);
    }

    // --- B. 注入 JS (单例 + 队列模式) ---
    if (!window.plyrScriptLoading) {
        window.plyrScriptLoading = true;
        window.plyrReadyCallbacks = [];
        
        var jsScript = document.createElement('script');
        jsScript.src = 'https://cdn.plyr.io/3.7.8/plyr.js';
        jsScript.onload = function() {
            window.plyrLoaded = true;
            window.plyrReadyCallbacks.forEach(function(cb) { cb(); });
            window.plyrReadyCallbacks = [];
        };
        document.head.appendChild(jsScript);
    }

    // --- C. 初始化函数 (全局定义一次) ---
    if (!window.initSinglePlyrVideo) {
        window.initSinglePlyrVideo = function(wrapper) {
            if (wrapper.getAttribute('data-init-done')) return;
            wrapper.setAttribute('data-init-done', 'true');

            var videoUrl = wrapper.getAttribute('data-video-url');
            var delaySeconds = parseFloat(wrapper.getAttribute('data-delay') || 10);
            var videoEl = wrapper.querySelector('video');
            var coverLayer = wrapper.querySelector('.custom-cover-layer');

            // 1. 初始化 Plyr
            var player = new Plyr(videoEl, {
                controls: ['play-large', 'play', 'progress', 'current-time', 'mute', 'volume', 'fullscreen'],
                playsinline: true,
                resetOnEnd: true,
                ratio: '16:9'
            });

            // ============================================================
            // 关键修复：将封面层移动到 Plyr 容器内部
            // 这样既能盖住视频，又允许 Plyr 的进度条(z-index:3) 显示在它上面
            // ============================================================
            player.on('ready', function() {
                // player.elements.container 是 Plyr 生成的最外层 div
                // prepend 确保它在最底层（但在视频之上，因为我们有 z-index:2）
                // 此时 Plyr UI 控件通常 z-index 都在 3 以上
                player.elements.container.appendChild(coverLayer);
            });

            // 2. 封面逻辑
            if (videoUrl) {
                try {
                    var parts = videoUrl.split('?')[0].split('/');
                    var fileNameFull = parts.pop();
                    var fileNameDecoded = decodeURIComponent(fileNameFull);
                    var fileNameNoExt = fileNameDecoded.substring(0, fileNameDecoded.lastIndexOf('.'));
                    var basePath = parts.join('/');
                    var coverPath = basePath + '/cover/' + encodeURIComponent(fileNameNoExt) + '.jpg';

                    var img = new Image();
                    img.src = coverPath;
                    img.onload = function() {
                        coverLayer.style.backgroundImage = 'url("' + coverPath + '")';
                        
                        player.on('timeupdate', function() {
                            if (player.currentTime > delaySeconds) {
                                coverLayer.style.opacity = '0';
                            } else {
                                coverLayer.style.opacity = '1';
                            }
                        });

                        player.on('ended', function() {
                            coverLayer.style.opacity = '1';
                        });
                    };
                    img.onerror = function() {
                        coverLayer.style.display = 'none'; 
                    };
                } catch (e) { console.error('Cover logic error:', e); }
            }

            // 3. 宽高比自适应
            player.on('loadedmetadata', function() {
                if (player.media.videoWidth && player.media.videoHeight) {
                    wrapper.style.aspectRatio = player.media.videoWidth + ' / ' + player.media.videoHeight;
                }
            });
        };
    }

    // --- D. 执行或加入队列 ---
    if (window.plyrLoaded) {
        window.initSinglePlyrVideo(wrapper);
    } else {
        if (!window.plyrReadyCallbacks) window.plyrReadyCallbacks = [];
        window.plyrReadyCallbacks.push(function() {
            window.initSinglePlyrVideo(wrapper);
        });
    }
})();
</script>