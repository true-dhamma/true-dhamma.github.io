{%- comment %}
  _includes/build-nav-tree.html
  - 生成一个扁平化的<ul>列表，但通过 data-level 属性和 class 记录了层级和状态。
  - JavaScript 将会用这些信息来构建可视化的嵌套树。
{%- endcomment %}

<ul>
{% assign docs = site[include.collection] | sort: 'path' %}
{% for doc in docs %}
  {%- comment %}从内容中提取第一个标题作为文档标题{% endcomment %}
  {% assign first_line = doc.content | split: '
' | first %}
  {% assign title = first_line | remove_first: '#' | remove_first: '#' | remove_first: '#' | remove_first: '#' | strip %}

  {%- comment %}从文件名计算层级{% endcomment %}
  {% assign parts = doc.name | split: '-' %}
  {% assign level = 0 %}
  {% for part in parts %}
    {% assign is_numeric = part | plus: 0 %}
    {% if is_numeric > 0 or part == "0" or part == "00" %}
      {% assign level = level | plus: 1 %}
    {% else %}
      {% break %}
    {% endif %}
  {% endfor %}
  {% if level == 0 %}{% assign level = 1 %}{% endif %}

  {%- comment %}检查是否是当前页面或当前页面的祖先{% endcomment %}
  {% assign is_active = '' %}
  {% if page.path == doc.path %}
    {% assign is_active = 'is-active' %}
  {% elsif page.path contains doc.path | split: '.' | first %}
    {%- comment %}更精确的祖先判断，避免 "01" 匹配到 "01-01" 的同时还匹配到 "10" {% endcomment %}
    {% assign current_path_prefix = page.path | split: doc.name | first %}
    {% assign doc_path_prefix = doc.path | split: doc.name | first %}
    {% if current_path_prefix == doc_path_prefix %}
        {% assign is_active = 'is-ancestor' %}
    {% endif %}
  {% endif %}

  <li data-level="{{ level }}" class="{{ is_active }}">
    <a href="{{ doc.url | relative_url }}">{{ title }}</a>
  </li>
{% endfor %}
</ul>