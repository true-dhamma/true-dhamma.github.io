{%- comment %}
  _includes/build-nav-tree.html (终极健壮版)
  - 增加 nil/空值检查。
  - 简化所有逻辑。
{%- endcomment %}

<ul>
{% assign docs = site[include.collection] | sort: 'path' %}
{% for doc in docs %}
  {%- assign title = "Untitled" -%}
  {%- assign content_lines = doc.content | split: "
" -%}
  {%- for line in content_lines -%}
    {%- assign stripped_line = line | strip -%}
    {%- if stripped_line.size > 0 and stripped_line contains "#" -%}
      {%- assign first_char = stripped_line | slice: 0 -%}
      {%- if first_char == "#" -%}
        {%- assign temp_title = stripped_line | remove_first: "#### " | remove_first: "### " | remove_first: "## " | remove_first: "# " | strip -%}
        {%- if temp_title.size > 0 -%}
          {%- assign title = temp_title -%}
        {%- endif -%}
        {%- break -%}
      {%- endif -%}
    {%- endif -%}
  {%- endfor -%}

  {%- assign filename_base = doc.name | split: "." | first | default: "" -%}
  {%- assign numeric_prefix_parts = filename_base | split: "-" -%}
  {%- assign level = 0 -%}
  {%- for part in numeric_prefix_parts -%}
    {%- assign is_all_digits = part | match: '^\d+$' -%}
    {%- if is_all_digits -%}
      {%- assign level = level | plus: 1 -%}
    {%- else -%}
      {%- break -%}
    {%- endif -%}
  {%- endfor -%}
  {%- if level == 0 %}{% assign level = 1 %}{% endif -%}

  {%- assign is_active_class = '' -%}
  {%- assign current_doc_prefix = page.name | split: '.' | first | default: "" -%}
  {%- assign this_doc_prefix = doc.name | split: '.' | first | default: "" -%}

  {%- if current_doc_prefix == this_doc_prefix -%}
    {%- assign is_active_class = 'is-active' -%}
  {%- else -%}
    {%- assign this_doc_prefix_size = this_doc_prefix.size -%}
    {%- if this_doc_prefix_size > 0 -%}
      {%- assign current_doc_prefix_slice = current_doc_prefix | slice: 0, this_doc_prefix_size -%}
      {%- if current_doc_prefix_slice == this_doc_prefix -%}
        {%- assign next_char_index = this_doc_prefix_size -%}
        {%- assign next_char = current_doc_prefix | slice: next_char_index, 1 -%}
        {%- if next_char == '-' -%}
          {%- assign is_active_class = 'is-ancestor' -%}
        {%- endif -%}
      {%- endif -%}
    {%- endif -%}
  {%- endif -%}

  <li data-level="{{ level }}" class="{{ is_active_class }}">
    <a href="{{ doc.url | relative_url }}">{{ title }}</a>
  </li>
{% endfor %}
</ul>