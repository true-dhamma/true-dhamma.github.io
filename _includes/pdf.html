{% assign uid = include.url | slugify | append: 'now' | date: '%s' | append: forloop.index %}
{% assign fName = include.url | split: '/' | last %}
{% assign cName = fName | replace: '.pdf', '.jpg' | replace: '.PDF', '.jpg' %}
{% assign auto_cover = include.url | remove: fName | append: 'cover/' | append: cName %}
{% assign def_cover = "https://file.true-dhamma.com/虚拟演播室/幻灯片/cover/general.jpg" %}
{% if include.cover %}{% assign final_cover = include.cover %}{% else %}{% assign final_cover = auto_cover %}{% endif %}

<div class="pdf-wrapper" id="pdf-wrapper-{{ uid }}">
  <div class="pdf-cover-layer" id="cover-{{ uid }}">
    <img src="{{ final_cover }}" alt="PDF Cover" class="pdf-poster-img" onerror="this.onerror=null;this.src='{{ def_cover }}';">
    <button class="pdf-start-btn" id="btn-{{ uid }}" onclick="initPdf_{{ uid | replace: '-','_' }}()" aria-label="阅读 PDF">
      <svg viewBox="0 0 24 24" width="48" height="48" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 14.5v-9l6 4.5-6 4.5z"/></svg>
      <span id="btn-text-{{ uid }}">点击浏览 PDF</span>
    </button>
  </div>
  <div class="pdf-viewer-layer" id="viewer-{{ uid }}" style="display:none;opacity:0;transition:opacity 0.3s ease;">
    <div class="pdf-canvas-container"><canvas id="the-canvas-{{ uid }}"></canvas></div>
    <div class="pdf-controls">
      <button class="pdf-btn" id="prev-{{ uid }}"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 18l-6-6 6-6"/></svg></button>
      <span class="pdf-page-info"><span id="page_num-{{ uid }}">1</span> / <span id="page_count-{{ uid }}">--</span></span>
      <button class="pdf-btn" id="next-{{ uid }}"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 18l6-6-6-6"/></svg></button>
      <div class="pdf-divider"></div>
      <button class="pdf-btn" id="fullscreen-{{ uid }}" title="全屏"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"/></svg></button>
      <a href="{{ include.url }}" download class="pdf-btn" title="下载 PDF" target="_blank"><svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M5 20h14v-2H5v2zM19 9h-4V3H9v6H5l7 7 7-7z"/></svg></a>
    </div>
  </div>
</div>

<style>
.pdf-wrapper{position:relative;width:100%;background:#f1f1f1;border-radius:8px;overflow:hidden;margin:20px 0;box-shadow:0 4px 6px rgba(0,0,0,0.1)}
.pdf-cover-layer{position:relative;width:100%;cursor:pointer;display:flex;align-items:center;justify-content:center;min-height:200px;background:#eee;transition:opacity 0.3s ease}
.pdf-poster-img{width:100%;height:auto;display:block;object-fit:cover}
.pdf-start-btn{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(0,0,0,0.7);border:none;border-radius:50px;color:#fff;padding:10px 20px;display:flex;align-items:center;gap:10px;cursor:pointer;z-index:10;transition:0.2s}
.pdf-start-btn:hover{background:rgba(0,0,0,0.9);transform:translate(-50%,-50%) scale(1.05)}
.pdf-start-btn:disabled{opacity:0.7;cursor:wait;transform:translate(-50%,-50%)}
.pdf-viewer-layer{background:#333;flex-direction:column;width:100%}
.pdf-canvas-container{width:100%;overflow:auto;display:flex;justify-content:center;background-color:#525659}
canvas{display:block;max-width:100%;height:auto!important}
.pdf-controls{display:flex;align-items:center;justify-content:center;background:#222;color:#fff;padding:8px;gap:10px;flex-wrap:wrap}
.pdf-btn{background:0 0;border:none;color:#fff;cursor:pointer;padding:5px;border-radius:4px;display:flex;align-items:center}
.pdf-btn:hover{background:rgba(255,255,255,0.2)}
.pdf-page-info{font-size:14px;font-family:monospace;min-width:60px;text-align:center}
.pdf-divider{width:1px;height:20px;background:#555;margin:0 5px}
.pdf-wrapper:fullscreen{display:flex;flex-direction:column;justify-content:center;background:#000;width:100vw;height:100vh;border-radius:0}
.pdf-wrapper:fullscreen .pdf-canvas-container{flex:1;align-items:center}
.pdf-wrapper:fullscreen canvas{max-height:90vh;width:auto;max-width:100%}
</style>

<script>
(function(){
const u="{{ include.url }}",wId="pdf-wrapper-{{ uid }}",cId="cover-{{ uid }}",vId="viewer-{{ uid }}",cvId="the-canvas-{{ uid }}",bId="btn-{{ uid }}",btId="btn-text-{{ uid }}",fn="initPdf_{{ uid | replace: '-','_' }}";
window[fn]=async function(){
const b=document.getElementById(bId),bt=document.getElementById(btId);b.disabled=true;bt.innerText="载入中...";
if(typeof pdfjsLib==='undefined'){const s=document.createElement('script');s.src='/assets/pdf.min.js';document.head.appendChild(s);s.onload=()=>{pdfjsLib.GlobalWorkerOptions.workerSrc='/assets/pdf.worker.min.js';run()}}else{run()}};
let pdf=null,pn=1,rendering=false,pnPend=null,cv,ctx,first=true;
function run(){cv=document.getElementById(cvId);ctx=cv.getContext('2d');pdfjsLib.getDocument(u).promise.then(p=>{pdf=p;document.getElementById('page_count-{{ uid }}').textContent=pdf.numPages;ren(pn);document.getElementById('prev-{{ uid }}').addEventListener('click',onP);document.getElementById('next-{{ uid }}').addEventListener('click',onN);document.getElementById('fullscreen-{{ uid }}').addEventListener('click',togF);window.addEventListener('resize',()=>{clearTimeout(window.rt);window.rt=setTimeout(()=>{if(pdf)ren(pn)},100)})}).catch(e=>{console.error(e);const bt=document.getElementById(btId);bt.innerText="加载失败";})}
function ren(n){rendering=true;pdf.getPage(n).then(p=>{
const w=document.getElementById(wId).clientWidth,vp=p.getViewport({scale:1}),s=w/vp.width,svp=p.getViewport({scale:s});
cv.height=svp.height;cv.width=svp.width;
p.render({canvasContext:ctx,viewport:svp}).promise.then(()=>{rendering=false;
if(first){document.getElementById(cId).style.display='none';const v=document.getElementById(vId);v.style.display='flex';setTimeout(()=>v.style.opacity=1,10);first=false;}
if(pnPend!==null){ren(pnPend);pnPend=null}})}).catch(e=>{rendering=false})}
function qRen(n){if(rendering){pnPend=n}else{ren(n)}}
function onP(){if(pn<=1)return;pn--;qRen(pn)}
function onN(){if(pn>=pdf.numPages)return;pn++;qRen(pn)}
function togF(){const e=document.getElementById(wId);!document.fullscreenElement?e.requestFullscreen().catch(console.log):document.exitFullscreen()}
})();
</script>