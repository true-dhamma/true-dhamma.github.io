<!-- tts-reader.html -->
<!-- 放置在 Jekyll 的 _includes 文件夹下 -->
<!-- 使用方式: 在需要的地方插入 {% include tts-reader.html %} -->

<span class="tts-button-wrapper" id="tts-button-wrapper" style="display: none;">
  <button id="tts-toggle-btn" class="tts-button" aria-label="朗读文章">
    <svg class="tts-icon" id="tts-play-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"></path></svg>
    <svg class="tts-icon" id="tts-pause-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" style="display: none;"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"></path></svg>
  </button>
</span>

<style>
  .tts-button-wrapper {
    display: inline-flex; /* 改为内联元素 */
    vertical-align: middle; /* 垂直居中对齐文本 */
    margin-left: 8px; /* 和前面的元素保持一点距离 */
  }
  .tts-button {
    display: flex;
    justify-content: center;
    align-items: center;
    width: 28px;  /* 缩小尺寸以适应内联 */
    height: 28px;
    border: 1px solid #ccc;
    background-color: transparent;
    border-radius: 50%;
    cursor: pointer;
    padding: 0;
    transition: background-color 0.2s ease-in-out, transform 0.1s ease;
  }
  .tts-button:hover {
    background-color: #f0f0f0;
  }
  .tts-button:active {
    transform: scale(0.9);
  }
  .tts-icon {
    fill: #555;
    width: 16px; /* 配合按钮缩小图标 */
    height: 16px;
  }
</style>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const synth = window.speechSynthesis;
  if (!synth) {
    console.warn('浏览器不支持 Web Speech API。');
    return;
  }

  // --- DOM Element References ---
  const wrapper = document.getElementById('tts-button-wrapper');
  const toggleBtn = document.getElementById('tts-toggle-btn');
  const playIcon = document.getElementById('tts-play-icon');
  const pauseIcon = document.getElementById('tts-pause-icon');
  const article = document.querySelector('article');

  if (!article) return;

  // --- Text Extraction ---
  let textToRead = '';
  try {
    const readableElements = article.querySelectorAll('p, h1, h2, h3, h4, li, blockquote, figcaption');
    textToRead = Array.from(readableElements).map(el => el.innerText.trim()).join('. ').replace(/\s+/g, ' ');
  } catch (e) {
    console.error("提取文章文本时出错:", e);
    return;
  }
  
  if (!textToRead.trim()) return;

  // --- UI State Management ---
  const setStoppedUI = () => {
    playIcon.style.display = 'block';
    pauseIcon.style.display = 'none';
    toggleBtn.setAttribute('aria-label', '朗读文章');
  };
  
  const setPlayingUI = () => {
    playIcon.style.display = 'none';
    pauseIcon.style.display = 'block';
    toggleBtn.setAttribute('aria-label', '停止朗读');
  };

  // --- Speech Synthesis Setup ---
  const utterance = new SpeechSynthesisUtterance(textToRead);
  const pageLang = document.documentElement.lang || 'zh-CN';
  utterance.lang = pageLang;
  
  utterance.onend = setStoppedUI;
  utterance.onerror = (event) => {
    console.error('朗读发生错误:', event);
    setStoppedUI();
  };

  // --- Voice Selection Logic ---
  let preferredVoice = null;
  const userAgent = navigator.userAgent;
  const isEdge = userAgent.includes("Edg/");
  const isSafari = userAgent.includes('Safari') && !userAgent.includes('Chrome');

  const selectVoice = () => {
    const voices = synth.getVoices().filter(v => v.lang.startsWith(pageLang.slice(0, 2)));
    if (voices.length === 0) return;

    // 1. Edge: 优先寻找 Xiaoxiao 和 Yunyang
    if (isEdge) {
      const edgePriorityVoices = ['xiaoxiao', 'yunyang'];
      for (const name of edgePriorityVoices) {
        const found = voices.find(v => v.name.toLowerCase().includes(name));
        if (found) {
          preferredVoice = found;
          return;
        }
      }
    }
    
    // 2. Safari: 优先寻找指定语音
    if (isSafari) {
      const safariPriorityVoices = ['ting-ting', 'li-mu', 'yu-shu', 'siri'];
       for (const name of safariPriorityVoices) {
        const found = voices.find(v => v.name.toLowerCase().includes(name));
        if (found) {
          preferredVoice = found;
          return;
        }
      }
    }

    // 3. 通用备选: 寻找任何高质量的在线语音 (Neural)
    const neuralVoice = voices.find(v => v.name.includes('Neural') && v.localService === false);
    if (neuralVoice) {
      preferredVoice = neuralVoice;
      return;
    }

    // 4. 最终备选: 使用找到的第一个匹配语言的语音
    preferredVoice = voices[0];
  };

  synth.onvoiceschanged = selectVoice;
  selectVoice(); // Call once in case voices are already loaded

  // --- Event Listener for the single button ---
  toggleBtn.addEventListener('click', () => {
    // 如果正在说话或暂停，则停止
    if (synth.speaking || synth.paused) {
      synth.cancel(); // onend 事件会自动触发，并调用 setStoppedUI
    } else {
      // 如果没有在说话，则开始
      if (preferredVoice) {
        utterance.voice = preferredVoice;
      }
      synth.speak(utterance);
      setPlayingUI();
    }
  });
  
  // Stop speaking when the user navigates away
  window.addEventListener('beforeunload', () => {
    synth.cancel();
  });

  // Everything is ready, show the button.
  wrapper.style.display = 'inline-flex';
});
</script>