<!-- tts-reader-floating.html -->
<!-- 放置在 Jekyll 的 _includes 文件夹下 -->
<!-- 设计为右下角固定浮窗 -->

<div class="tts-reader-fixed-container" id="tts-reader-container" style="display: none;">
  <button id="tts-play-pause-btn" class="tts-button" aria-label="朗读">
    <svg class="tts-icon" id="tts-play-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"></path></svg>
    <svg class="tts-icon" id="tts-pause-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" style="display: none;"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"></path></svg>
  </button>
</div>

<style>
  .tts-reader-fixed-container {
    position: fixed;
    bottom: 30px;
    right: 30px;
    z-index: 1000; /* 确保在顶层 */
  }
  .tts-button {
    display: flex;
    justify-content: center;
    align-items: center;
    width: 50px; /* 调整尺寸 */
    height: 50px; /* 调整尺寸 */
    border: 1px solid #ccc;
    background-color: #f8f8f8;
    border-radius: 50%;
    cursor: pointer;
    padding: 0;
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    transition: background-color 0.2s ease-in-out, transform 0.1s ease;
  }
  .tts-button:hover {
    background-color: #e9e9e9;
  }
  .tts-button:active {
    transform: scale(0.92);
  }
  .tts-icon {
    fill: #333;
    width: 24px; /* 相应调整图标尺寸 */
    height: 24px;
  }
  /* 朗读时高亮当前元素 */
  .tts-highlight {
    background-color: #fef8e0; /* 一个柔和的黄色高亮 */
    scroll-margin-top: 20px; /* 滚动到视图时顶部留白 */
    transition: background-color 0.3s;
  }
</style>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const synth = window.speechSynthesis;
  if (!synth) {
    console.warn('浏览器不支持 Web Speech API。');
    return;
  }

  const container = document.getElementById('tts-reader-container');
  const playPauseBtn = document.getElementById('tts-play-pause-btn');
  const playIcon = document.getElementById('tts-play-icon');
  const pauseIcon = document.getElementById('tts-pause-icon');
  const article = document.querySelector('article');

  if (!article) return;

  // --- 状态管理 ---
  let isReading = false;
  let isPaused = false;
  let utteranceQueue = [];
  let currentUtteranceIndex = 0;
  let preferredVoice = null;
  let currentlyHighlightedElement = null;
  let voiceTries = 0;

  // --- UI 更新 ---
  const updateUI = () => {
    if (isReading && !isPaused) { // 正在播放
      playIcon.style.display = 'none';
      pauseIcon.style.display = 'inline-block';
      playPauseBtn.setAttribute('aria-label', '暂停');
    } else { // 暂停或停止状态
      playIcon.style.display = 'inline-block';
      pauseIcon.style.display = 'none';
      playPauseBtn.setAttribute('aria-label', isPaused ? '继续朗读' : '朗读');
    }
  };
  
  // --- 高亮处理 ---
  const clearHighlight = () => {
    if (currentlyHighlightedElement) {
      currentlyHighlightedElement.classList.remove('tts-highlight');
      currentlyHighlightedElement = null;
    }
  };

  const highlightElement = (element) => {
    clearHighlight();
    if (element) {
      element.classList.add('tts-highlight');
      currentlyHighlightedElement = element;
      element.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
  };

  // --- 语音合成核心逻辑 ---
  const playNext = () => {
    if (isPaused) return; // 如果在调用 playNext 的间隙被暂停了，则直接返回
    if (currentUtteranceIndex >= utteranceQueue.length) {
      stopReading();
      return;
    }

    const { utterance, element } = utteranceQueue[currentUtteranceIndex];
    
    utterance.onstart = () => highlightElement(element);
    utterance.onend = () => {
      currentUtteranceIndex++;
      playNext();
    };
    utterance.onerror = (event) => {
      console.error('朗读发生错误:', event);
      stopReading();
    };
    
    synth.speak(utterance);
  };

  const startReading = () => {
    // 检查语音是否已就绪，如果还没选好，等待一下再试
    if (!preferredVoice) {
      console.log("语音未就绪，稍后重试...");
      selectVoice(); // 再次尝试选择
      setTimeout(startReading, 200);
      return;
    }
    
    // 如果之前是暂停状态，直接恢复
    if (synth.speaking && synth.paused) {
        isPaused = false;
        synth.resume();
        highlightElement(utteranceQueue[currentUtteranceIndex].element);
        updateUI();
        return;
    }

    synth.cancel(); // 开始前清除之前的队列
    isReading = true;
    isPaused = false;
    currentUtteranceIndex = 0;
    
    utteranceQueue.forEach(item => item.utterance.voice = preferredVoice);
    
    playNext();
    updateUI();
  };
  
  const pauseReading = () => {
    isPaused = true;
    synth.pause();
    clearHighlight();
    updateUI();
  };

  const stopReading = () => {
    isReading = false;
    isPaused = false;
    synth.cancel();
    clearHighlight();
    updateUI();
  };

  // --- 语音选择 (针对iOS优化) ---
  const selectVoice = () => {
    const voices = synth.getVoices();
    if (voices.length === 0) {
        // iOS等设备可能需要多次尝试
        if(voiceTries < 5) {
            voiceTries++;
            setTimeout(selectVoice, 200);
        }
        return;
    }

    const pageLang = document.documentElement.lang || 'zh-CN';
    const langPrefix = pageLang.split('-')[0].toLowerCase(); // 'zh'
    
    const userAgent = navigator.userAgent;
    const isEdge = /Edg\//.test(userAgent);
    const isMacOrIOS = /Mac|iPod|iPhone|iPad/.test(navigator.platform);

    let voiceChecks = [];
    const lowerCaseVoices = voices.map(v => ({...v, nameLower: v.name.toLowerCase(), langLower: v.lang.toLowerCase()}));

    // 优先规则 (名称匹配不区分大小写)
    if (isEdge) {
      voiceChecks.push(v => v.langLower.startsWith(langPrefix) && v.nameLower.includes('xiaoxiao online'));
      voiceChecks.push(v => v.langLower.startsWith(langPrefix) && v.nameLower.includes('yunyang online'));
    }
    if (isMacOrIOS) {
      voiceChecks.push(v => v.langLower.startsWith(langPrefix) && v.nameLower.includes('siri'));
      voiceChecks.push(v => v.langLower.startsWith(langPrefix) && v.nameLower.includes('yushu'));
      voiceChecks.push(v => v.langLower.startsWith(langPrefix) && v.nameLower.includes('li-mu'));
      voiceChecks.push(v => v.langLower.startsWith(langPrefix) && v.nameLower.includes('ting-ting'));
    }

    // 通用后备规则
    voiceChecks.push(v => v.langLower.startsWith(langPrefix) && (v.localService === false || v.nameLower.includes('online') || v.nameLower.includes('neural')));
    voiceChecks.push(v => v.langLower.startsWith(langPrefix));

    for (const check of voiceChecks) {
      const foundVoice = lowerCaseVoices.find(check);
      if (foundVoice) {
        // 从原始voices数组中获取实例
        preferredVoice = voices.find(v => v.name === foundVoice.name);
        console.log('TTS Voice Selected:', preferredVoice.name);
        
        // 成功选择语音后，显示按钮
        container.style.display = 'block';
        return; // 找到后立刻退出
      }
    }
  };

  // --- 事件监听 ---
  playPauseBtn.addEventListener('click', () => {
    if (!isReading || isPaused) {
      startReading();
    } else {
      pauseReading();
    }
  });

  window.addEventListener('beforeunload', stopReading);

  // --- 初始化 ---
  const initializeReader = () => {
    const textElements = article.querySelectorAll('p, h1, h2, h3, h4, h5, h6, li, blockquote, figcaption');
    const pageLang = document.documentElement.lang || 'zh-CN';

    textElements.forEach(el => {
      const text = el.innerText.trim();
      if (text) {
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.lang = pageLang;
        utteranceQueue.push({ utterance, element: el });
      }
    });

    if (utteranceQueue.length === 0) {
      return; // 如果没有可读内容，不执行任何操作
    }
    
    // 尝试加载语音，这是入口点
    selectVoice();
    if (synth.onvoiceschanged !== undefined) {
      synth.onvoiceschanged = selectVoice;
    }
    
    updateUI();
  };

  initializeReader();
});
</script>