<!-- tts-fab-reader.html (v3 - iOS-Optimized) -->
<!-- 浮动操作按钮 (FAB) 形式的 TTS 阅读器 -->
<!-- 放置在 Jekyll 的 _includes 文件夹下 -->

<div class="tts-fab-container" id="tts-fab-container" style="display: none;">
  <button id="tts-play-pause-btn" class="tts-button" aria-label="朗读文章">
    <svg class="tts-icon" id="tts-play-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"></path></svg>
    <svg class="tts-icon" id="tts-pause-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" style="display: none;"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"></path></svg>
  </button>
</div>

<style>
  /* 样式部分保持不变 */
  .tts-fab-container{position:fixed;bottom:30px;right:30px;z-index:1000;}.tts-button{display:flex;justify-content:center;align-items:center;width:50px;height:50px;border:none;background-color:#fff;border-radius:50%;cursor:pointer;padding:0;box-shadow:0 4px 12px rgba(0,0,0,.15);transition:background-color .2s ease-in-out,transform .2s ease}.tts-button:hover{background-color:#f2f2f2;transform:translateY(-2px)}.tts-button:active{transform:scale(.95)}.tts-icon{fill:#333;width:24px;height:24px}.tts-highlight{background-color:#fef8e0;scroll-margin-top:40px;transition:background-color .3s ease}
</style>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const synth = window.speechSynthesis;
  if (!synth) {
    console.warn('浏览器不支持 Web Speech API。');
    return;
  }

  const container = document.getElementById('tts-fab-container');
  const playPauseBtn = document.getElementById('tts-play-pause-btn');
  const playIcon = document.getElementById('tts-play-icon');
  const pauseIcon = document.getElementById('tts-pause-icon');
  const article = document.querySelector('article');

  if (!article) return;

  let isReading = false, isPaused = false, utteranceQueue = [],
      currentUtteranceIndex = 0, preferredVoice = null,
      currentlyHighlightedElement = null;

  const updateUI = () => {
    if (isReading && !isPaused) {
      playIcon.style.display = 'none';
      pauseIcon.style.display = 'inline-block';
      playPauseBtn.setAttribute('aria-label', '暂停');
    } else {
      playIcon.style.display = 'inline-block';
      pauseIcon.style.display = 'none';
      playPauseBtn.setAttribute('aria-label', isPaused ? '继续朗读' : '朗读文章');
    }
  };
  
  const clearHighlight = () => {
    if (currentlyHighlightedElement) {
      currentlyHighlightedElement.classList.remove('tts-highlight');
      currentlyHighlightedElement = null;
    }
  };
  const highlightElement = (element) => {
    clearHighlight();
    if (element) {
      element.classList.add('tts-highlight');
      currentlyHighlightedElement = element;
      element.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
  };

  const playNext = () => {
    if (currentUtteranceIndex >= utteranceQueue.length) { stopReading(); return; }
    const { utterance, element } = utteranceQueue[currentUtteranceIndex];
    utterance.voice = preferredVoice;
    utterance.onstart = () => highlightElement(element);
    utterance.onend = () => { currentUtteranceIndex++; playNext(); };
    utterance.onerror = (e) => { console.error('朗读错误:', e); stopReading(); };
    synth.speak(utterance);
  };
  
  const startReading = () => {
    // 关键修复：如果在播放时仍未选定语音，则立即再次尝试获取。
    // 这对于修复iOS语音加载延迟问题至关重要。
    if (!preferredVoice) {
      preferredVoice = getBestVoice();
    }

    // 如果仍然没有，说明语音服务有问题，稍后重试。
    if (!preferredVoice) {
      console.warn("语音服务尚未就绪, 150ms后重试...");
      setTimeout(startReading, 150);
      return;
    }
    
    isReading = true; isPaused = false; currentUtteranceIndex = 0;
    updateUI();
    playNext();
  };

  const stopReading = () => {
    isReading = false; isPaused = false;
    synth.cancel(); clearHighlight(); updateUI();
  };
  
  // --- 全新重构的语音选择函数 ---
  const getBestVoice = () => {
    const voices = synth.getVoices();
    if (voices.length === 0) return null;

    const pageLang = document.documentElement.lang || 'zh-CN';
    const langPrefix = pageLang.split('-')[0];

    const userAgent = navigator.userAgent;
    const isIOS = /iPad|iPhone|iPod/.test(userAgent) && !window.MSStream;
    const isEdgeiOS = isIOS && /EdgiOS/.test(userAgent);
    const isSafariiOS = isIOS && !isEdgeiOS;

    const voiceChecks = [];

    // 检查函数，使用更稳健的小写关键词匹配
    const createCheck = (lang, keywords) => (v) => {
        const vName = v.name.toLowerCase();
        return v.lang.startsWith(lang) && keywords.every(kw => vName.includes(kw));
    };

    // 优先级 1: iOS Edge -> 微软在线语音
    if (isEdgeiOS) {
      voiceChecks.push(createCheck(langPrefix, ['microsoft', 'xiaoxiao', 'online']));
      voiceChecks.push(createCheck(langPrefix, ['microsoft', 'yunyang', 'online']));
    }
    
    // 优先级 2: iOS Safari -> 苹果自带优质语音
    if (isSafariiOS) {
      voiceChecks.push(createCheck(langPrefix, ['siri']));
      voiceChecks.push(createCheck(langPrefix, ['yushu'])); // 语舒
      voiceChecks.push(createCheck(langPrefix, ['li-mu'])); // Li-mu
      voiceChecks.push(createCheck(langPrefix, ['ting-ting'])); // 婷婷
    }
    
    // 优先级 3: 非iOS的Edge (桌面版)
    if (!isIOS && /Edg\//.test(userAgent)) {
        voiceChecks.push(createCheck(langPrefix, ['microsoft', 'xiaoxiao', 'online']));
        voiceChecks.push(createCheck(langPrefix, ['microsoft', 'yunyang', 'online']));
    }

    // 优先级 4: 通用后备 -> 任何在线/Neural语音
    voiceChecks.push((v) => v.lang.startsWith(langPrefix) && (v.localService === false || v.name.toLowerCase().includes('online') || v.name.toLowerCase().includes('neural')));

    // 优先级 5: 最终后备 -> 任何匹配语言的语音 (包括Windows本地等)
    voiceChecks.push((v) => v.lang.startsWith(langPrefix));

    // 遍历检查队列，返回第一个匹配的语音
    for (const check of voiceChecks) {
      const found = voices.find(check);
      if (found) {
        console.log("TTS Voice Selected:", found.name);
        return found;
      }
    }
    return null; // 如果没有任何匹配
  };
  
  const findAndSetVoice = () => {
      preferredVoice = getBestVoice();
  };

  playPauseBtn.addEventListener('click', () => {
    if (!synth.speaking && !isPaused) { // 初始播放
      startReading();
    } else if (synth.paused) { // 恢复播放
      isPaused = false;
      synth.resume();
      highlightElement(utteranceQueue[currentUtteranceIndex].element);
      updateUI();
    } else { // 暂停
      isPaused = true;
      synth.pause();
      clearHighlight();
      updateUI();
    }
  });

  window.addEventListener('beforeunload', stopReading);

  const initializeReader = () => {
    const textElements = article.querySelectorAll('p,h1,h2,h3,h4,h5,h6,li,blockquote,figcaption');
    const pageLang = document.documentElement.lang || 'zh-CN';

    utteranceQueue = Array.from(textElements)
      .map(el => {
        const text = el.innerText.trim();
        if (!text) return null;
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.lang = pageLang;
        return { utterance, element: el };
      })
      .filter(Boolean);

    if (utteranceQueue.length === 0) return;

    if (synth.onvoiceschanged !== undefined) {
      synth.onvoiceschanged = findAndSetVoice;
    }
    findAndSetVoice(); // 首次尝试加载

    container.style.display = 'block';
    updateUI();
  };

  initializeReader();
});
</script>