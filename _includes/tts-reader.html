<!-- tts-fab-reader.html -->
<!-- 浮动操作按钮 (FAB) 形式的 TTS 阅读器 -->
<!-- 放置在 Jekyll 的 _includes 文件夹下 -->

<div class="tts-fab-container" id="tts-fab-container" style="display: none;">
  <button id="tts-play-pause-btn" class="tts-button" aria-label="朗读文章">
    <svg class="tts-icon" id="tts-play-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"></path></svg>
    <svg class="tts-icon" id="tts-pause-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" style="display: none;"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"></path></svg>
  </button>
</div>

<style>
  /* 样式部分保持不变，故省略以保持简洁 */
  .tts-fab-container {
    position: fixed; bottom: 30px; right: 30px; z-index: 1000;
  }
  .tts-button {
    display: flex; justify-content: center; align-items: center;
    width: 50px; height: 50px; border: none; background-color: #ffffff;
    border-radius: 50%; cursor: pointer; padding: 0;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    transition: background-color 0.2s ease-in-out, transform 0.2s ease;
  }
  .tts-button:hover {
    background-color: #f2f2f2; transform: translateY(-2px);
  }
  .tts-button:active { transform: scale(0.95); }
  .tts-icon { fill: #333; width: 24px; height: 24px; }
  .tts-highlight {
    background-color: #fef8e0; scroll-margin-top: 40px;
    transition: background-color 0.3s ease;
  }
</style>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const synth = window.speechSynthesis;
  if (!synth) {
    console.warn('浏览器不支持 Web Speech API。');
    return;
  }

  // --- DOM 元素引用 ---
  const container = document.getElementById('tts-fab-container');
  const playPauseBtn = document.getElementById('tts-play-pause-btn');
  const playIcon = document.getElementById('tts-play-icon');
  const pauseIcon = document.getElementById('tts-pause-icon');
  const article = document.querySelector('article');

  if (!article) { return; }

  // --- 状态管理 ---
  let isReading = false, isPaused = false, utteranceQueue = [],
      currentUtteranceIndex = 0, preferredVoice = null,
      currentlyHighlightedElement = null;

  // --- UI 更新 ---
  const updateUI = () => {
    if (isReading && !isPaused) {
      playIcon.style.display = 'none';
      pauseIcon.style.display = 'inline-block';
      playPauseBtn.setAttribute('aria-label', '暂停');
    } else {
      playIcon.style.display = 'inline-block';
      pauseIcon.style.display = 'none';
      playPauseBtn.setAttribute('aria-label', isPaused ? '继续朗读' : '朗读文章');
    }
  };
  
  // --- 高亮处理 ---
  const clearHighlight = () => {
    if (currentlyHighlightedElement) {
      currentlyHighlightedElement.classList.remove('tts-highlight');
      currentlyHighlightedElement = null;
    }
  };
  const highlightElement = (element) => {
    clearHighlight();
    if (element) {
      element.classList.add('tts-highlight');
      currentlyHighlightedElement = element;
      element.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
  };

  // --- 语音合成核心逻辑 ---
  const playNext = () => {
    if (currentUtteranceIndex >= utteranceQueue.length) { stopReading(); return; }
    const { utterance, element } = utteranceQueue[currentUtteranceIndex];
    utterance.onstart = () => highlightElement(element);
    utterance.onend = () => { currentUtteranceIndex++; playNext(); };
    utterance.onerror = (e) => { console.error('朗读错误:', e); stopReading(); };
    synth.speak(utterance);
  };
  const startReading = () => {
    if (!preferredVoice) { setTimeout(startReading, 100); return; }
    isReading = true; isPaused = false; currentUtteranceIndex = 0;
    utteranceQueue.forEach(item => item.utterance.voice = preferredVoice);
    playNext(); updateUI();
  };
  const stopReading = () => {
    isReading = false; isPaused = false;
    synth.cancel(); clearHighlight(); updateUI();
  };

  // --- 语音选择 (已为 iOS 优化) ---
  const selectVoice = () => {
    const voices = synth.getVoices();
    if (voices.length === 0) return;

    const pageLang = document.documentElement.lang || 'zh-CN';
    const langPrefix = pageLang.split('-')[0]; // e.g. 'zh'
    
    // --- 更精准的平台与浏览器检测 ---
    const userAgent = navigator.userAgent;
    const platform = navigator.platform;
    const isApplePlatform = /Mac|iPod|iPhone|iPad/.test(platform);
    // 精准识别 Edge (桌面版和iOS版)
    const isEdge = /Edg|EdgiOS\//.test(userAgent);

    let voiceChecks = [];

    // --- 智能构建语音优先级队列 ---

    // 优先级 1: 如果是Edge浏览器 (桌面或iOS)，优先选择微软在线语音
    if (isEdge) {
      voiceChecks.push(v => v.lang.startsWith(langPrefix) && v.name.includes('Microsoft Xiaoxiao Online'));
      voiceChecks.push(v => v.lang.startsWith(langPrefix) && v.name.includes('Microsoft Yunyang Online'));
    }

    // 优先级 2: 如果是苹果设备 (Mac/iOS)，优先选择苹果优质语音 (Siri等)
    // 这个逻辑在非Edge的苹果浏览器上 (如Safari) 会被优先执行
    if (isApplePlatform) {
      voiceChecks.push(v => v.lang.startsWith(langPrefix) && v.name.includes('Siri'));
      voiceChecks.push(v => v.lang.startsWith(langPrefix) && v.name.toLowerCase().includes('yushu')); // 语舒
      voiceChecks.push(v => v.lang.startsWith(langPrefix) && v.name.toLowerCase().includes('li-mu')); // Li-mu
      voiceChecks.push(v => v.lang.startsWith(langPrefix) && v.name.toLowerCase().includes('ting-ting')); // 婷婷
    }

    // 优先级 3: 通用后备方案 - 寻找任何高质量的在线语音
    voiceChecks.push(v => v.lang.startsWith(langPrefix) && (v.localService === false || v.name.includes('Online') || v.name.includes('Neural')));
    
    // 优先级 4: 最终后备方案 - 寻找任何匹配语言的本地语音 (包括Windows)
    voiceChecks.push(v => v.lang.startsWith(langPrefix));

    // --- 遍历队列，找到第一个匹配的语音 ---
    for (const check of voiceChecks) {
      const foundVoice = voices.find(check);
      if (foundVoice) {
        preferredVoice = foundVoice;
        console.log('TTS Voice Selected:', preferredVoice.name, preferredVoice);
        return; // 找到后立即退出
      }
    }
  };

  // --- 事件监听 ---
  playPauseBtn.addEventListener('click', () => {
    if (!isReading) {
      startReading();
    } else if (isPaused) {
      isPaused = false;
      synth.resume();
      highlightElement(utteranceQueue[currentUtteranceIndex].element);
      updateUI();
    } else {
      isPaused = true;
      synth.pause();
      clearHighlight();
      updateUI();
    }
  });
  window.addEventListener('beforeunload', stopReading);

  // --- 初始化 ---
  const initializeReader = () => {
    const textElements = article.querySelectorAll('p, h1, h2, h3, h4, h5, h6, li, blockquote, figcaption');
    if (textElements.length === 0) return;

    const pageLang = document.documentElement.lang || 'zh-CN';
    utteranceQueue = Array.from(textElements).map(el => {
        const text = el.innerText.trim();
        if (!text) return null;
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.lang = pageLang;
        return { utterance, element: el };
    }).filter(Boolean); // 过滤掉空文本的元素

    if (utteranceQueue.length === 0) return;
    
    // 'voiceschanged' 事件对于动态加载语音至关重要
    if (synth.onvoiceschanged !== undefined) {
      synth.onvoiceschanged = selectVoice;
    }
    selectVoice(); // 立即调用一次，以防语音已加载
    
    container.style.display = 'block';
    updateUI();
  };

  initializeReader();
});
</script>