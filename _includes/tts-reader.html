<!-- tts-reader.html -->
<!-- 拥有进度条、内容高亮和高级设置的Jekyll朗读器 -->

<div class="tts-reader" id="tts-reader-container" style="visibility: hidden;">
  <div class="tts-main-controls">
    <button id="tts-play-pause-btn" class="tts-button" aria-label="朗读文章">
      <svg class="tts-icon" id="tts-play-icon" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"></path></svg>
      <svg class="tts-icon" id="tts-pause-icon" viewBox="0 0 24 24" style="display: none;"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"></path></svg>
    </button>
    <button id="tts-stop-btn" class="tts-button" aria-label="停止朗读" style="display: none;">
      <svg class="tts-icon" id="tts-stop-icon" viewBox="0 0 24 24"><path d="M6 6h12v12H6z"></path></svg>
    </button>
    <div class="tts-progress-bar-container">
      <div id="tts-progress-bar" class="tts-progress-bar"></div>
    </div>
    <button id="tts-settings-btn" class="tts-button" aria-label="设置">
      <svg class="tts-icon" id="tts-settings-icon" viewBox="0 0 24 24"><path d="M19.43 12.98c.04-.32.07-.64.07-.98s-.03-.66-.07-.98l2.11-1.65c.19-.15.24-.42.12-.64l-2-3.46c-.12-.22-.39-.3-.61-.22l-2.49 1c-.52-.4-1.08-.73-1.69-.98l-.38-2.65C14.46 2.18 14.25 2 14 2h-4c-.25 0-.46.18-.49.42l-.38 2.65c-.61.25-1.17.59-1.69.98l-2.49-1c-.23-.09-.49 0-.61.22l-2 3.46c-.13.22-.07.49.12.64l2.11 1.65c-.04.32-.07.65-.07.98s.03.66.07.98l-2.11 1.65c-.19.15-.24.42-.12.64l2 3.46c.12.22.39.3.61.22l2.49-1c.52.4 1.08.73 1.69.98l.38 2.65c.03.24.24.42.49.42h4c.25 0 .46-.18.49-.42l.38-2.65c.61-.25 1.17-.59 1.69-.98l2.49 1c.23.09.49 0 .61-.22l2-3.46c.12-.22.07-.49-.12-.64l-2.11-1.65zM12 15.5c-1.93 0-3.5-1.57-3.5-3.5s1.57-3.5 3.5-3.5 3.5 1.57 3.5 3.5-1.57 3.5-3.5 3.5z"></path></svg>
    </button>
  </div>
  <div id="tts-settings-panel" class="tts-settings-panel">
    <div class="tts-setting">
      <label for="tts-voice-select">语音:</label>
      <select id="tts-voice-select"></select>
    </div>
    <div class="tts-setting">
      <label for="tts-rate-slider">语速:</label>
      <input type="range" id="tts-rate-slider" min="0.5" max="2" step="0.1" value="1">
      <span id="tts-rate-value">1.0x</span>
    </div>
  </div>
</div>

<style>
  .tts-reader {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    background-color: #fff;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1), 0 0 0 1px rgba(0,0,0,0.05);
    padding: 8px;
    margin: 20px auto;
    width: fit-content;
    max-width: 90%;
    transition: all 0.3s ease;
  }
  .tts-main-controls {
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .tts-button {
    display: inline-flex; justify-content: center; align-items: center;
    width: 36px; height: 36px;
    border: none; background-color: #f0f0f0;
    border-radius: 50%; cursor: pointer; padding: 0;
    transition: background-color 0.2s ease;
  }
  .tts-button:hover { background-color: #e0e0e0; }
  .tts-icon { fill: #333; width: 20px; height: 20px; }

  .tts-progress-bar-container {
    flex-grow: 1;
    height: 6px;
    background-color: #eee;
    border-radius: 3px;
    overflow: hidden;
    margin: 0 5px;
  }
  .tts-progress-bar {
    width: 0%;
    height: 100%;
    background-color: #007bff;
    transition: width 0.2s linear;
  }
  
  .tts-settings-panel {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.3s ease-out, padding-top 0.3s ease-out;
    padding-top: 0;
  }
  .tts-settings-panel.open {
    max-height: 200px; /* Adjust as needed */
    padding-top: 10px;
  }
  .tts-setting {
    display: flex;
    align-items: center;
    margin-bottom: 8px;
    font-size: 14px;
  }
  .tts-setting label { margin-right: 8px; color: #555; }
  .tts-setting select, .tts-setting input { flex-grow: 1; }
  #tts-rate-value { width: 40px; text-align: right; color: #555; }
  #tts-voice-select {
    border: 1px solid #ccc;
    border-radius: 4px;
    padding: 4px;
    background-color: #fff;
  }

  /* Highlighting style for currently spoken element */
  .tts-highlight {
    background-color: #fffde7 !important; /* Use !important to override theme styles */
    transition: background-color 0.3s ease;
    box-shadow: 0 0 0 2px #ffc107;
    border-radius: 4px;
    scroll-margin-top: 20px; /* For scrollIntoView behavior */
  }
</style>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const synth = window.speechSynthesis;
  if (!synth) {
    console.warn('Web Speech API not supported.');
    return;
  }

  // --- DOM Elements ---
  const container = document.getElementById('tts-reader-container');
  const playPauseBtn = document.getElementById('tts-play-pause-btn');
  const stopBtn = document.getElementById('tts-stop-btn');
  const playIcon = document.getElementById('tts-play-icon');
  const pauseIcon = document.getElementById('tts-pause-icon');
  const progressBar = document.getElementById('tts-progress-bar');
  const settingsBtn = document.getElementById('tts-settings-btn');
  const settingsPanel = document.getElementById('tts-settings-panel');
  const voiceSelect = document.getElementById('tts-voice-select');
  const rateSlider = document.getElementById('tts-rate-slider');
  const rateValue = document.getElementById('tts-rate-value');
  const article = document.querySelector('article');

  if (!article) return;

  // --- State ---
  let utterances = [];
  let currentUtteranceIndex = 0;
  let currentHighlightElement = null;

  // --- Text & Utterance Preparation ---
  const prepareUtterances = () => {
    const readableElements = article.querySelectorAll('p, h1, h2, h3, h4, h5, h6, li, blockquote, figcaption');
    utterances = Array.from(readableElements).map(el => {
      const text = el.innerText.trim();
      if (text) {
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.sourceElement = el; // Link utterance to its DOM element
        return utterance;
      }
      return null;
    }).filter(Boolean);
  };

  // --- UI Update Functions ---
  const updateUI = (state) => {
    if (state === 'playing') {
      playIcon.style.display = 'none'; pauseIcon.style.display = 'inline-block';
      stopBtn.style.display = 'inline-flex';
      playPauseBtn.setAttribute('aria-label', '暂停朗读');
    } else if (state === 'paused') {
      playIcon.style.display = 'inline-block'; pauseIcon.style.display = 'none';
      playPauseBtn.setAttribute('aria-label', '继续朗读');
    } else { // 'stopped'
      playIcon.style.display = 'inline-block'; pauseIcon.style.display = 'none';
      stopBtn.style.display = 'none';
      playPauseBtn.setAttribute('aria-label', '朗读文章');
      progressBar.style.width = '0%';
      if (currentHighlightElement) {
        currentHighlightElement.classList.remove('tts-highlight');
        currentHighlightElement = null;
      }
    }
  };
  
  const updateProgress = () => {
      const progress = utterances.length > 0 ? (currentUtteranceIndex / utterances.length) * 100 : 0;
      progressBar.style.width = `${progress}%`;
  };

  // --- Highlighting Logic ---
  const highlightCurrentElement = (element) => {
    if (currentHighlightElement) {
      currentHighlightElement.classList.remove('tts-highlight');
    }
    element.classList.add('tts-highlight');
    element.scrollIntoView({ behavior: 'smooth', block: 'center' });
    currentHighlightElement = element;
  };

  // --- Core Player Logic ---
  const play = () => {
    if (utterances.length === 0) return;
    synth.cancel(); // Clear queue
    currentUtteranceIndex = 0;
    speakNext();
  };
  
  const speakNext = () => {
    if (currentUtteranceIndex >= utterances.length) {
      updateUI('stopped');
      return;
    }
    
    const utterance = utterances[currentUtteranceIndex];
    const settings = getSettings();
    utterance.voice = settings.voice;
    utterance.rate = settings.rate;
    utterance.lang = document.documentElement.lang || 'zh-CN';

    utterance.onstart = () => {
      updateUI('playing');
      highlightCurrentElement(utterance.sourceElement);
      updateProgress();
    };

    utterance.onend = () => {
      currentUtteranceIndex++;
      speakNext();
    };
    
    utterance.onerror = (e) => {
      console.error('An error occurred during speech synthesis:', e);
      stop(); // Stop on error
    };

    synth.speak(utterance);
  };

  const stop = () => {
    synth.cancel();
    currentUtteranceIndex = 0;
    updateUI('stopped');
  };

  // --- Settings Logic ---
  const getSettings = () => {
    const selectedVoiceURI = localStorage.getItem('tts-voiceURI');
    const voices = synth.getVoices();
    return {
      voice: voices.find(v => v.voiceURI === selectedVoiceURI) || voices[0],
      rate: parseFloat(localStorage.getItem('tts-rate') || 1)
    };
  };

  const populateVoiceList = () => {
    const voices = synth.getVoices().sort((a, b) => a.lang.localeCompare(b.lang));
    voiceSelect.innerHTML = '';
    const pageLang = document.documentElement.lang || 'zh-CN';
    
    voices.forEach(voice => {
        // Prioritize voices for the page's language
        if (voice.lang.startsWith(pageLang.split('-')[0])) {
            const option = document.createElement('option');
            option.textContent = `${voice.name} (${voice.lang})`;
            if (voice.localService === false) {
                 option.textContent += ' [Online]';
            }
            option.setAttribute('data-voice-uri', voice.voiceURI);
            voiceSelect.appendChild(option);
        }
    });

    // Restore saved voice
    const savedVoiceURI = localStorage.getItem('tts-voiceURI');
    if (savedVoiceURI) {
        const savedOption = voiceSelect.querySelector(`[data-voice-uri="${savedVoiceURI}"]`);
        if (savedOption) savedOption.selected = true;
    }
  };

  // --- Event Listeners ---
  playPauseBtn.addEventListener('click', () => {
    if (synth.speaking && !synth.paused) { // is playing
      synth.pause();
      updateUI('paused');
    } else if (synth.paused) { // is paused
      synth.resume();
      updateUI('playing');
    } else { // is stopped
      play();
    }
  });

  stopBtn.addEventListener('click', stop);
  
  settingsBtn.addEventListener('click', () => {
    settingsPanel.classList.toggle('open');
  });

  voiceSelect.addEventListener('change', (e) => {
    const selectedOption = e.target.options[e.target.selectedIndex];
    localStorage.setItem('tts-voiceURI', selectedOption.getAttribute('data-voice-uri'));
  });

  rateSlider.addEventListener('input', () => {
    const rate = parseFloat(rateSlider.value);
    rateValue.textContent = `${rate.toFixed(1)}x`;
    localStorage.setItem('tts-rate', rate);
  });
  
  window.addEventListener('beforeunload', () => synth.cancel());

  // --- Initialization ---
  prepareUtterances();
  if (utterances.length > 0) {
    container.style.visibility = 'visible';
  } else {
    return;
  }
  
  // Load voices and saved settings
  if (synth.onvoiceschanged !== undefined) {
    synth.onvoiceschanged = populateVoiceList;
  }
  populateVoiceList();

  const savedRate = localStorage.getItem('tts-rate');
  if (savedRate) {
    rateSlider.value = savedRate;
    rateValue.textContent = `${parseFloat(savedRate).toFixed(1)}x`;
  }
});
</script>