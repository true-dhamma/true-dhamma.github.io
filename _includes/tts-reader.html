<!-- tts-fab-reader.html -->
<!-- 使用 Azure TTS 和 Cloudflare Worker 的高级 TTS 阅读器 -->
<!-- 版本 3.0: Azure API angetrieben -->

<div class="tts-fab-container" id="tts-fab-container" style="display: none;">
  <button id="tts-play-pause-btn" class="tts-button" aria-label="朗读文章">
    <svg class="tts-icon" id="tts-play-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"></path></svg>
    <svg class="tts-icon" id="tts-pause-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" style="display: none;"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"></path></svg>
  </button>
</div>

<style>
  /* 样式部分保持不变 */
  .tts-fab-container {
    position: fixed;
    bottom: 30px;
    right: 30px;
    z-index: 1000;
  }
  .tts-button {
    display: flex;
    justify-content: center;
    align-items: center;
    width: 50px;
    height: 50px;
    border: none;
    background-color: #ffffff;
    border-radius: 50%;
    cursor: pointer;
    padding: 0;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    transition: background-color 0.2s ease-in-out, transform 0.2s ease;
  }
  .tts-button:hover {
    background-color: #f2f2f2;
    transform: translateY(-2px);
  }
  .tts-button:active {
    transform: scale(0.95);
  }
  .tts-icon {
    fill: #333;
    width: 24px;
    height: 24px;
  }
  .tts-highlight {
    background-color: #fef8e0;
    scroll-margin-top: 40px;
    transition: background-color 0.3s ease;
  }
</style>

<script>
document.addEventListener('DOMContentLoaded', () => {
  // ##################################################################
  // # 用户配置: 请将这里替换为您的 Cloudflare Worker URL #
  // ##################################################################
  const CLOUDFLARE_WORKER_URL = 'https://azure-tts-proxy.daizhikang.workers.dev';

  // --- DOM 元素引用 ---
  const container = document.getElementById('tts-fab-container');
  const playPauseBtn = document.getElementById('tts-play-pause-btn');
  const playIcon = document.getElementById('tts-play-icon');
  const pauseIcon = document.getElementById('tts-pause-icon');
  const article = document.querySelector('article');

  if (!article) return;
  if (!CLOUDFLARE_WORKER_URL.startsWith('https')) {
      console.warn('TTS 阅读器未配置 Cloudflare Worker URL。');
      return;
  }

  // --- 状态管理 ---
  let isReading = false;
  let isPaused = false;
  let textQueue = []; // 队列现在存储 {text, element}
  let currentIndex = 0;
  let currentAudio = null; // 用于存储当前的 HTMLAudioElement
  let currentlyHighlightedElement = null;

  // 默认使用晓晓的声音，可改为 'Yunyang-Neural'
  const preferredVoiceName = 'Xiaoxiao-Neural'; 

  // --- UI 更新 ---
  const updateUI = () => {
    if (isReading && !isPaused) { // 正在播放
      playIcon.style.display = 'none';
      pauseIcon.style.display = 'inline-block';
      playPauseBtn.setAttribute('aria-label', '暂停');
    } else { // 暂停或停止状态
      playIcon.style.display = 'inline-block';
      pauseIcon.style.display = 'none';
      playPauseBtn.setAttribute('aria-label', isPaused ? '继续朗读' : '朗读文章');
    }
  };
  
  // --- 高亮处理 ---
  const clearHighlight = () => {
    if (currentlyHighlightedElement) {
      currentlyHighlightedElement.classList.remove('tts-highlight');
      currentlyHighlightedElement = null;
    }
  };

  const highlightElement = (element) => {
    clearHighlight();
    if (element) {
      element.classList.add('tts-highlight');
      currentlyHighlightedElement = element;
      element.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
  };

  // --- 核心音频播放逻辑 ---
  const playNext = async () => {
    if (currentIndex >= textQueue.length) {
      stopReading();
      return;
    }

    const { text, element } = textQueue[currentIndex];
    highlightElement(element); // 立即高亮以提供反馈

    try {
      const response = await fetch(CLOUDFLARE_WORKER_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ text, voice: preferredVoiceName }),
      });

      if (!response.ok) {
        throw new Error(`API 请求失败: ${response.status} ${response.statusText}`);
      }

      const audioBlob = await response.blob();
      const audioUrl = URL.createObjectURL(audioBlob);
      
      if (currentAudio) {
        currentAudio.src = ''; // 清理旧音频
      }
      currentAudio = new Audio(audioUrl);
      
      currentAudio.addEventListener('ended', () => {
        URL.revokeObjectURL(audioUrl); // 释放内存
        currentIndex++;
        playNext(); // 播放下一个
      });

      currentAudio.addEventListener('error', (e) => {
        console.error('音频播放错误:', e);
        stopReading();
      });

      currentAudio.play();

    } catch (error) {
      console.error('获取或播放音频时出错:', error);
      stopReading();
    }
  };

  // --- 控制函数 ---
  const startReading = () => {
    isReading = true;
    isPaused = false;
    currentIndex = 0;
    updateUI();
    playNext();
  };

  const stopReading = () => {
    if (currentAudio) {
      currentAudio.pause();
      currentAudio = null;
    }
    isReading = false;
    isPaused = false;
    clearHighlight();
    updateUI();
  };
  
  const pauseReading = () => {
    if (currentAudio && isReading && !isPaused) {
      currentAudio.pause();
      isPaused = true;
      clearHighlight(); // 暂停时取消高亮
      updateUI();
    }
  };

  const resumeReading = () => {
    if (currentAudio && isReading && isPaused) {
      isPaused = false;
      highlightElement(textQueue[currentIndex].element); // 恢复时重新高亮
      currentAudio.play();
      updateUI();
    }
  };

  // --- 事件监听 ---
  playPauseBtn.addEventListener('click', () => {
    if (!isReading) {
      startReading();
    } else if (isPaused) {
      resumeReading();
    } else {
      pauseReading();
    }
  });

  window.addEventListener('beforeunload', stopReading); // 离开页面时停止朗读

  // --- 初始化 ---
  const initializeReader = () => {
    const elements = article.querySelectorAll('p, h1, h2, h3, h4, h5, h6, li, blockquote, figcaption');
    elements.forEach(el => {
      // 过滤掉不包含有意义文本的元素
      const text = el.innerText.trim();
      if (text) {
        textQueue.push({ text, element: el });
      }
    });

    if (textQueue.length === 0) return;
    
    container.style.display = 'block';
    updateUI();
  };

  initializeReader();
});
</script>