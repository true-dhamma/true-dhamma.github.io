<!-- tts-reader.html -->
<!-- 
  修改版功能 v2:
  1. 修复了 Edge/Chrome 浏览器上暂停后无法恢复播放的 bug。
  2. 优化 Safari 语音选择顺序为: "Siri" -> "莉莉 (Li-li)" -> "语舒 (Yu-Shu)"。
  3. 朗读和暂停合并为单个按钮。
  4. 自动读取 <article> 标签内的文本。
  5. 按钮为内联样式，可插入任意位置不换行。
-->

<span class="tts-reader-wrapper" id="tts-reader-container" style="display: none;">
  <button id="tts-play-pause-btn" class="tts-button" aria-label="朗读文章">
    <svg class="tts-icon" id="tts-play-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24"><path d="M8 5v14l11-7z"></path></svg>
    <svg class="tts-icon" id="tts-pause-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24" style="display: none;"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"></path></svg>
  </button>
</span>

<style>
  .tts-reader-wrapper {
    display: inline-flex; /* 关键：使其成为内联元素 */
    align-items: center;
    justify-content: center;
    vertical-align: middle; /* 优化与旁边文本的对齐 */
    margin: 0 0.2em; /* 与周围文本留出一点间距 */
  }
  .tts-button {
    display: flex;
    justify-content: center;
    align-items: center;
    width: 32px; /* 调小尺寸以适应内联 */
    height: 32px;
    border: 1px solid #ddd;
    background-color: #f7f7f7;
    border-radius: 50%;
    cursor: pointer;
    padding: 0;
    transition: background-color 0.2s ease-in-out, transform 0.1s ease;
  }
  .tts-button:hover {
    background-color: #e0e0e0;
  }
  .tts-button:active {
    transform: scale(0.9);
  }
  .tts-icon {
    fill: #333;
    width: 20px; /* 调小图标尺寸 */
    height: 20px;
  }
</style>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const synth = window.speechSynthesis;
  if (!synth) {
    console.log('抱歉，您的浏览器不支持 Web Speech API。');
    return;
  }

  // --- DOM Element References ---
  const container = document.getElementById('tts-reader-container');
  const playPauseBtn = document.getElementById('tts-play-pause-btn');
  const playIcon = document.getElementById('tts-play-icon');
  const pauseIcon = document.getElementById('tts-pause-icon');
  const article = document.querySelector('article');

  if (!article) return;
  
  // --- Global State ---
  let keepAliveInterval = null; // 用于修复 Edge/Chrome 暂停 bug 的计时器

  // --- Text Extraction ---
  const textElements = article.querySelectorAll('p, h1, h2, h3, h4, h5, h6, li, blockquote, figcaption');
  let textToRead = Array.from(textElements).map(el => el.innerText.trim()).join('. ');

  if (!textToRead.trim()) return;

  // --- UI State Management ---
  const updateUI = () => {
    if (synth.speaking && !synth.paused) { // 正在朗读
      playIcon.style.display = 'none';
      pauseIcon.style.display = 'inline-block';
      playPauseBtn.setAttribute('aria-label', '暂停朗读');
    } else { // 已暂停或已停止
      playIcon.style.display = 'inline-block';
      pauseIcon.style.display = 'none';
      playPauseBtn.setAttribute('aria-label', '朗读文章');
    }
  };
  
  const stopReading = () => {
      clearInterval(keepAliveInterval); // 停止时必须清除计时器
      synth.cancel();
      updateUI();
  };


  // --- Speech Synthesis Setup ---
  const utterance = new SpeechSynthesisUtterance(textToRead);
  let preferredVoice = null;
  const pageLang = document.documentElement.lang || 'zh-CN';
  utterance.lang = pageLang;
  
  utterance.onstart = updateUI;
  utterance.onpause = updateUI;
  utterance.onresume = updateUI;
  utterance.onend = () => {
      clearInterval(keepAliveInterval); // 朗读结束，清除计时器
      updateUI();
  };
  utterance.onerror = (event) => {
    console.error('朗读发生错误:', event);
    stopReading(); // 发生错误时也停止并重置
  };

  // --- Browser-Specific Voice Selection ---
  const selectVoice = () => {
    const voices = synth.getVoices();
    if (voices.length === 0) return;

    const userAgent = navigator.userAgent;
    const isEdge = userAgent.includes("Edg/");
    const isSafari = userAgent.includes("Safari/") && !userAgent.includes("Chrome/");
    const langPrefix = pageLang.split('-')[0]; // e.g., 'zh'

    let foundVoice = null;

    // 1. Safari: 按指定顺序 "Siri" -> "Li-li" -> "Yu-Shu"
    if (isSafari) {
      const preferredNames = ['Siri', 'Li-li', 'Yu-Shu'];
      for (const name of preferredNames) {
        foundVoice = voices.find(voice => 
          voice.lang.startsWith(langPrefix) && voice.name.includes(name)
        );
        if (foundVoice) break; // 找到一个就跳出循环
      }
      if (foundVoice) {
          preferredVoice = foundVoice;
          utterance.voice = preferredVoice;
          return;
      }
    }
    
    // 2. Edge: 优先寻找 Yunyang
    if (isEdge) {
      foundVoice = voices.find(voice => 
        voice.lang.startsWith(langPrefix) && voice.name.includes('Yunyang')
      );
      if (foundVoice) {
          preferredVoice = foundVoice;
          utterance.voice = preferredVoice;
          return;
      }
    }

    // 3. Fallback: 寻找其他高质量在线语音
    foundVoice = voices.find(voice => 
        voice.lang.startsWith(langPrefix) && voice.localService === false
    );
    if (foundVoice) {
        preferredVoice = foundVoice;
        utterance.voice = preferredVoice;
        return;
    }
    
    // 4. Final Fallback: 寻找任何匹配语言的本地语音
    foundVoice = voices.find(voice => voice.lang.startsWith(langPrefix));
    if (foundVoice) {
        preferredVoice = foundVoice;
        utterance.voice = preferredVoice;
    }
  };

  // 'voiceschanged' 事件对于动态加载语音至关重要
  synth.onvoiceschanged = selectVoice;
  selectVoice(); // 同时立即调用一次，以防语音已加载

  // --- Event Listeners ---
  playPauseBtn.addEventListener('click', () => {
    if (!utterance.voice) selectVoice();
      
    if (synth.speaking && !synth.paused) {
      // --- 正在朗读 -> 暂停 ---
      synth.pause();
      // ** 启动保活计时器以修复 Edge/Chrome 的 bug **
      keepAliveInterval = setInterval(() => {
        if (synth.paused) {
          synth.resume();
          synth.pause();
        }
      }, 5000);

    } else if (synth.paused) {
      // --- 已暂停 -> 继续 ---
      clearInterval(keepAliveInterval); // 清除保活计时器
      synth.resume();

    } else {
      // --- 未开始 -> 开始朗读 ---
      clearInterval(keepAliveInterval); // 以防万一
      synth.cancel(); // 清除之前的任何队列
      synth.speak(utterance);
    }
  });
  
  // 在用户离开页面时停止朗读
  window.addEventListener('beforeunload', () => {
    stopReading();
  });

  // 一切准备就绪，显示播放器
  container.style.display = 'inline-flex';
});
</script>