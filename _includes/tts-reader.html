<!-- tts-reader.html -->
<!-- 
  修改版功能 v3 (稳定版):
  1. 通过“记录位置并重启”的方式，彻底修复 Edge/Chrome 浏览器暂停后无法播放的 bug。
  2. Safari 语音选择顺序: "Siri" -> "莉莉 (Li-li)" -> "语舒 (Yu-Shu)"。
  3. Edge 浏览器优先选择 Yunyang (Natural) 语音。
  4. 朗读和暂停合并为单个按钮，按钮为内联样式，可插入任意位置。
-->

<span class="tts-reader-wrapper" id="tts-reader-container" style="display: none;">
  <button id="tts-play-pause-btn" class="tts-button" aria-label="朗读文章">
    <svg class="tts-icon" id="tts-play-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24"><path d="M8 5v14l11-7z"></path></svg>
    <svg class="tts-icon" id="tts-pause-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24" style="display: none;"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"></path></svg>
  </button>
</span>

<style>
  .tts-reader-wrapper {
    display: inline-flex; align-items: center; justify-content: center;
    vertical-align: middle; margin: 0 0.2em;
  }
  .tts-button {
    display: flex; justify-content: center; align-items: center;
    width: 32px; height: 32px; border: 1px solid #ddd;
    background-color: #f7f7f7; border-radius: 50%;
    cursor: pointer; padding: 0;
    transition: background-color 0.2s ease-in-out, transform 0.1s ease;
  }
  .tts-button:hover { background-color: #e0e0e0; }
  .tts-button:active { transform: scale(0.9); }
  .tts-icon { fill: #333; width: 20px; height: 20px; }
</style>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const synth = window.speechSynthesis;
  if (!synth) {
    console.log('抱歉，您的浏览器不支持 Web Speech API。');
    return;
  }

  const container = document.getElementById('tts-reader-container');
  const playPauseBtn = document.getElementById('tts-play-pause-btn');
  const playIcon = document.getElementById('tts-play-icon');
  const pauseIcon = document.getElementById('tts-pause-icon');
  const article = document.querySelector('article');
  if (!article) return;

  const textElements = article.querySelectorAll('p, h1, h2, h3, h4, h5, h6, li, blockquote, figcaption');
  const fullText = Array.from(textElements).map(el => el.innerText.trim()).join('. ');
  if (!fullText.trim()) return;

  let preferredVoice = null;
  const pageLang = document.documentElement.lang || 'zh-CN';
  
  // --- State Management ---
  let currentUtterance = null;
  let currentCharIndex = 0; // 记录当前播放到的字符位置
  let isManuallyPaused = false; // 标记是用户暂停，还是自然结束

  const updateUI = (state) => {
    if (state === 'playing') {
      playIcon.style.display = 'none';
      pauseIcon.style.display = 'inline-block';
      playPauseBtn.setAttribute('aria-label', '暂停朗读');
    } else { // 'paused' or 'stopped'
      playIcon.style.display = 'inline-block';
      pauseIcon.style.display = 'none';
      playPauseBtn.setAttribute('aria-label', '朗读文章');
    }
  };
  
  const stopReading = () => {
    isManuallyPaused = false;
    currentCharIndex = 0;
    synth.cancel();
    updateUI('stopped');
  };

  const speak = (textToSpeak, startIndex) => {
    synth.cancel(); // 开始前先清空队列
    
    currentUtterance = new SpeechSynthesisUtterance(textToSpeak);
    currentUtterance.lang = pageLang;
    if (preferredVoice) {
      currentUtterance.voice = preferredVoice;
    }

    currentUtterance.onboundary = (event) => {
      // 实时更新当前读到的字符绝对位置
      currentCharIndex = startIndex + event.charIndex;
    };

    currentUtterance.onend = () => {
      // 如果不是用户手动暂停，则说明是自然播放结束，重置状态
      if (!isManuallyPaused) {
        currentCharIndex = 0;
        updateUI('stopped');
      }
    };
    
    currentUtterance.onerror = (event) => {
      console.error('朗读发生错误:', event);
      stopReading();
    };

    synth.speak(currentUtterance);
    updateUI('playing');
  };

  const selectVoice = () => {
    const voices = synth.getVoices();
    if (voices.length === 0) return;

    const userAgent = navigator.userAgent;
    const isEdge = userAgent.includes("Edg/");
    const isSafari = userAgent.includes("Safari/") && !userAgent.includes("Chrome/");
    const langPrefix = pageLang.split('-')[0];

    let foundVoice = null;
    if (isSafari) {
      const preferredNames = ['Siri', 'Li-li', 'Yu-Shu'];
      for (const name of preferredNames) {
        foundVoice = voices.find(v => v.lang.startsWith(langPrefix) && v.name.includes(name));
        if (foundVoice) break;
      }
    } else if (isEdge) {
      foundVoice = voices.find(v => v.lang.startsWith(langPrefix) && v.name.includes('Yunyang'));
    }

    if (!foundVoice) {
      foundVoice = voices.find(v => v.lang.startsWith(langPrefix) && v.localService === false);
    }
    if (!foundVoice) {
      foundVoice = voices.find(v => v.lang.startsWith(langPrefix));
    }
    
    preferredVoice = foundVoice;
  };

  synth.onvoiceschanged = selectVoice;
  selectVoice();

  playPauseBtn.addEventListener('click', () => {
    if (synth.speaking) {
      // --- 正在朗读 -> 触发暂停 ---
      isManuallyPaused = true;
      synth.cancel(); // 使用cancel而不是pause
      updateUI('paused');
    } else {
      // --- 停止或已暂停 -> 触发播放/继续 ---
      isManuallyPaused = false;
      // 从记录的位置截取剩余文本并开始朗读
      const textToSpeak = fullText.substring(currentCharIndex);
      if (textToSpeak) {
        speak(textToSpeak, currentCharIndex);
      } else {
        // 如果文本为空（比如从末尾开始），则重置
        stopReading();
      }
    }
  });

  window.addEventListener('beforeunload', () => {
    // 离开页面时，确保完全停止，而不是进入暂停状态
    isManuallyPaused = false;
    currentCharIndex = 0;
    synth.cancel();
  });

  container.style.display = 'inline-flex';
});
</script>