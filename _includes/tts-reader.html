<!-- tts-reader.html -->
<!-- 放置在 Jekyll 的 _includes 文件夹下 -->

<div class="tts-reader-container">
  <button id="tts-play-pause" aria-label="朗读文章">朗读本页</button>
  <button id="tts-stop" aria-label="停止朗读" style="display: none;">停止</button>
</div>

<style>
  /* 简单的按钮样式，您可以根据自己的主题进行修改 */
  .tts-reader-container {
    margin: 20px 0;
  }
  .tts-reader-container button {
    padding: 8px 16px;
    font-size: 14px;
    cursor: pointer;
    border: 1px solid #ccc;
    border-radius: 5px;
    background-color: #f0f0f0;
    margin-right: 10px;
  }
  .tts-reader-container button:hover {
    background-color: #e0e0e0;
  }
</style>

<script>
document.addEventListener('DOMContentLoaded', () => {
  // 检查浏览器是否支持 Speech Synthesis API
  if ('speechSynthesis' in window) {
    const playPauseButton = document.getElementById('tts-play-pause');
    const stopButton = document.getElementById('tts-stop');
    const articleElement = document.querySelector('article');

    // 如果页面上没有 <article> 标签，则不显示按钮
    if (!articleElement) {
      document.querySelector('.tts-reader-container').style.display = 'none';
      return;
    }

    const textToRead = articleElement.textContent || articleElement.innerText;
    const utterance = new SpeechSynthesisUtterance(textToRead);

    // 自动设置语言，优先使用<html>标签的lang属性
    utterance.lang = document.documentElement.lang || 'zh-CN';

    // 朗读结束时重置按钮状态
    utterance.onend = () => {
      playPauseButton.textContent = '朗读本页';
      stopButton.style.display = 'none';
    };
    
    // 朗读发生错误时重置按钮状态
    utterance.onerror = (event) => {
        console.error('SpeechSynthesisUtterance.onerror', event);
        playPauseButton.textContent = '朗读本页';
        stopButton.style.display = 'none';
    };


    // 播放/暂停按钮的点击事件
    playPauseButton.addEventListener('click', () => {
      // 如果当前正在朗读且未暂停，则暂停
      if (speechSynthesis.speaking && !speechSynthesis.paused) {
        speechSynthesis.pause();
        playPauseButton.textContent = '继续朗读';
      } 
      // 如果当前已暂停，则恢复朗读
      else if (speechSynthesis.paused) {
        speechSynthesis.resume();
        playPauseButton.textContent = '暂停';
      } 
      // 否则，开始朗读
      else {
        // 先取消上一次可能存在的任务，以防万一
        speechSynthesis.cancel(); 
        speechSynthesis.speak(utterance);
        playPauseButton.textContent = '暂停';
        stopButton.style.display = 'inline-block';
      }
    });

    // 停止按钮的点击事件
    stopButton.addEventListener('click', () => {
      speechSynthesis.cancel(); // cancel()会触发onend事件，自动重置按钮
    });

    // 当用户离开页面时，停止朗读，避免在后台继续发声
    window.addEventListener('beforeunload', () => {
      speechSynthesis.cancel();
    });

  } else {
    // 如果浏览器不支持，则隐藏整个控件
    console.log('抱歉，您的浏览器不支持 Web Speech API。');
    document.querySelector('.tts-reader-container').style.display = 'none';
  }
});
</script>