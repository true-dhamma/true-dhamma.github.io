<p>&nbsp;</p>
<div class="share">
  {% for network in site.sharing_links %}
    {% if network[1] != blank %}
      {% assign name = network[0] %}
      {% assign id = network[0] | downcase | remove: " " %}
      {% assign original_page_url = site.url | append: site.baseurl | append: page.url %}
      {% assign color = network[1] %}

      {% capture share_link %}
        {%- if id contains "twitter" %}https://twitter.com/intent/tweet/?url={{ original_page_url }}&text={{ page.title | uri_escape }}{% if site.twitter.username %}&via={{ site.twitter.username }}{% endif %}{% endif -%}
        {%- if id contains "facebook" %}https://facebook.com/sharer/sharer.php?u={{ original_page_url }}{% endif -%}
        {%- if id contains "pinterest" %}https://pinterest.com/pin/create/button/?url={{ original_page_url }}&description={{ page.title }}&media={{ page.image }}{% endif -%}
        {%- if id contains "linkedin" %}https://www.linkedin.com/shareArticle?url={{ original_page_url }}&title={{ page.title }}&source={{ site.title }}&mini=true{% endif -%}
        {%- if id contains "tumblr" %}https://tumblr.com/widgets/share/tool?canonicalUrl={{ original_page_url }}&tags={{ page.category }}&caption={{ page.title }}{% endif -%}
        {%- if id contains "reddit" %}https://reddit.com/submit?url={{ original_page_url }}&title={{ page.title }}&resubmit=true{% endif -%}
        {%- if id contains "hackernews" %}https://news.ycombinator.com/submitlink?u={{ original_page_url }}&t={{ page.title }}{% endif -%}
        {%- if id contains "designernews" %}https://www.designernews.co/submit?url={{ original_page_url }}&title={{ page.title }}{% endif -%}
        {%- if id contains "email" %}mailto:?subject={{ page.title }}&body={{ original_page_url | prepend: "Hey, check out this: "}}{% endif -%}
        {%- if id contains "universalshare" %}javascript:handlePageShare(){% endif -%}
        {%- if id contains "url" %}javascript:handleCopyShortUrl('{{ original_page_url }}', this){% endif -%}
      {% endcapture %}

      {% assign button_text = name %}
      {% assign button_icon = id %}
      
      {% if id == "universalshare" %}
        {% assign button_text = "Share" %}
        {% assign button_icon = "share" %}
      {% elsif id == "url" %}
        {% assign button_text = "Copy Link" %}
        {% assign button_icon = "link" %}
      {% endif %}

      {% include button.html text=button_text icon=button_icon link=share_link color=color %}
    {% endif %}
  {% endfor %}

  <script>
    const SHORTENER_SERVICE_URL = 'https://url.true-dhamma.com/'; // 注意：去掉了末尾的 ?create=

    /**
     *  确定性地从一个URL生成一个6位的短代码。
     *  此算法必须与Cloudflare Worker中的算法完全一致。
     *  @param {string} url - 原始长链接
     *  @returns {Promise<string>} - 返回一个Promise，解析为6位的短代码
     */
    async function generateShortCodeFromUrl(url) {
      const encoder = new TextEncoder();
      const data = encoder.encode(url);
      // 使用SHA-1哈希算法，它足够快且能提供良好的分布性
      const hashBuffer = await crypto.subtle.digest('SHA-1', data);
      const hashArray = Array.from(new Uint8Array(hashBuffer));

      // 使用哈希的前4个字节（32位）来生成代码，这足以提供足够的随机性
      const num = (hashArray[0] << 24) | (hashArray[1] << 16) | (hashArray[2] << 8) | hashArray[3];
      
      const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
      const base = chars.length; // 36
      let code = '';
      let tempNum = Math.abs(num);

      for (let i = 0; i < 6; i++) {
        code = chars[tempNum % base] + code;
        tempNum = Math.floor(tempNum / base);
      }
      
      return code.padStart(6, 'A'); // 确保总是6位长
    }

    /**
     *  处理点击“拷贝链接”按钮的新逻辑
     *  1. 本地预测短链接
     *  2. 立即尝试复制到剪贴板 (同步操作)
     *  3. 异步在后台请求Worker创建该链接 (fire-and-forget)
     */
    async function handleCopyShortUrl(originalUrl, buttonElement) {
      const originalText = buttonElement.innerHTML;
      buttonElement.innerHTML = '正在处理...';
      buttonElement.disabled = true;

      try {
        // 1. 本地计算出短链代码和完整的短链接
        const shortCode = await generateShortCodeFromUrl(originalUrl);
        const shortUrl = SHORTENER_SERVICE_URL + shortCode;

        // 2. 立即将预测的短链接复制到剪贴板
        await copyToClipboard(shortUrl, '短链接已复制！');
        buttonElement.innerHTML = '已复制！';

        // 3. 在后台默默地请求worker创建链接，确保它真实有效。
        //    我们不需要等待这个请求的结果，所以不使用await。
        fetch(SHORTENER_SERVICE_URL + '?create=' + encodeURIComponent(originalUrl))
          .then(response => {
            if (!response.ok) console.error('Short link creation in background failed.');
            else console.log('Short link created/verified in background.');
          })
          .catch(error => console.error('Error creating short link in background:', error));

      } catch (error) {
        console.error('Error predicting or copying short link:', error);
        // 如果本地计算或复制的任何环节出错，则回退到复制原始链接
        alert('无法生成短链接，已为您复制原始链接。');
        await copyToClipboard(originalUrl, '原始链接已复制。');
        buttonElement.innerHTML = '复制失败';
      } finally {
        // 2秒后恢复按钮原始状态
        setTimeout(() => {
          buttonElement.innerHTML = originalText;
          buttonElement.disabled = false;
        }, 2000);
      }
    }
    
    // --- 以下的辅助函数保持不变 ---

    /**
     * 处理通用的“分享”按钮逻辑
     */
    function handlePageShare() {
      const pageUrl = window.location.href;
      const pageTitle = document.title;

      if (navigator.share) {
        navigator.share({ title: pageTitle, url: pageUrl }).catch(error => {
          if (error.name !== 'AbortError') {
            copyToClipboard(pageUrl);
          }
        });
      } else {
        copyToClipboard(pageUrl);
      }
    }

    /**
     * 将文本复制到剪贴板（优先使用新API）
     */
    async function copyToClipboard(text, successMessage = 'URL已复制到剪贴板，请自行分享。') {
      if (navigator.clipboard && navigator.clipboard.writeText) {
        try {
          await navigator.clipboard.writeText(text);
          alert(successMessage);
        } catch (err) {
          fallbackCopyTextToClipboard(text, successMessage);
        }
      } else {
        fallbackCopyTextToClipboard(text, successMessage);
      }
    }

    /**
     * 兼容旧版浏览器的剪贴板复制方法
     */
    function fallbackCopyTextToClipboard(text, successMessage) {
      const textArea = document.createElement("textarea");
      textArea.value = text;
      textArea.style.top = "0";
      textArea.style.left = "0";
      textArea.style.position = "fixed";
      textArea.style.opacity = "0";
      textArea.style.pointerEvents = "none";

      document.body.appendChild(textArea);
      textArea.focus();
      textArea.select();

      try {
        if (document.execCommand('copy')) {
          alert(successMessage);
        } else {
          alert('无法复制，请手动选择复制：' + text);
        }
      } catch (err) {
        alert('无法复制，请手动选择复制：' + text);
      }

      document.body.removeChild(textArea);
    }
  </script>
</div>