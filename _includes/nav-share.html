<!-- _includes/nav-share.html -->
<div class="share">
  {% for network in site.sharing_links %}
    {% if network[1] != blank %}
      {% assign name = network[0] %}
      {% assign id = network[0] | downcase | remove: " " %}

      {% if id contains "genericshare" %}
        <!-- 自定义分享按钮及其逻辑：手机端调用浏览器分享API，PC端显示二维码 -->
        {% comment %}
          我们通过 button.html 渲染按钮，其生成的 class 会是 "button--genericshare"，
          JavaScript 将通过这个 class 来选中按钮。
          link="#" 是一个占位符，JavaScript 会阻止其默认行为。
          color 设置为中性灰色。
        {% endcomment %}
        {% include button.html text="分享" icon="link" link="#" color="#6c757d" %}

        <div id="qrcodeContainer" style="display:none; text-align: center; margin-top: 15px; padding: 10px; border: 1px solid #eee; border-radius: 5px; display: inline-block; max-width: 200px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            <p style="font-size: 0.9em; color: #666; margin-bottom: 5px;">（请用手机微信扫描二维码分享）</p>
            <div id="qrcodeCanvas"></div> {# Inner div for QRCode.js to render into #}
        </div>

        <!-- 引入二维码生成库 (这里使用简单CDN，生产环境可下载到本地assets) -->
        <script src="https://cdn.jsdelivr.net/npm/qrcode.js@1.0.0/qrcode.min.js"></script>
        <script>
          document.addEventListener('DOMContentLoaded', function() {
            // 通过 class 选择器获取按钮，因为我们不能修改 button.html 来添加 ID
            const shareButton = document.querySelector('.button--genericshare');
            const qrcodeContainer = document.getElementById('qrcodeContainer');
            const qrcodeCanvas = document.getElementById('qrcodeCanvas');
            let qrcodeInstance = null; // 存储二维码实例，避免重复创建

            if (shareButton) {
              shareButton.addEventListener('click', async (event) => {
                event.preventDefault(); // 阻止<a>标签的默认跳转行为 (link="#")

                const currentUrl = window.location.href; // 获取当前页面的完整URL
                const pageTitle = document.title;       // 获取当前页面的标题
                const shareText = '我发现了一个很棒的页面，快来看看！'; // 分享时默认的文本

                // 尝试调用 Web Share API (手机端优先)
                if (navigator.share) {
                  try {
                    await navigator.share({
                      title: pageTitle,
                      text: shareText,
                      url: currentUrl
                    });
                    console.log('内容已成功分享');
                    // 如果成功分享，隐藏可能已显示的二维码
                    if (qrcodeContainer) {
                        qrcodeContainer.style.display = 'none';
                    }
                  } catch (error) {
                    console.error('Web Share API 分享失败:', error);
                    if (error.name === 'AbortError') {
                      console.log('用户取消了分享。');
                    } else {
                      // Web Share API 调用失败或被拒绝， fallback 到二维码 (PC端或不支持API的手机端)
                      if (qrcodeContainer && qrcodeCanvas) {
                        if (!qrcodeInstance) { // 第一次点击且不支持Web Share API，或用户取消
                          qrcodeCanvas.innerHTML = ''; // 清空内容
                          qrcodeInstance = new QRCode(qrcodeCanvas, {
                            text: currentUrl,
                            width: 128,
                            height: 128
                          });
                        }
                        qrcodeContainer.style.display = 'block'; // 显示二维码
                      }
                    }
                  }
                } else {
                  // 不支持 Web Share API (通常是PC端或旧版手机浏览器)
                  if (qrcodeContainer && qrcodeCanvas) {
                    if (!qrcodeInstance) { // 第一次点击
                      qrcodeCanvas.innerHTML = ''; // 清空内容
                      qrcodeInstance = new QRCode(qrcodeCanvas, {
                        text: currentUrl,
                        width: 128,
                        height: 128
                      });
                    }
                    qrcodeContainer.style.display = 'block'; // 显示二维码
                  }
                }
              });
            }
          });
        </script>
      {% else %}
        <!-- 保持原有逻辑，渲染其他社交分享按钮 -->
        {% assign url = site.url | append: site.baseurl | append: page.url %}
        {% assign color = network[1] %}
        {% capture share_link %}
          {%- if id contains "twitter" %}https://twitter.com/intent/tweet/?url={{ url }}&text={{ page.title | uri_escape }}{% if site.twitter.username %}&via={{ site.twitter.username }}{% endif %}{% endif -%}
          {%- if id contains "facebook" %}https://facebook.com/sharer/sharer.php?u={{ url }}{% endif -%}
          {%- if id contains "pinterest" %}https://pinterest.com/pin/create/button/?url={{ url }}&description={{ page.title }}&media={{ page.image }}{% endif --}
          {%- if id contains "linkedin" %}https://www.linkedin.com/shareArticle?url={{ url }}&title={{ page.title }}&source={{ site.title }}&mini=true{% endif -%}
          {%- if id contains "tumblr" %}https://tumblr.com/widgets/share/tool?canonicalUrl={{ url }}&tags={{ page.category }}&caption={{ page.title }}{% endif -%}
          {%- if id contains "reddit" %}https://reddit.com/submit?url={{ url }}&title={{ page.title }}&resubmit=true{% endif --}
          {%- if id contains "hackernews" %}https://news.ycombinator.com/submitlink?u={{ url }}&t={{ page.title }}{% endif -%}
          {%- if id contains "designernews" %}https://www.designernews.co/submit?url={{ url }}&title={{ page.title }}{% endif -%}
          {%- if id contains "email" %}mailto:?subject={{ page.title }}&body={{ url | prepend: "Hey, check out this: "}}{% endif -%}
        {% endcapture %}
        {% include button.html text=name icon=id link=share_link color=color %}
      {% endif %}
    {% endif %}
  {% endfor %}
</div>