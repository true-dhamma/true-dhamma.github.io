<!-- _includes/nav_share.html -->
<div class="share">
  {% for network in site.sharing_links %}
    {% if network[1] != blank %}
      {% assign name = network[0] %}
      {% assign id = network[0] | downcase | remove: " " %}
      {% comment %}
        {% assign url = site.url | append: site.baseurl | append: page.url %}
        {% assign color = network[1] %}
        {% capture share_link %}
          {%- if id contains "twitter" %}https://twitter.com/intent/tweet/?url={{ url }}&text={{ page.title | uri_escape }}{% if site.twitter.username %}&via={{ site.twitter.username }}{% endif %}{% endif -%}
          {%- if id contains "facebook" %}https://facebook.com/sharer/sharer.php?u={{ url }}{% endif -%}
          {%- if id contains "pinterest" %}https://pinterest.com/pin/create/button/?url={{ url }}&description={{ page.title }}&media={{ page.image }}{% endif -%}
          {%- if id contains "linkedin" %}https://www.linkedin.com/shareArticle?url={{ url }}&title={{ page.title }}&source={{ site.title }}&mini=true{% endif -%}
          {%- if id contains "tumblr" %}https://tumblr.com/widgets/share/tool?canonicalUrl={{ url }}&tags={{ page.category }}&caption={{ page.title }}{% endif -%}
          {%- if id contains "reddit" %}https://reddit.com/submit?url={{ url }}&title={{ page.title }}&resubmit=true{% endif -%}
          {%- if id contains "hackernews" %}https://news.ycombinator.com/submitlink?u={{ url }}&t={{ page.title }}{% endif -%}
          {%- if id contains "designernews" %}https://www.designernews.co/submit?url={{ url }}&title={{ page.title }}{% endif -%}
          {%- if id contains "email" %}mailto:?subject={{ page.title }}&body={{ url | prepend: "Hey, check out this: "}}{% endif -%}
        {% endcapture %}
      {% endcomment %}

      {% if id contains "genericshare" %}
        <!-- 自定义分享按钮及其逻辑 -->
        <style>
          /* 按钮样式 */
          .share-button-custom {
            display: inline-flex; /* 使图标和文字在一行并居中 */
            align-items: center;
            justify-content: center;
            padding: 8px 12px;
            background-color: #6c757d; /* 中性灰色，作为分享按钮的默认色 */
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            gap: 8px; /* 图标与文字之间的间距 */
            margin: 5px; /* 增加一点外边距 */
            text-decoration: none;
            -webkit-appearance: none; /* 移除iOS上的默认按钮样式 */
            appearance: none;
            transition: background-color 0.3s ease;
          }
          .share-button-custom:hover {
            background-color: #5a6268;
          }
          .share-button-custom svg {
            width: 16px;
            height: 16px;
            fill: currentColor; /* 使SVG图标颜色继承按钮文字颜色 */
          }
          /* 二维码容器样式 */
          #qrcodeContainer {
            margin-top: 15px;
            padding: 10px;
            border: 1px solid #eee;
            border-radius: 5px;
            display: inline-block; /* 使其可以居中 */
            text-align: center; /* 居中内容 */
          }
          #qrcodeContainer canvas {
            display: block; /* 移除canvas元素下方的额外空白 */
            margin: 0 auto; /* 将canvas自身居中 */
          }
        </style>

        <button class="share-button-custom" id="sharePageButton">
          <!-- 使用 site-icons.svg 中已有的 'link' 图标 -->
          <svg width="16" height="16" class="icon icon--share" role="img" alt="分享"><title>分享</title><use xlink:href="#link" fill="currentColor"></use></svg>
          分享
        </button>
        <div id="qrcodeContainer" style="display:none;"></div>

        <!-- 引入二维码生成库 -->
        <script src="https://cdn.jsdelivr.net/npm/qrcode.js@1.0.0/qrcode.min.js"></script>
        <script>
          document.addEventListener('DOMContentLoaded', function() {
            const shareButton = document.getElementById('sharePageButton');
            const qrcodeContainer = document.getElementById('qrcodeContainer');
            let qrcodeGenerated = false; // 标记，确保二维码只生成一次

            if (shareButton) {
              shareButton.addEventListener('click', async () => {
                const currentUrl = window.location.href; // 获取当前页面的完整URL
                const pageTitle = document.title;       // 获取当前页面的标题
                const shareText = '我发现了一个很棒的页面，快来看看！'; // 分享时默认的文本

                // 尝试调用 Web Share API (手机端)
                if (navigator.share) {
                  try {
                    await navigator.share({
                      title: pageTitle,
                      text: shareText,
                      url: currentUrl
                    });
                    console.log('内容已成功分享');
                    // 如果成功分享，隐藏可能已显示的二维码
                    if (qrcodeContainer) {
                        qrcodeContainer.style.display = 'none';
                    }
                  } catch (error) {
                    console.error('Web Share API 分享失败:', error);
                    if (error.name === 'AbortError') {
                      console.log('用户取消了分享。');
                    } else {
                      // Web Share API 调用失败或被拒绝， fallback 到二维码 (PC端或不支持API的手机端)
                      if (qrcodeContainer && !qrcodeGenerated) {
                        // 清空之前的二维码内容，避免重复添加
                        qrcodeContainer.innerHTML = '';
                        new QRCode(qrcodeContainer, {
                          text: currentUrl,
                          width: 128,
                          height: 128
                        });
                        qrcodeGenerated = true;
                      }
                      if (qrcodeContainer) {
                        qrcodeContainer.style.display = 'block';
                      }
                    }
                  }
                } else {
                  // 不支持 Web Share API (通常是PC端或旧版手机浏览器)
                  if (qrcodeContainer && !qrcodeGenerated) {
                    qrcodeContainer.innerHTML = ''; // 清空内容
                    new QRCode(qrcodeContainer, {
                      text: currentUrl,
                      width: 128,
                      height: 128
                    });
                    qrcodeGenerated = true;
                  }
                  if (qrcodeContainer) {
                    qrcodeContainer.style.display = 'block';
                  }
                }
              });
            }
          });
        </script>
      {% else %}
        <!-- 保持原有逻辑，渲染其他社交分享按钮 -->
        {% assign url = site.url | append: site.baseurl | append: page.url %}
        {% assign color = network[1] %}
        {% capture share_link %}
          {%- if id contains "twitter" %}https://twitter.com/intent/tweet/?url={{ url }}&text={{ page.title | uri_escape }}{% if site.twitter.username %}&via={{ site.twitter.username }}{% endif %}{% endif -%}
          {%- if id contains "facebook" %}https://facebook.com/sharer/sharer.php?u={{ url }}{% endif -%}
          {%- if id contains "pinterest" %}https://pinterest.com/pin/create/button/?url={{ url }}&description={{ page.title }}&media={{ page.image }}{% endif -%}
          {%- if id contains "linkedin" %}https://www.linkedin.com/shareArticle?url={{ url }}&title={{ page.title }}&source={{ site.title }}&mini=true{% endif -%}
          {%- if id contains "tumblr" %}https://tumblr.com/widgets/share/tool?canonicalUrl={{ url }}&tags={{ page.category }}&caption={{ page.title }}{% endif --}
          {%- if id contains "reddit" %}https://reddit.com/submit?url={{ url }}&title={{ page.title }}&resubmit=true{% endif -%}
          {%- if id contains "hackernews" %}https://news.ycombinator.com/submitlink?u={{ url }}&t={{ page.title }}{% endif -%}
          {%- if id contains "designernews" %}https://www.designernews.co/submit?url={{ url }}&title={{ page.title }}{% endif -%}
          {%- if id contains "email" %}mailto:?subject={{ page.title }}&body={{ url | prepend: "Hey, check out this: "}}{% endif -%}
        {% endcapture %}
        {% include button.html text=name icon=id link=share_link color=color %}
      {% endif %}
    {% endif %}
  {% endfor %}
</div>