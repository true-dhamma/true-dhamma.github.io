<p>&nbsp;</p>
<div class="share">
  {% for network in site.sharing_links %}
    {% if network[1] != blank %}
      {% assign name = network[0] %}
      {% assign id = network[0] | downcase | remove: " " %}
      {% assign original_page_url = site.url | append: site.baseurl | append: page.url %}
      {% assign color = network[1] %}

      {% capture share_link %}
        {%- if id contains "twitter" %}https://twitter.com/intent/tweet/?url={{ original_page_url }}&text={{ page.title | uri_escape }}{% if site.twitter.username %}&via={{ site.twitter.username }}{% endif %}{% endif -%}
        {%- if id contains "facebook" %}https://facebook.com/sharer/sharer.php?u={{ original_page_url }}{% endif -%}
        {%- if id contains "pinterest" %}https://pinterest.com/pin/create/button/?url={{ original_page_url }}&description={{ page.title }}&media={{ page.image }}{% endif -%}
        {%- if id contains "linkedin" %}https://www.linkedin.com/shareArticle?url={{ original_page_url }}&title={{ page.title }}&source={{ site.title }}&mini=true{% endif -%}
        {%- if id contains "tumblr" %}https://tumblr.com/widgets/share/tool?canonicalUrl={{ original_page_url }}&tags={{ page.category }}&caption={{ page.title }}{% endif -%}
        {%- if id contains "reddit" %}https://reddit.com/submit?url={{ original_page_url }}&title={{ page.title }}&resubmit=true{% endif -%}
        {%- if id contains "hackernews" %}https://news.ycombinator.com/submitlink?u={{ original_page_url }}&t={{ page.title }}{% endif -%}
        {%- if id contains "designernews" %}https://www.designernews.co/submit?url={{ original_page_url }}&title={{ page.title }}{% endif -%}
        {%- if id contains "email" %}mailto:?subject={{ page.title }}&body={{ original_page_url | prepend: "Hey, check out this: "}}{% endif -%}
        {%- if id contains "universalshare" %}javascript:handlePageShare(){% endif -%}
        {%- if id contains "url" %}javascript:handleCopyShortUrl('{{ original_page_url }}', this){% endif -%}
      {% endcapture %}

      {% assign button_text = name %}
      {% assign button_icon = id %}
      
      {% if id == "universalshare" %}
        {% assign button_text = "Share" %}
        {% assign button_icon = "share" %}
      {% elsif id == "url" %}
        {% assign button_text = "Copy Link" %}
        {% assign button_icon = "link" %}
      {% endif %}

      {% include button.html text=button_text icon=button_icon link=share_link color=color %}
    {% endif %}
  {% endfor %}

  <!-- 引入 SparkMD5 库，并使用正确的 integrity 哈希 -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/spark-md5/3.0.2/spark-md5.min.js" integrity="sha512-ALiU89iLIm6O3i5N7M3PEiSPayMlgJ5frjJdndA5f39obgS1wwB2C1NxF5qu5r2O3Tz+G3Kzgn9fB2wFmdvH4Q==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  
  <script>
    const SHORTENER_SERVICE_DOMAIN = 'https://url.true-dhamma.com';

    /**
     *  使用 SparkMD5 同步地从一个URL生成一个6位的短代码。
     *  此算法必须与Cloudflare Worker中的算法完全一致。
     */
    function generateShortCodeFromUrl(url) {
      const hash = SparkMD5.hash(url);
      const num = parseInt(hash.substring(0, 8), 16);
      const base36 = num.toString(36);
      return base36.substring(0, 6).toUpperCase().padStart(6, 'A');
    }

    /**
     * 最终解决方案: 前端同步计算并复制，后端异步确认，等待确认后弹窗提示
     */
    async function handleCopyShortUrl(originalUrl, buttonElement) {
      const originalText = buttonElement.innerHTML;
      buttonElement.innerHTML = '正在处理...';
      buttonElement.disabled = true;

      // 步骤 1: 前端立即、同步地计算出短链接
      const shortCode = generateShortCodeFromUrl(originalUrl);
      const shortUrl = `${SHORTENER_SERVICE_DOMAIN}/${shortCode}`;

      // 步骤 2: 立即尝试将这个本地计算出的链接复制到剪贴板
      // 这个操作必须在用户点击事件的同步堆栈中执行，以兼容iOS
      const copyPromise = copyToClipboard(shortUrl);
      
      try {
        // 步骤 3: 同时，异步地向后端发送请求，以确保链接被创建/验证
        const createPromise = fetch(`${SHORTENER_SERVICE_DOMAIN}/?create=` + encodeURIComponent(originalUrl));

        // 步骤 4: 等待复制和创建两个操作都完成
        const [copyResult, createResponse] = await Promise.all([copyPromise, createPromise]);

        if (!createResponse.ok) {
            throw new Error('服务器确认链接失败，状态码: ' + createResponse.status);
        }
        
        // 步骤 5: 只有当复制和创建都成功时，才显示最终的成功提示
        alert('短链接已复制！');
        buttonElement.innerHTML = '已复制！';

      } catch (error) {
        // 如果任何一个环节失败 (复制或创建)
        console.error('处理短链接时出错:', error);

        // 检查是不是复制失败 (特别是iOS上的手动复制提示)
        if (error.isCopyError) {
          alert('无法自动复制，请手动复制：\n' + shortUrl);
        } else {
          // 如果是其他错误 (如网络问题)，则提示通用失败信息
          alert('操作失败，已为您复制原始链接。');
          await copyToClipboard(originalUrl).catch(() => {}); // 尝试复制原始链接作为后备
        }
        buttonElement.innerHTML = '复制失败';

      } finally {
        // 步骤 6: 恢复按钮状态
        setTimeout(() => {
          buttonElement.innerHTML = originalText;
          buttonElement.disabled = false;
        }, 2000);
      }
    }
    
    /**
     * 将文本复制到剪贴板。
     * 它现在不直接alert，而是返回一个Promise来表示成功或失败。
     */
    function copyToClipboard(text) {
        return new Promise((resolve, reject) => {
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(text).then(resolve).catch(err => {
                    fallbackCopy(text, resolve, reject); // 新API失败，尝试旧方法
                });
            } else {
                fallbackCopy(text, resolve, reject);
            }
        });
    }

    /**
     * 兼容旧版浏览器的剪贴板复制方法
     */
    function fallbackCopy(text, resolve, reject) {
        const textArea = document.createElement("textarea");
        textArea.value = text;
        textArea.style.position = "fixed";
        textArea.style.top = "-9999px";
        textArea.style.left = "-9999px";
        document.body.appendChild(textArea);
        
        if (navigator.userAgent.match(/ipad|iphone/i)) {
            textArea.contentEditable = true;
            textArea.readOnly = true;
            const range = document.createRange();
            range.selectNodeContents(textArea);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            textArea.setSelectionRange(0, 999999);
        } else {
            textArea.select();
        }

        try {
            if (document.execCommand('copy')) {
                resolve(); // 复制成功
            } else {
                const err = new Error('document.execCommand failed');
                err.isCopyError = true; // 添加一个标志，以便上层可以识别
                reject(err); // 复制失败
            }
        } catch (err) {
            err.isCopyError = true;
            reject(err);
        } finally {
            document.body.removeChild(textArea);
        }
    }

    /**
     * 处理通用的“分享”按钮逻辑
     */
    function handlePageShare() {
      const pageUrl = window.location.href;
      const pageTitle = document.title;
      if (navigator.share) {
        navigator.share({ title: pageTitle, url: pageUrl }).catch(error => {
          if (error.name !== 'AbortError') {
             copyToClipboard(pageUrl).then(() => alert('链接已复制到剪贴板！'));
          }
        });
      } else {
        copyToClipboard(pageUrl).then(() => alert('链接已复制到剪贴板！'));
      }
    }
  </script>
</div>