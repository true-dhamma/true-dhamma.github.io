<p>&nbsp;</p>
<div class="share">
  {% for network in site.sharing_links %}
    {% if network[1] != blank %}
      {% assign name = network[0] %}
      {% assign id = network[0] | downcase | remove: " " %}
      {% assign original_page_url = site.url | append: site.baseurl | append: page.url %}
      {% assign color = network[1] %}

      {% capture share_link %}
        {%- if id contains "twitter" %}https://twitter.com/intent/tweet/?url={{ original_page_url }}&text={{ page.title | uri_escape }}{% if site.twitter.username %}&via={{ site.twitter.username }}{% endif %}{% endif -%}
        {%- if id contains "facebook" %}https://facebook.com/sharer/sharer.php?u={{ original_page_url }}{% endif -%}
        {%- if id contains "pinterest" %}https://pinterest.com/pin/create/button/?url={{ original_page_url }}&description={{ page.title }}&media={{ page.image }}{% endif -%}
        {%- if id contains "linkedin" %}https://www.linkedin.com/shareArticle?url={{ original_page_url }}&title={{ page.title }}&source={{ site.title }}&mini=true{% endif -%}
        {%- if id contains "tumblr" %}https://tumblr.com/widgets/share/tool?canonicalUrl={{ original_page_url }}&tags={{ page.category }}&caption={{ page.title }}{% endif -%}
        {%- if id contains "reddit" %}https://reddit.com/submit?url={{ original_page_url }}&title={{ page.title }}&resubmit=true{% endif -%}
        {%- if id contains "hackernews" %}https://news.ycombinator.com/submitlink?u={{ original_page_url }}&t={{ page.title }}{% endif -%}
        {%- if id contains "designernews" %}https://www.designernews.co/submit?url={{ original_page_url }}&title={{ page.title }}{% endif -%}
        {%- if id contains "email" %}mailto:?subject={{ page.title }}&body={{ original_page_url | prepend: "Hey, check out this: "}}{% endif -%}
        {%- if id contains "universalshare" %}javascript:handlePageShare(){% endif -%}
        {%- if id contains "url" %}javascript:handleCopyShortUrl('{{ original_page_url }}', this){% endif -%}
      {% endcapture %}

      {% assign button_text = name %}
      {% assign button_icon = id %}
      
      {% if id == "universalshare" %}
        {% assign button_text = "Share" %}
        {% assign button_icon = "share" %}
      {% elsif id == "url" %}
        {% assign button_text = "Copy Link" %}
        {% assign button_icon = "link" %}
      {% endif %}

      {% include button.html text=button_text icon=button_icon link=share_link color=color %}
    {% endif %}
  {% endfor %}

  <!-- 引入 SparkMD5 库，用于同步计算哈希 -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/spark-md5/3.0.2/spark-md5.min.js"></script>
  
  <script>
    const SHORTENER_SERVICE_DOMAIN = 'https://url.true-dhamma.com';

    /**
     *  使用 SparkMD5 同步地从一个URL生成一个6位的短代码。
     *  此算法必须与Cloudflare Worker中的算法完全一致。
     *  @param {string} url - 原始长链接
     *  @returns {string} - 返回6位的短代码
     */
    function generateShortCodeFromUrl(url) {
      // 1. 使用MD5计算哈希值 (同步操作)
      const hash = SparkMD5.hash(url);
      
      // 2. 将哈希值转换为一个数字 (取前8位十六进制，转为10进制整数)
      const num = parseInt(hash.substring(0, 8), 16);
      
      // 3. 使用Base36编码 (0-9, a-z) 将数字转换为更短的字符串
      //    这样分布更均匀，且能表示更大的数
      const base36 = num.toString(36);
      
      // 4. 取前6位，并转换为大写，如果不足6位则用'A'填充
      return base36.substring(0, 6).toUpperCase().padStart(6, 'A');
    }

    /**
     *  处理点击“拷贝链接”按钮的最终解决方案
     */
    function handleCopyShortUrl(originalUrl, buttonElement) {
      const originalText = buttonElement.innerHTML;
      buttonElement.innerHTML = '正在处理...';
      buttonElement.disabled = true;

      // --- 核心逻辑：完全同步执行 ---
      try {
        // 1. 同步计算出短链代码和完整的短链接
        const shortCode = generateShortCodeFromUrl(originalUrl);
        const shortUrl = `${SHORTENER_SERVICE_DOMAIN}/${shortCode}`;

        // 2. 立即将预测的短链接复制到剪贴板
        // copyToClipboard 内部会尝试新的API，如果失败会同步回退到旧的API
        copyToClipboard(shortUrl, '短链接已复制！', () => {
          // 成功回调
          buttonElement.innerHTML = '已复制！';
        }, () => {
          // 失败回调
          alert('无法自动复制，请手动选择复制：' + shortUrl);
          buttonElement.innerHTML = '复制失败';
        });

      } catch (error) {
        console.error('Error predicting or copying short link:', error);
        alert('处理失败，已为您复制原始链接。');
        copyToClipboard(originalUrl, '原始链接已复制。', () => {
           buttonElement.innerHTML = '已复制！';
        }, () => {
           buttonElement.innerHTML = '复制失败';
        });
      }
      // --- 同步逻辑结束 ---

      // 3. 在后台默默地请求worker创建链接 (fire-and-forget)
      //    这个异步操作在所有复制逻辑完成后执行，不会影响复制成功率
      fetch(`${SHORTENER_SERVICE_DOMAIN}/?create=` + encodeURIComponent(originalUrl))
        .then(response => {
          if (!response.ok) console.error('Short link creation in background failed.');
        })
        .catch(error => console.error('Error creating short link in background:', error));
      
      // 恢复按钮状态
      setTimeout(() => {
        buttonElement.innerHTML = originalText;
        buttonElement.disabled = false;
      }, 2000);
    }
    
    /**
     * 将文本复制到剪贴板 (重构以适应同步回调)
     */
    function copyToClipboard(text, successMessage, successCallback, errorCallback) {
      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(text).then(() => {
          alert(successMessage);
          if (successCallback) successCallback();
        }).catch(err => {
          // 如果新API失败 (在iOS上很可能)，立即同步尝试旧方法
          fallbackCopyTextToClipboard(text, successMessage, successCallback, errorCallback);
        });
      } else {
        fallbackCopyTextToClipboard(text, successMessage, successCallback, errorCallback);
      }
    }

    /**
     * 兼容旧版浏览器的剪贴板复制方法 (同步执行)
     */
    function fallbackCopyTextToClipboard(text, successMessage, successCallback, errorCallback) {
      const textArea = document.createElement("textarea");
      textArea.value = text;
      // --- 关键样式，确保在iOS上能被选中 ---
      textArea.style.position = "fixed";
      textArea.style.top = "-9999px";
      textArea.style.left = "-9999px";

      document.body.appendChild(textArea);
      
      // --- 关键操作，确保在iOS上选中成功 ---
      if (navigator.userAgent.match(/ipad|iphone/i)) {
          textArea.contentEditable = true;
          textArea.readOnly = true;
          const range = document.createRange();
          range.selectNodeContents(textArea);
          const selection = window.getSelection();
          selection.removeAllRanges();
          selection.addRange(range);
          textArea.setSelectionRange(0, 999999);
      } else {
          textArea.select();
      }

      let success = false;
      try {
        success = document.execCommand('copy');
      } catch (err) {
        success = false;
      }

      document.body.removeChild(textArea);

      if (success) {
        alert(successMessage);
        if (successCallback) successCallback();
      } else {
        if (errorCallback) errorCallback();
      }
    }

    /**
     * 处理通用的“分享”按钮逻辑
     */
    function handlePageShare() {
      const pageUrl = window.location.href;
      const pageTitle = document.title;

      if (navigator.share) {
        navigator.share({ title: pageTitle, url: pageUrl }).catch(error => {
          if (error.name !== 'AbortError') {
             alert('分享失败，链接已复制到剪贴板。');
             copyToClipboard(pageUrl, '链接已复制！');
          }
        });
      } else {
        copyToClipboard(pageUrl, '链接已复制到剪贴板！');
      }
    }
  </script>
</div>