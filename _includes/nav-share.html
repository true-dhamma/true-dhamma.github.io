<div class="share">
  {% for network in site.sharing_links %}
    {% comment %} 排除 PageShare，因为它需要特殊处理 {% endcomment %}
    {% if network[1] != blank and network[0] != "PageShare" %}
      {% assign name = network[0] %}
      {% assign id = network[0] | downcase | remove: " " %}
      {% assign url = site.url | append: site.baseurl | append: page.url %}
      {% assign color = network[1] %}

      {% capture share_link %}
        {%- if id contains "twitter" %}https://twitter.com/intent/tweet/?url={{ url }}&text={{ page.title | uri_escape }}{% if site.twitter.username %}&via={{ site.twitter.username }}{% endif %}{% endif -%}
        {%- if id contains "facebook" %}https://facebook.com/sharer/sharer.php?u={{ url }}{% endif -%}
        {%- if id contains "pinterest" %}https://pinterest.com/pin/create/button/?url={{ url }}&description={{ page.title }}&media={{ page.image }}{% endif -%}
        {%- if id contains "linkedin" %}https://www.linkedin.com/shareArticle?url={{ url }}&title={{ page.title }}&source={{ site.title }}&mini=true{% endif -%}
        {%- if id contains "tumblr" %}https://tumblr.com/widgets/share/tool?canonicalUrl={{ url }}&tags={{ page.category }}&caption={{ page.title }}{% endif -%}
        {%- if id contains "reddit" %}https://reddit.com/submit?url={{ url }}&title={{ page.title }}&resubmit=true{% endif -%} {# <-- 这里的 {% endif --} 已修正 #}
        {%- if id contains "hackernews" %}https://news.ycombinator.com/submitlink?u={{ url }}&t={{ page.title }}{% endif -%}
        {%- if id contains "designernews" %}https://www.designernews.co/submit?url={{ url }}&title={{ page.title }}{% endif -%}
        {%- if id contains "email" %}mailto:?subject={{ page.title }}&body={{ url | prepend: "Hey, check out this: "}}{% endif -%}
      {% endcapture %}

      {% include button.html text=name icon=id link=share_link color=color %}
    {% endif %}
  {% endfor %}

  {# 添加通用分享按钮，仅当 _config.yml 中 PageShare 为 true 时显示 #}
  {% if site.sharing_links.PageShare %}
    <div class="share-universal-container">
      {# 分享按钮，ID 用于 JavaScript 定位 #}
      {% include button.html text="分享" icon="link" link="#" id="universal-share-button" %}

      {# 二维码容器，初始隐藏 #}
      <div id="qrcode-container" class="qrcode-hidden">
        <div id="qrcode"></div>
        <p>请用手机扫描二维码分享</p>
      </div>
    </div>

    <style>
      /* 仅用于二维码容器的样式，不影响按钮 */
      .qrcode-hidden {
        display: none;
        text-align: center;
        margin-top: 10px;
        /* 确保二维码不会太小，以便扫描 */
        padding: 10px;
        background-color: white;
        border-radius: 5px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      }
      .qrcode-visible {
        display: block;
      }
      #qrcode {
        width: 150px; /* 二维码尺寸 */
        height: 150px; /* 二维码尺寸 */
        margin: 0 auto; /* 居中显示 */
      }
      #qrcode img, #qrcode canvas {
        width: 100%;
        height: 100%;
      }
      #qrcode-container p {
        margin-top: 10px;
        font-size: 0.9em;
        color: #555;
      }
    </style>

    {# 引入 QRCode.js 库，用于生成二维码 #}
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <script>
      document.addEventListener('DOMContentLoaded', function() {
        const shareButton = document.getElementById('universal-share-button');
        const qrcodeContainer = document.getElementById('qrcode-container');
        const qrcodeDiv = document.getElementById('qrcode');
        {# 获取当前页面的完整URL和标题 #}
        const pageUrl = "{{ site.url | append: site.baseurl | append: page.url | absolute_url }}";
        const pageTitle = "{{ page.title | default: site.title | uri_escape }}";

        let qrCodeInstance = null; // 用于存储 QRCode.js 实例，避免重复生成

        if (shareButton) {
          shareButton.addEventListener('click', function(e) {
            e.preventDefault(); // 阻止按钮的默认跳转行为

            if (navigator.share) {
              // 移动设备且支持 Web Share API
              navigator.share({
                title: decodeURIComponent(pageTitle), // 解码标题，确保正确显示中文
                url: pageUrl
              }).then(() => {
                console.log('页面分享成功！');
              }).catch((error) => {
                console.error('分享失败:', error);
              });
            } else {
              // PC 或不支持 Web Share API 的移动设备，显示二维码
              if (qrcodeContainer.classList.contains('qrcode-hidden')) {
                // 显示二维码容器
                qrcodeContainer.classList.remove('qrcode-hidden');
                qrcodeContainer.classList.add('qrcode-visible');

                if (!qrCodeInstance) {
                  // 第一次点击时生成二维码
                  qrCodeInstance = new QRCode(qrcodeDiv, {
                    text: pageUrl,
                    width: 150,
                    height: 150,
                    colorDark : "#000000",
                    colorLight : "#ffffff",
                    correctLevel : QRCode.CorrectLevel.H // 纠错级别为高
                  });
                }
              } else {
                // 如果二维码已显示，则再次点击时隐藏
                qrcodeContainer.classList.remove('qrcode-visible');
                qrcodeContainer.classList.add('qrcode-hidden');
              }
            }
          });
        }
      });
    </script>
  {% endif %}
</div>