<footer class="footer">
  <div class="container">
    <div class="copyright  typeset">
      <small class="small">&copy; {{ site.title }} {{ site.time | date: '%Y' }}</small>
    </div>

    <!-- G-Translate 翻译浮动条控制逻辑 -->
    <div id="gtranslate-block-container">
      <div class="gtranslate_wrapper"></div>
      <script>
        // G-Translate 设置 - 确保它们在脚本加载前定义
        window.gtranslateSettings = {
          "default_language": "zh-CN",
          "detect_browser_language": true, // 保持为 true，以便 G-Translate 首次加载时检测
          "languages": ["zh-CN", "zh-TW", "th", "en"],
          "wrapper_selector": ".gtranslate_wrapper"
        };

        // 动态创建并加载 G-Translate 脚本。
        // 由于我们将始终控制其可见性，所以脚本本身需要加载。
        const gTranslateScript = document.createElement('script');
        gTranslateScript.src = "https://cdn.gtranslate.net/widgets/latest/float.js";
        gTranslateScript.defer = true; // 延迟加载，不阻塞页面渲染
        document.getElementById('gtranslate-block-container').appendChild(gTranslateScript);

        // 获取 G-Translate 包装器元素
        const gTranslateWrapper = document.querySelector('.gtranslate_wrapper');

        // 在脚本加载后立即运行的函数，因为 gTranslateWrapper 可能还没有完全初始化
        gTranslateScript.onload = () => {
            // 获取浏览器首选语言
            const browserLangIsZhCn = navigator.language.startsWith('zh-CN');
            // 从 localStorage 读取用户是否手动设置了浮动条的可见性
            // 'visible' 表示用户希望它显示，'hidden' 表示用户希望它隐藏
            const userOverride = localStorage.getItem('gTranslateOverrideVisibility');

            let initialDisplay = 'none'; // 默认情况下，先隐藏浮动条

            if (userOverride === 'visible') {
                initialDisplay = 'block'; // 用户明确设置为显示
            } else if (userOverride === 'hidden') {
                initialDisplay = 'none'; // 用户明确设置为隐藏
            } else if (!browserLangIsZhCn) {
                // 如果没有用户偏好，且浏览器语言不是简体中文，则默认显示
                initialDisplay = 'block';
            }
            // 否则（浏览器语言是简体中文且无用户偏好），保持为 'none'

            gTranslateWrapper.style.display = initialDisplay;
        };


        /**
         * 全局函数：用于切换 G-Translate 浮动条的可见性。
         * 每次切换时，都会将用户的选择存储到 localStorage。
         */
        window.toggleGTranslateVisibility = function() {
          const currentDisplay = gTranslateWrapper.style.display;

          if (currentDisplay === 'none') {
            gTranslateWrapper.style.display = 'block';
            // 用户点击了显示，所以保存偏好为 'visible'
            localStorage.setItem('gTranslateOverrideVisibility', 'visible');
          } else {
            gTranslateWrapper.style.display = 'none';
            // 用户点击了隐藏，所以保存偏好为 'hidden'
            localStorage.setItem('gTranslateOverrideVisibility', 'hidden');
          }
        };
      </script>
    </div>
    <!-- G-Translate 翻译浮动条控制逻辑 结束 -->

<!-- ===================================================================== -->
<!-- Darkmode.js Initialization Script (FINAL ROBUST VERSION) -->
<!-- ===================================================================== -->

<!-- 1. Load the LOCAL JavaScript file -->
<script src="/assets/darkmode-js.min.js"></script>

<!-- 2. Configure and activate the library with direct style manipulation -->
<script>
  document.addEventListener('DOMContentLoaded', function() {
  
    const options = {
      time: '0.5s',
      saveInCookies: true,
      label: '🌓',
      autoMatchOsTheme: true
    };

    const darkmode = new Darkmode(options);
    darkmode.showWidget();

    // Use a small delay to ensure the widget elements are 100% created by the library
    setTimeout(function() {
      const widget = document.querySelector('.darkmode-widget');
      const placeholder = document.getElementById('darkmode-placeholder');
      
      if (widget && placeholder) {
        // Find the sub-elements created by the library
        const layer = widget.querySelector('.darkmode-layer');
        const toggle = widget.querySelector('.darkmode-toggle');

        // ---- Direct Style Injection via JavaScript ----
        // This has the highest priority and will override any library styles.

        // CRITICAL: This fixes the color inversion problem by force-hiding the layer.
        if (layer) {
          layer.style.display = 'none';
        }
        
        // This styles the button itself to match your requirements.
        if (toggle) {
          toggle.style.background = 'transparent';
          toggle.style.border = '1px solid transparent';
          toggle.style.width = '40px';
          toggle.style.height = '40px';
          toggle.style.borderRadius = '6px';
          toggle.style.fontSize = '22px';
          toggle.style.display = 'flex';
          toggle.style.alignItems = 'center';
          toggle.style.justifyContent = 'center';
          toggle.style.cursor = 'pointer';
        }
        
        // CRITICAL: This fixes the positioning problem by overriding 'position: fixed'.
        widget.style.position = 'static';
        widget.style.display = 'inline-flex';
        widget.style.verticalAlign = 'middle';
        widget.style.marginLeft = '.4rem';
        
        // Finally, move the fully styled widget into our placeholder.
        placeholder.appendChild(widget);

      } else {
        // If it still fails, these logs in the browser console (F12) will tell us why.
        if (!widget) console.error("Error: Darkmode widget not found in DOM.");
        if (!placeholder) console.error("Error: Placeholder element #darkmode-placeholder not found in DOM.");
      }
    }, 150); // A 150ms delay is a safe margin

  });
</script>
<!-- ===================================================================== -->
<!--  FINAL Dark Mode CSS - High Priority Override -->
<!-- ===================================================================== -->
<style>
  /* 1. Define Color Variables for Both Modes */
  :root {
    --bg-color: #ffffff;
    --text-color: #34495e;
    --heading-color: #2c3e50;
    --link-color: #3A77D8;
    --link-hover-color: #2e60ad;
    --feature-bg-color: #f4f6f8;
    --code-bg-color: #fafafa;
    --footer-bg-color: #2c3e50;
    --footer-text-color: #a8adac;
    --footer-link-hover-color: #ffffff;
    --blockquote-border-color: #e0e0e0;
    --button-text-color: #ffffff;
    --accent-color: #3A77D8;
  }

  body.darkmode--activated {
    --bg-color: #1a202c;
    --text-color: #a0aec0;
    --heading-color: #e2e8f0;
    --link-color: #63b3ed;
    --link-hover-color: #90cdf4;
    --feature-bg-color: #2d3748;
    --code-bg-color: #2d3748;
    --footer-bg-color: #171923;
    --footer-text-color: #718096;
    --footer-link-hover-color: #e2e8f0;
    --blockquote-border-color: #4a5568;
    --button-text-color: #1a202c;
    --accent-color: #63b3ed;
  }

  /* 2. Force Apply Variables to Elements using  !important */
  /* This ensures these rules win against your compiled CSS */
  body {
    background-color: var(--bg-color) !important;
    color: var(--text-color) !important;
    transition: color 0.3s ease, background-color 0.3s ease;
  }
  h1, h2, h3, h4, h5, h6 { color: var(--heading-color) !important; }
  a { color: var(--link-color) !important; }
  a:hover { color: var(--link-hover-color) !important; }
  .feature { background: var(--feature-bg-color) !important; }
  .footer { background: var(--footer-bg-color) !important; color: var(--footer-text-color) !important; }
  .footer a { color: var(--footer-text-color) !important; }
  .footer a:hover { color: var(--footer-link-hover-color) !important; }
  code, pre { background-color: var(--code-bg-color) !important; color: var(--heading-color) !important; }
  blockquote { border-left-color: var(--blockquote-border-color) !important; }
  input[type="submit"], button, .button { background: var(--accent-color) !important; color: var(--button-text-color) !important; }

  /* 3. Force Style and Position the Widget */
  #darkmode-placeholder {
    display: inline-flex;
    align-items: center;
    justify-content: center;
  }
  div.darkmode-widget {
    position: static !important;
    display: inline-flex !important;
    vertical-align: middle !important;
    margin-left: .4rem !important;
  }
  /* CRITICAL: This hides the color-inverting layer, fixing the color issue */
  div.darkmode-widget .darkmode-layer {
    display: none !important;
  }
  div.darkmode-widget .darkmode-toggle {
    background: transparent !important;
    border: 1px solid transparent !important;
    width: 40px !important;
    height: 40px !important;
    padding: 0 !important;
    border-radius: 6px !important;
    font-size: 22px !important;
    transition: background-color 0.2s ease !important;
    cursor: pointer !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
  }
  div.darkmode-widget .darkmode-toggle:hover {
    background-color: var(--feature-bg-color) !important;
  }
  body.darkmode--activated img {
    filter: brightness(.85) contrast(1.05);
  }
</style>
<!-- ===================================================================== -->

    {% include nav-footer.html %}
  </div>
</footer>