<script>
(function() {
  /*
    完美修正版：
    1. 修复 Hypothesis 问题：将 Hypothesis 排除在 JS 遍历之外，仅通过 CSS 在夜间模式下定向反转。
       (解决了白天变黑、位置错乱、以及夜间位置错乱的问题)
    2. 保持 FAB 悬浮：继续使用 Body 无滤镜 + 子元素反转策略。
    3. 保持原始样式还原：严格保留你对图片和 Feature 区域的亮度参数。
  */

  const STORAGE_KEY = "nightowl-color-scheme";
  const LIGHT_THEME = "light";
  const DARK_THEME = "dark";
  
  let localStorageAvailable = false;
  let currentTheme;

  try {
    if (localStorage) localStorageAvailable = true;
  } catch (e) { console.warn("localStorage unavailable"); }

  function addNightOwlStyles() {
    const styleElement = document.createElement("style");
    styleElement.innerHTML = `
      /* --- 1. 基础清理 --- */
      .nightowl-light body,
      .nightowl-light .nightowl-inverted {
        filter: none !important;
      }
      
      /* --- 2. 暗色模式底板 --- */
      .nightowl-dark body {
        background-color: #111 !important;
        /* Body 保持无 Filter，确保 fab 和 hypothesis 定位正常 */
      }

      /* --- 3. 核心滤镜 (通用) --- */
      /* 应用于主要内容区域，但不应用于 Hypothesis */
      .nightowl-inverted {
        filter: invert(100%) hue-rotate(20deg);
      }
      
      /* --- 4. Hypothesis 专属处理 (关键修复) --- */
      /* 
         只有在 .nightowl-dark 激活时才反转。
         不通过 JS 添加类名，而是直接通过标签名选择，防止 JS 干扰其内部定位。
      */
      .nightowl-dark hypothesis-sidebar,
      .nightowl-dark hypothesis-adder,
      .nightowl-dark hypothesis-highlight-cluster {
        filter: invert(100%) hue-rotate(20deg);
      }

      /* --- 5. 图片/视频还原 (参数：brightness 1.6) --- */
      .nightowl-inverted img, 
      .nightowl-inverted video, 
      .nightowl-inverted iframe, 
      .nightowl-inverted .custom-cover-layer, 
      .nightowl-inverted .nightowl-daylight {
        filter: invert(100%) hue-rotate(340deg) contrast(1.1) saturate(1.1) brightness(1.6);
        opacity: 0.8;
      }

      /* --- 6. .feature 区域还原 (参数：brightness 1.0) --- */
      .nightowl-inverted .feature {
        filter: invert(100%) hue-rotate(340deg) contrast(1.1) saturate(1.1) brightness(1);
        opacity: 0.8;
      }

      /* --- 7. 视频全屏修复 --- */
      .nightowl-inverted video:fullscreen,
      .nightowl-inverted video:-webkit-full-screen,
      .nightowl-inverted .plyr:fullscreen video,
      .nightowl-inverted .plyr:-webkit-full-screen video,
      .nightowl-inverted .plyr:fullscreen .custom-cover-layer,
      .nightowl-inverted .plyr:-webkit-full-screen .custom-cover-layer {
        filter: none !important;
        opacity: 1;
      }

      /* --- 8. 文本与代码细节 --- */
      .nightowl-inverted h1, .nightowl-inverted h2, .nightowl-inverted h3, 
      .nightowl-inverted h4, .nightowl-inverted h5, .nightowl-inverted h6, 
      .nightowl-inverted p, .nightowl-inverted strong, .nightowl-inverted a, 
      .nightowl-inverted li, .nightowl-inverted span, .nightowl-inverted b {
        filter: brightness(0.6);
      }

      .nightowl-inverted pre {
        filter: invert(6%);
      }

      .nightowl-inverted li::marker {
        color: #666;
      }
    `;
    document.head.appendChild(styleElement);
  }

  // --- JS 逻辑优化：排除 Hypothesis ---
  
  function toggleInvertedClass(enable) {
    const children = document.body.children;
    for (let i = 0; i < children.length; i++) {
      const child = children[i];
      const tag = child.tagName.toLowerCase();

      // 1. 排除非视觉元素
      // 2. 关键：排除 hypothesis 开头的元素，完全交给 CSS 处理，防止定位干扰
      if (['script', 'style', 'link', 'meta', 'title'].includes(tag) || tag.startsWith('hypothesis')) {
        continue;
      }
      
      if (enable) {
        child.classList.add('nightowl-inverted');
      } else {
        child.classList.remove('nightowl-inverted');
      }
    }
  }

  function setDarkTheme() {
    document.documentElement.classList.remove("nightowl-light");
    document.documentElement.classList.add("nightowl-dark");
    toggleInvertedClass(true);
  }

  function setLightTheme() {
    document.documentElement.classList.remove("nightowl-dark");
    document.documentElement.classList.add("nightowl-light");
    toggleInvertedClass(false);
  }
  
  function toggleTheme() {
    const isDark = document.documentElement.classList.contains('nightowl-dark');
    currentTheme = isDark ? LIGHT_THEME : DARK_THEME;
    currentTheme === DARK_THEME ? setDarkTheme() : setLightTheme();
    saveThemeState();
  }

  function saveThemeState() {
    if (!localStorageAvailable) return;
    try { localStorage.setItem(STORAGE_KEY, currentTheme); } catch (e) {}
  }

  document.addEventListener("DOMContentLoaded", () => {
    addNightOwlStyles();
    
    try {
      if (localStorage.getItem(STORAGE_KEY) === DARK_THEME || document.documentElement.classList.contains("nightowl-dark")) {
         toggleInvertedClass(true);
      }
    } catch(e) {}

    const darkModeSwitcher = document.getElementById("darkmode-switch");
    if (darkModeSwitcher) {
      darkModeSwitcher.addEventListener("click", (event) => {
        event.preventDefault();
        toggleTheme();
      });
    }
    
    // 监听器也需要过滤 hypothesis，防止它被错误地加上通用滤镜类
    const observer = new MutationObserver((mutations) => {
       if (document.documentElement.classList.contains("nightowl-dark")) {
         mutations.forEach((mutation) => {
           mutation.addedNodes.forEach((node) => {
             // 确保是元素节点，且不是 script/style，且不是 hypothesis
             if (node.nodeType === 1) {
               const tag = node.tagName.toLowerCase();
               if (!['script', 'style', 'link'].includes(tag) && !tag.startsWith('hypothesis')) {
                 node.classList.add('nightowl-inverted');
               }
             }
           });
         });
       }
    });
    observer.observe(document.body, { childList: true });
  });

})();
</script>