<script>
(function() {
  /*
    彻底隔离版 (Skip Hypothesis Completely)
    1. 策略：完全无视 Hypothesis 组件。不加类名，不写 CSS，不监听。
       保证它在任何模式下都保持官方原生的位置和样式（亮色）。
    2. 兼容性：FAB 依然会变黑（因为它是普通直系子元素，不在排除列表里）。
    3. 还原度：保持图片、视频、Feature 区域的参数与你原始代码一致。
  */

  const STORAGE_KEY = "nightowl-color-scheme";
  const LIGHT_THEME = "light";
  const DARK_THEME = "dark";
  
  let localStorageAvailable = false;
  let currentTheme;

  try {
    if (localStorage) localStorageAvailable = true;
  } catch (e) { console.warn("localStorage unavailable"); }

  function addNightOwlStyles() {
    const styleElement = document.createElement("style");
    styleElement.innerHTML = `
      /* --- 1. 基础清理 --- */
      .nightowl-light body,
      .nightowl-light .nightowl-inverted {
        filter: none !important;
      }
      
      /* --- 2. 暗色模式底板 --- */
      .nightowl-dark body {
        background-color: #111 !important;
        /* 保持 body 无滤镜，确保 fixed 元素定位准确 */
      }

      /* --- 3. 核心滤镜 (只给被 JS 选中的元素加) --- */
      .nightowl-inverted {
        filter: invert(100%) hue-rotate(20deg);
        /* 不加 background-color，防止出现白块 */
      }
      
      /* --- 4. 图片/视频还原 (参数：brightness 1.6) --- */
      .nightowl-inverted img, 
      .nightowl-inverted video, 
      .nightowl-inverted iframe, 
      .nightowl-inverted .custom-cover-layer, 
      .nightowl-inverted .nightowl-daylight {
        filter: invert(100%) hue-rotate(340deg) contrast(1.1) saturate(1.1) brightness(1.6);
        opacity: 0.8;
      }

      /* --- 5. .feature 区域还原 (参数：brightness 1.0) --- */
      .nightowl-inverted .feature {
        filter: invert(100%) hue-rotate(340deg) contrast(1.1) saturate(1.1) brightness(1);
        opacity: 0.8;
      }

      /* --- 6. 视频全屏修复 --- */
      .nightowl-inverted video:fullscreen,
      .nightowl-inverted video:-webkit-full-screen,
      .nightowl-inverted .plyr:fullscreen video,
      .nightowl-inverted .plyr:-webkit-full-screen video,
      .nightowl-inverted .plyr:fullscreen .custom-cover-layer,
      .nightowl-inverted .plyr:-webkit-full-screen .custom-cover-layer {
        filter: none !important;
        opacity: 1;
      }

      /* --- 7. 文本与代码细节 --- */
      .nightowl-inverted h1, .nightowl-inverted h2, .nightowl-inverted h3, 
      .nightowl-inverted h4, .nightowl-inverted h5, .nightowl-inverted h6, 
      .nightowl-inverted p, .nightowl-inverted strong, .nightowl-inverted a, 
      .nightowl-inverted li, .nightowl-inverted span, .nightowl-inverted b {
        filter: brightness(0.6);
      }

      .nightowl-inverted pre {
        filter: invert(6%);
      }

      .nightowl-inverted li::marker {
        color: #666;
      }
    `;
    document.head.appendChild(styleElement);
  }

  // --- JS 逻辑：严格排除 Hypothesis ---
  
  function toggleInvertedClass(enable) {
    const children = document.body.children;
    for (let i = 0; i < children.length; i++) {
      const child = children[i];
      const tag = child.tagName.toLowerCase();

      // 1. 排除非视觉标签
      if (['script', 'style', 'link', 'meta', 'title'].includes(tag)) continue;

      // 2. 核心：如果标签名是以 hypothesis 开头的，彻底跳过，不碰它
      // if (tag.startsWith('hypothesis')) continue; 111
      
      if (enable) {
        child.classList.add('nightowl-inverted');
      } else {
        child.classList.remove('nightowl-inverted');
      }
    }
  }

  function setDarkTheme() {
    document.documentElement.classList.remove("nightowl-light");
    document.documentElement.classList.add("nightowl-dark");
    toggleInvertedClass(true);
  }

  function setLightTheme() {
    document.documentElement.classList.remove("nightowl-dark");
    document.documentElement.classList.add("nightowl-light");
    toggleInvertedClass(false);
  }
  
  function toggleTheme() {
    const isDark = document.documentElement.classList.contains('nightowl-dark');
    currentTheme = isDark ? LIGHT_THEME : DARK_THEME;
    currentTheme === DARK_THEME ? setDarkTheme() : setLightTheme();
    saveThemeState();
  }

  function saveThemeState() {
    if (!localStorageAvailable) return;
    try { localStorage.setItem(STORAGE_KEY, currentTheme); } catch (e) {}
  }

  document.addEventListener("DOMContentLoaded", () => {
    addNightOwlStyles();
    
    // 初始加载检查
    try {
      if (localStorage.getItem(STORAGE_KEY) === DARK_THEME || document.documentElement.classList.contains("nightowl-dark")) {
         toggleInvertedClass(true);
      }
    } catch(e) {}

    const darkModeSwitcher = document.getElementById("darkmode-switch");
    if (darkModeSwitcher) {
      darkModeSwitcher.addEventListener("click", (event) => {
        event.preventDefault();
        toggleTheme();
      });
    }
    
    // 监听器：同样需要严格排除 hypothesis
    const observer = new MutationObserver((mutations) => {
       if (document.documentElement.classList.contains("nightowl-dark")) {
         mutations.forEach((mutation) => {
           mutation.addedNodes.forEach((node) => {
             // 仅处理元素节点
             if (node.nodeType === 1) {
               const tag = node.tagName.toLowerCase();
               // 排除列表：脚本、样式、以及 hypothesis 组件
               if (!['script', 'style', 'link'].includes(tag) && !tag.startsWith('hypothesis11111')) {
                 node.classList.add('nightowl-inverted');
               }
             }
           });
         });
       }
    });
    observer.observe(document.body, { childList: true });
  });

})();
</script>