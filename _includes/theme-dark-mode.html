<script>
(function() {
  /*
    Dark Model - 可配置增强版
    1. 配置项 (CONFIG) 提取到了最上方，方便修改。
    2. 自动处理 Plyr 字幕、背景和 Hypothesis 的排除逻辑。
  */

  // =========================================================
  //  1. 用户配置区域 (在此处添加不需要反色的东西)
  // =========================================================
  const CONFIG = {
    storageKey: "nightowl-color-scheme",
    
    // [A] JS 逻辑跳过列表：
    // 这些元素如果是 body 的直接子元素，脚本完全不会去碰它。
    // 适用于：Hypothesis 侧边栏、浮动工具栏、第三方插件容器。
    skipDetection: {
      tags: ['script', 'style', 'link', 'meta', 'title', 'noscript'],
      prefixes: ['hypothesis'], // ID 或 Tag 以此开头 (例如 hypothesis-sidebar)
      classes: [] // 如果某个顶层 div 包含此 class，则跳过 (例如 'ignore-dark-mode')
    },

    // [B] CSS 视觉还原列表：
    // 这些元素在暗色模式下会被“再次反色”从而恢复原貌。
    // 适用于：图片、视频、Iframe、Plyr 播放器、字幕层、封面图。
    restoreSelectors: [
      'img', 
      'video', 
      'iframe', 
      '.custom-cover-layer',    // 自定义封面
      '.nightowl-daylight',     // 手动指定的白底区域
      '.feature',               // 原本代码中的 feature
      
      // --- Plyr 视频播放器相关 ---
      '.plyr',                  // Plyr 主容器
      //'.plyr-custom-wrapper',   // Includes 里的外层容器
      '.plyr__captions',        // 字幕容器
      '.plyr__controls',        // 控制栏
      //'.plyr__poster'           // 官方封面
    ]
  };

  // =========================================================
  //  2. 核心逻辑
  // =========================================================

  const LIGHT_THEME = "light";
  const DARK_THEME = "dark";
  
  let localStorageAvailable = false;
  let currentTheme;

  try {
    if (localStorage) localStorageAvailable = true;
  } catch (e) { console.warn("localStorage unavailable"); }

  // 辅助函数：判断是否应该跳过该元素 (基于 CONFIG.skipDetection)
  function shouldSkipElement(node) {
    if (!node || node.nodeType !== 1) return true; // 非元素节点跳过

    const tagName = node.tagName.toLowerCase();
    const id = node.id ? node.id.toLowerCase() : "";
    const classList = node.classList;

    // 1. 检查标签名
    if (CONFIG.skipDetection.tags.includes(tagName)) return true;

    // 2. 检查前缀 (Tag 或 ID 以某字符串开头)
    for (const prefix of CONFIG.skipDetection.prefixes) {
      if (tagName.startsWith(prefix) || id.startsWith(prefix)) return true;
    }

    // 3. 检查 Class
    for (const cls of CONFIG.skipDetection.classes) {
      if (classList.contains(cls)) return true;
    }

    return false;
  }

  function addNightOwlStyles() {
    const styleElement = document.createElement("style");
    
    // 动态生成还原列表的 CSS 选择器
    // 结果类似: .nightowl-inverted img, .nightowl-inverted .plyr, ...
    const restoreSelectorString = CONFIG.restoreSelectors
      .map(sel => `.nightowl-inverted ${sel}`)
      .join(',\n      ');

    styleElement.innerHTML = `
      /* --- 基础清理 --- */
      .nightowl-light body,
      .nightowl-light .nightowl-inverted {
        filter: none !important;
      }
      
      /* --- 暗色模式底板 --- */
      .nightowl-dark body {
        background-color: #111 !important;
      }

      /* --- 核心滤镜 --- */
      .nightowl-inverted {
        filter: invert(100%) hue-rotate(20deg);
      }
      
      /* --- 动态生成的还原列表 (图片/视频/Plyr) --- */
      ${restoreSelectorString} {
        filter: invert(100%) hue-rotate(340deg) contrast(1.1) saturate(1.1) brightness(1.6);
        opacity: 0.8;
      }

      /* --- 单独微调 feature (保持你原来的亮度 1) --- */
      .nightowl-inverted .feature {
        filter: invert(100%) hue-rotate(340deg) contrast(1.1) saturate(1.1) brightness(1) !important;
      }

      /* --- 全屏/视频修复 --- */
      .nightowl-inverted video:fullscreen,
      .nightowl-inverted video:-webkit-full-screen,
      .nightowl-inverted .plyr:fullscreen video,
      .nightowl-inverted .plyr:-webkit-full-screen video,
      .nightowl-inverted .plyr--fullscreen-active {
        filter: none !important;
        opacity: 1;
      }

      /* --- 文本细节 --- */
      .nightowl-inverted h1, .nightowl-inverted h2, .nightowl-inverted h3, 
      .nightowl-inverted h4, .nightowl-inverted h5, .nightowl-inverted h6, 
      .nightowl-inverted p, .nightowl-inverted strong, .nightowl-inverted a, 
      .nightowl-inverted li, .nightowl-inverted span, .nightowl-inverted b {
        filter: brightness(0.6);
      }

      .nightowl-inverted pre { filter: invert(6%); }
      .nightowl-inverted li::marker { color: #666; }
    `;
    document.head.appendChild(styleElement);
  }

  function toggleInvertedClass(enable) {
    const children = document.body.children;
    for (let i = 0; i < children.length; i++) {
      const child = children[i];
      
      // 使用新的配置函数判断是否跳过
      if (shouldSkipElement(child)) continue;
      
      if (enable) {
        child.classList.add('nightowl-inverted');
      } else {
        child.classList.remove('nightowl-inverted');
      }
    }
  }

  function setDarkTheme() {
    document.documentElement.classList.remove("nightowl-light");
    document.documentElement.classList.add("nightowl-dark");
    toggleInvertedClass(true);
  }

  function setLightTheme() {
    document.documentElement.classList.remove("nightowl-dark");
    document.documentElement.classList.add("nightowl-light");
    toggleInvertedClass(false);
  }
  
  function toggleTheme() {
    const isDark = document.documentElement.classList.contains('nightowl-dark');
    currentTheme = isDark ? LIGHT_THEME : DARK_THEME;
    currentTheme === DARK_THEME ? setDarkTheme() : setLightTheme();
    saveThemeState();
  }

  function saveThemeState() {
    if (!localStorageAvailable) return;
    try { localStorage.setItem(CONFIG.storageKey, currentTheme); } catch (e) {}
  }

  document.addEventListener("DOMContentLoaded", () => {
    addNightOwlStyles();
    
    try {
      if (localStorage.getItem(CONFIG.storageKey) === DARK_THEME || document.documentElement.classList.contains("nightowl-dark")) {
         toggleInvertedClass(true);
      }
    } catch(e) {}

    const darkModeSwitcher = document.getElementById("darkmode-switch");
    if (darkModeSwitcher) {
      darkModeSwitcher.addEventListener("click", (event) => {
        event.preventDefault();
        toggleTheme();
      });
    }
    
    // 监听器：使用相同的判断逻辑
    const observer = new MutationObserver((mutations) => {
       if (document.documentElement.classList.contains("nightowl-dark")) {
         mutations.forEach((mutation) => {
           mutation.addedNodes.forEach((node) => {
             if (node.nodeType === 1) {
               if (!shouldSkipElement(node)) {
                 node.classList.add('nightowl-inverted');
               }
             }
           });
         });
       }
    });
    observer.observe(document.body, { childList: true });
  });

})();
</script>