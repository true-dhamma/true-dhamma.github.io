<script>
(function() {
  /*
    最终严格还原版：
    1. 机制：自动给 body 直系子元素加滤镜 (解决 fixed 悬浮失效问题)。
    2. 还原度：严格区分 .feature 和 img/video 的亮度参数，与用户源码完全一致。
  */

  const STORAGE_KEY = "nightowl-color-scheme";
  const LIGHT_THEME = "light";
  const DARK_THEME = "dark";
  
  let localStorageAvailable = false;
  let currentTheme;

  try {
    if (localStorage) localStorageAvailable = true;
  } catch (e) { console.warn("localStorage unavailable"); }

  function addNightOwlStyles() {
    const styleElement = document.createElement("style");
    styleElement.innerHTML = `
      /* --- 1. 基础环境设置 --- */
      .nightowl-light body,
      .nightowl-light .nightowl-inverted {
        filter: none !important;
      }
      
      .nightowl-dark body {
        background-color: #111; /* 仅设背景，不设滤镜 */
      }

      /* --- 2. 核心滤镜 (替代原来的 .nightowl-dark body) --- */
      /* 应用于 body 的直系子元素 */
      .nightowl-inverted {
        filter: invert(100%) hue-rotate(20deg);
        background-color: inherit;
      }
      
      /* 强制反转 Hypothesis */
      hypothesis-sidebar,
      hypothesis-adder {
        filter: invert(100%) hue-rotate(20deg) !important;
      }

      /* --- 3. 图片/视频还原 (参数：brightness 1.6) --- */
      /* 对应原代码：.nightowl-dark img, video, iframe ... */
      .nightowl-inverted img, 
      .nightowl-inverted video, 
      .nightowl-inverted iframe, 
      .nightowl-inverted .custom-cover-layer, 
      .nightowl-inverted .nightowl-daylight {
        filter: invert(100%) hue-rotate(340deg) contrast(1.1) saturate(1.1) brightness(1.6);
        opacity: 0.8;
      }

      /* --- 4. .feature 区域还原 (参数：brightness 1.0) --- */
      /* 
         修正：这里单独列出，严格还原你原来的 brightness(1) 
         原代码：.nightowl-dark .feature { ... brightness(1); ... }
      */
      .nightowl-inverted .feature {
        filter: invert(100%) hue-rotate(340deg) contrast(1.1) saturate(1.1) brightness(1);
        opacity: 0.8;
      }

      /* --- 5. 视频全屏特殊处理 --- */
      .nightowl-inverted video:fullscreen,
      .nightowl-inverted video:-webkit-full-screen,
      .nightowl-inverted .plyr:fullscreen video,
      .nightowl-inverted .plyr:-webkit-full-screen video,
      .nightowl-inverted .plyr:fullscreen .custom-cover-layer,
      .nightowl-inverted .plyr:-webkit-full-screen .custom-cover-layer {
        filter: none !important;
        opacity: 1;
      }

      /* --- 6. 文本与代码细节 (参数完全一致) --- */
      .nightowl-inverted h1, .nightowl-inverted h2, .nightowl-inverted h3, 
      .nightowl-inverted h4, .nightowl-inverted h5, .nightowl-inverted h6, 
      .nightowl-inverted p, .nightowl-inverted strong, .nightowl-inverted a, 
      .nightowl-inverted li, .nightowl-inverted span, .nightowl-inverted b {
        filter: brightness(0.6);
      }

      /* 代码块 */
      .nightowl-inverted pre {
        filter: invert(6%);
      }

      /* 列表项标记 */
      .nightowl-inverted li::marker {
        color: #666;
      }
    `;
    document.head.appendChild(styleElement);
  }

  // --- 下面的 JS 逻辑只负责遍历元素，不影响样式参数 ---
  
  function toggleInvertedClass(enable) {
    const children = document.body.children;
    for (let i = 0; i < children.length; i++) {
      const child = children[i];
      // 排除非视觉元素
      if (['script', 'style', 'link', 'meta', 'title'].includes(child.tagName.toLowerCase())) continue;
      
      if (enable) {
        child.classList.add('nightowl-inverted');
      } else {
        child.classList.remove('nightowl-inverted');
      }
    }
  }

  function setDarkTheme() {
    document.documentElement.classList.remove("nightowl-light");
    document.documentElement.classList.add("nightowl-dark");
    toggleInvertedClass(true);
  }

  function setLightTheme() {
    document.documentElement.classList.remove("nightowl-dark");
    document.documentElement.classList.add("nightowl-light");
    toggleInvertedClass(false);
  }
  
  function toggleTheme() {
    const isDark = document.documentElement.classList.contains('nightowl-dark');
    currentTheme = isDark ? LIGHT_THEME : DARK_THEME;
    currentTheme === DARK_THEME ? setDarkTheme() : setLightTheme();
    saveThemeState();
  }

  function saveThemeState() {
    if (!localStorageAvailable) return;
    try { localStorage.setItem(STORAGE_KEY, currentTheme); } catch (e) {}
  }

  document.addEventListener("DOMContentLoaded", () => {
    addNightOwlStyles();
    
    try {
      if (localStorage.getItem(STORAGE_KEY) === DARK_THEME || document.documentElement.classList.contains("nightowl-dark")) {
         toggleInvertedClass(true);
      }
    } catch(e) {}

    const darkModeSwitcher = document.getElementById("darkmode-switch");
    if (darkModeSwitcher) {
      darkModeSwitcher.addEventListener("click", (event) => {
        event.preventDefault();
        toggleTheme();
      });
    }
    
    const observer = new MutationObserver((mutations) => {
       if (document.documentElement.classList.contains("nightowl-dark")) {
         mutations.forEach((mutation) => {
           mutation.addedNodes.forEach((node) => {
             if (node.nodeType === 1 && !['SCRIPT', 'STYLE', 'LINK'].includes(node.tagName)) {
               node.classList.add('nightowl-inverted');
             }
           });
         });
       }
    });
    observer.observe(document.body, { childList: true });
  });

})();
</script>