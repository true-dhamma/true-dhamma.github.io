<!-- 暗色模式功能代码开始 (更新版) -->
<script>
(function() {
  // --- 常量和变量定义 ---
  const STORAGE_KEY = "nightowl-color-scheme";
  const LIGHT_THEME = "light";
  const DARK_THEME = "dark";
  
  let localStorageAvailable = false;
  let currentTheme = LIGHT_THEME; // 默认主题

  // 尝试访问 localStorage
  try {
    if (localStorage) {
      localStorageAvailable = true;
    }
  } catch (e) {
    console.warn("localStorage is not available.");
  }

  // --- 核心功能函数 ---

  /**
   * 1. 注入实现暗色模式所需要的 CSS 样式
   */
  function addNightOwlStyles() {
    const styleElement = document.createElement("style");
    styleElement.innerHTML = `
      /* 防止定位不一致 */
      .nightowl-light body {
        filter: invert(0%);
      }
      
      .nightowl-dark {
        /* Firefox 的后备方案 */
        background-color: #111;
      }

      /* [修改点 1] 在滤镜链中增加了 brightness(60%) 来降低整体亮度 */
      .nightowl-dark body {
        filter: invert(100%) hue-rotate(180deg) brightness(60%);
      }

      /* 
       * [修改点 2] 媒体元素先通过滤镜恢复正常显示，再应用不透明度
       * 这实现了“不反色，仅降低不透明度”的视觉效果
      */
      .nightowl-dark img, .nightowl-dark video, .nightowl-dark iframe, .nightowl-dark .nightowl-daylight {
        filter: invert(100%) hue-rotate(180deg);
        opacity: 0.8;
      }

      /* 改善图标的对比度 */
      .nightowl-dark .icon {
        filter: invert(15%) hue-rotate(180deg);
      }

      /* 重新启用代码块的背景 */
      .nightowl-dark pre {
        filter: invert(6%);
      }

      /* 改善列表项标记的对比度 */
      .nightowl-dark li::marker {
        color: #666;
      }
    `;
    document.head.appendChild(styleElement);
  }

  /**
   * 2. 应用暗色模式
   */
  function setDarkTheme() {
    currentTheme = DARK_THEME;
    const html = document.querySelector("html");
    if (html) {
      html.classList.remove("nightowl-light");
      html.classList.add("nightowl-dark");
    }
  }

  /**
   * 3. 应用亮色模式
   */
  function setLightTheme() {
    currentTheme = LIGHT_THEME;
    const html = document.querySelector("html");
    if (html) {
      html.classList.remove("nightowl-dark");
      html.classList.add("nightowl-light");
    }
  }
  
  /**
   * 4. 根据当前主题状态应用样式
   */
  function applyTheme() {
    if (currentTheme === DARK_THEME) {
      setDarkTheme();
    } else {
      setLightTheme();
    }
  }
  
  /**
   * 5. 切换主题
   */
  function toggleTheme() {
    currentTheme = (currentTheme === DARK_THEME) ? LIGHT_THEME : DARK_THEME;
    applyTheme();
    saveThemeState();
  }

  /**
   * 6. 从 localStorage 读取已保存的主题偏好
   */
  function loadInitialTheme() {
    if (!localStorageAvailable) return;
    
    try {
      const savedTheme = localStorage.getItem(STORAGE_KEY);
      if (savedTheme && [DARK_THEME, LIGHT_THEME].includes(savedTheme)) {
        currentTheme = savedTheme;
      }
    } catch (e) {
      console.error("Failed to read theme from localStorage.", e);
    }
  }
  
  /**
   * 7. 将当前主题状态保存到 localStorage
   */
  function saveThemeState() {
    if (!localStorageAvailable) return;

    if (currentTheme !== null) {
      try {
        localStorage.setItem(STORAGE_KEY, currentTheme);
      } catch (e) {
        console.error("Failed to save theme to localStorage.", e);
      }
    }
  }

  // --- 初始化和事件绑定 ---

  // 当 DOM 加载完成后执行
  document.addEventListener("DOMContentLoaded", () => {
    // 注入样式
    addNightOwlStyles();
    
    // 加载用户偏好并应用主题
    loadInitialTheme();
    applyTheme();
    
    // 找到你的开关并绑定点击事件
    const darkModeSwitcher = document.getElementById("darkmode-switch");
    if (darkModeSwitcher) {
      darkModeSwitcher.addEventListener("click", (event) => {
        event.preventDefault(); // 阻止 a 标签的默认跳转行为
        toggleTheme();
      });
    } else {
      console.warn("Dark mode switch with id 'darkmode-switch' not found.");
    }
  });

})();
</script>
<!-- 暗色模式功能代码结束 -->