<script>
(function() {
  /*
    方案：Overlay Mode (蒙版模式)
    优势：不破坏 position:fixed，不需要修改 HTML 结构
  */

  const STORAGE_KEY = "nightowl-color-scheme";
  const LIGHT_THEME = "light";
  const DARK_THEME = "dark";
  
  let localStorageAvailable = false;
  let currentTheme;

  try {
    if (localStorage) localStorageAvailable = true;
  } catch (e) { console.warn("localStorage unavailable"); }

  function addNightOwlStyles() {
    const styleElement = document.createElement("style");
    styleElement.innerHTML = `
      /* --- 1. 基础清理 --- */
      /* 确保亮色模式下没有任何残留滤镜，修复"必须刷新"的bug */
      .nightowl-light body, 
      .nightowl-light html {
        filter: none !important;
      }
      
      /* --- 2. 暗色模式背景兜底 --- */
      /* 防止滚动出边界看到白色背景 */
      .nightowl-dark body {
        background-color: #111;
        /* 重要：不要在这里加 filter: invert，否则 fixed 会失效 */
      }

      /* --- 3. 核心魔法：全屏滤镜蒙版 --- */
      /* 利用 html::before 生成一个覆盖全屏的层，只处理颜色，不处理交互 */
      .nightowl-dark::before {
        content: " ";
        display: block;
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        z-index: 2147483647; /* 尽可能大的层级，覆盖在 hypothesis 之上 */
        pointer-events: none; /* 关键：允许鼠标点击穿透这层蒙版 */
        
        /* 这里应用原来的核心滤镜 */
        backdrop-filter: invert(100%) hue-rotate(20deg);
        -webkit-backdrop-filter: invert(100%) hue-rotate(20deg); /* Safari 支持 */
      }

      /* --- 4. 图片/视频还原 --- */
      /* 
         原理：
         底层图片被反转(filter) -> 变负片 
         上层蒙版再次反转(backdrop-filter) -> 负片变正片 -> 恢复正常
      */
      .nightowl-dark img, 
      .nightowl-dark video, 
      .nightowl-dark iframe, 
      .nightowl-dark .custom-cover-layer {
        filter: invert(100%) hue-rotate(340deg) contrast(1.1) saturate(1.1) brightness(1.6);
        opacity: 0.8;
      }

      /* Plyr 播放器全屏修复 */
      .nightowl-dark .plyr:fullscreen video {
        filter: none !important;
        opacity: 1;
      }

      /* --- 5. 针对 Hypothesis 和 FAB 的特殊处理 --- */
      /* 
         因为蒙版层级(z-index)极高，覆盖了这些悬浮元素，
         所以它们会被蒙版"反色"，变成暗色风格（这正是我们要的）。
         
         但如果你发现某些悬浮元素不想被变黑，或者变得太奇怪，
         可以在这里单独调整它们的 filter。
         
         通常情况下，不需要额外代码，它们会被蒙版自动处理好。
      */
      
      /* 文本降权 (保持原样) */
      .nightowl-dark h1, .nightowl-dark h2, .nightowl-dark h3, .nightowl-dark p, .nightowl-dark a {
        filter: brightness(0.6);
      }
    `;
    document.head.appendChild(styleElement);
  }

  function setDarkTheme() {
    const html = document.documentElement;
    html.classList.remove("nightowl-light");
    html.classList.add("nightowl-dark");
  }

  function setLightTheme() {
    const html = document.documentElement;
    html.classList.remove("nightowl-dark");
    html.classList.add("nightowl-light");
  }
  
  function toggleTheme() {
    const isDark = document.documentElement.classList.contains('nightowl-dark');
    currentTheme = isDark ? LIGHT_THEME : DARK_THEME;
    currentTheme === DARK_THEME ? setDarkTheme() : setLightTheme();
    saveThemeState();
  }

  function saveThemeState() {
    if (!localStorageAvailable) return;
    try { localStorage.setItem(STORAGE_KEY, currentTheme); } catch (e) {}
  }

  document.addEventListener("DOMContentLoaded", () => {
    addNightOwlStyles();
    const darkModeSwitcher = document.getElementById("darkmode-switch");
    if (darkModeSwitcher) {
      darkModeSwitcher.addEventListener("click", (event) => {
        event.preventDefault();
        toggleTheme();
      });
    }
  });
})();
</script>