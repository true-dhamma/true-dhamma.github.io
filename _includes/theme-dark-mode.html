<!-- 暗色模式功能代码开始 (v2) -->
<script>
(function() {
  // --- 常量和变量定义 ---
  const STORAGE_KEY = "nightowl-color-scheme";
  const LIGHT_THEME = "light";
  const DARK_THEME = "dark";
  
  let localStorageAvailable = false;
  let currentTheme = LIGHT_THEME; // 默认主题

  // 尝试访问 localStorage
  try {
    if (localStorage) {
      localStorageAvailable = true;
    }
  } catch (e) {
    console.warn("localStorage is not available.");
  }

  // --- 核心功能函数 ---

  /**
   * 1. 注入暗色模式所需的CSS样式
   */
  function addNightOwlStyles() {
    const styleElement = document.createElement("style");
    styleElement.innerHTML = `
      /* 亮色模式：无滤镜 */
      .nightowl-light body {
        filter: invert(0%);
      }
      
      /* 暗色模式：备用深色背景 */
      .nightowl-dark {
        background-color: #111;
      }

      /* 暗色模式：核心反色滤镜 (应用到整个页面) */
      .nightowl-dark body {
        filter: invert(100%) hue-rotate(180deg);
      }

      /* 还原图片/视频：抵消body滤镜，恢复原色并调暗 */
      .nightowl-dark img, .nightowl-dark video, .nightowl-dark iframe, .nightowl-dark .nightowl-daylight {
        filter: invert(100%) hue-rotate(180deg) contrast(1.1) saturate(1.2);
        opacity: 0.8;
      }
      
      /* 【新增代码】全屏视频特殊处理：移除恢复滤镜，避免被单独反转 */
      .nightowl-dark video:fullscreen,
      .nightowl-dark video:-webkit-full-screen { /* 兼容旧版Chrome/Safari */
        filter: none;
        opacity: 1;
      }
      
      /* 还原.feature区：抵消body滤镜，恢复原色并调暗 */
      .nightowl-dark .feature {
        filter: invert(100%) hue-rotate(180deg);
        opacity: 0.8;
      }
      
      /* 调整全局文本：降低亮度以适应暗色背景 */
      .nightowl-dark h1, .nightowl-dark h2, .nightowl-dark h3, .nightowl-dark h4, .nightowl-dark h5, .nightowl-dark h6, .nightowl-dark p, .nightowl-dark strong, .nightowl-dark a, .nightowl-dark li, .nightowl-dark span, .nightowl-dark b, .nightowl-dark td, .nightowl-dark th {
        filter: brightness(0.6);
      }

      /* 还原图标：抵消body滤镜 */
      .nightowl-dark .icon {
        filter: invert(100%) hue-rotate(180deg);
      }

      /* 代码块微调：轻微反色以突出背景 */
      .nightowl-dark pre {
        filter: invert(6%);
      }

      /* 列表项标记颜色 */
      .nightowl-dark li::marker {
        color: #666;
      }
    `;
    document.head.appendChild(styleElement);
  }

  /**
   * 2. 应用暗色模式
   */
  function setDarkTheme() {
    currentTheme = DARK_THEME;
    const html = document.querySelector("html");
    if (html) {
      html.classList.remove("nightowl-light");
      html.classList.add("nightowl-dark");
    }
  }

  /**
   * 3. 应用亮色模式
   */
  function setLightTheme() {
    currentTheme = LIGHT_THEME;
    const html = document.querySelector("html");
    if (html) {
      html.classList.remove("nightowl-dark");
      html.classList.add("nightowl-light");
    }
  }
  
  /**
   * 4. 根据当前主题状态应用样式
   */
  function applyTheme() {
    if (currentTheme === DARK_THEME) {
      setDarkTheme();
    } else {
      setLightTheme();
    }
  }
  
  /**
   * 5. 切换主题
   */
  function toggleTheme() {
    currentTheme = (currentTheme === DARK_THEME) ? LIGHT_THEME : DARK_THEME;
    applyTheme();
    saveThemeState();
  }

  /**
   * 6. 从本地存储中读取主题偏好
   */
  function loadInitialTheme() {
    if (!localStorageAvailable) return;
    
    try {
      const savedTheme = localStorage.getItem(STORAGE_KEY);
      if (savedTheme && [DARK_THEME, LIGHT_THEME].includes(savedTheme)) {
        currentTheme = savedTheme;
      }
    } catch (e) {
      console.error("Failed to read theme from localStorage.", e);
    }
  }
  
  /**
   * 7. 保存当前主题状态到本地存储
   */
  function saveThemeState() {
    if (!localStorageAvailable) return;

    if (currentTheme !== null) {
      try {
        localStorage.setItem(STORAGE_KEY, currentTheme);
      } catch (e) {
        console.error("Failed to save theme to localStorage.", e);
      }
    }
  }

  // --- 初始化和事件绑定 ---

  // 页面加载完成后执行
  document.addEventListener("DOMContentLoaded", () => {
    // 注入样式
    addNightOwlStyles();
    
    // 加载用户偏好并应用主题
    loadInitialTheme();
    applyTheme();
    
    // 为主题切换开关绑定点击事件
    const darkModeSwitcher = document.getElementById("darkmode-switch");
    if (darkModeSwitcher) {
      darkModeSwitcher.addEventListener("click", (event) => {
        event.preventDefault(); // 阻止链接默认跳转
        toggleTheme();
      });
    } else {
      console.warn("未找到ID为 'darkmode-switch' 的暗色模式开关。");
    }
  });

})();
</script>
<!-- 暗色模式功能代码结束 (v2) -->