<script>
(function() {
  /*
    终极方案：Auto-Invert Direct Children (自动反转直系子元素)
    原理：
    1. 保持 body 干净（无 filter），确保 fixed 定位正常。
    2. 脚本自动遍历 body 的所有第一级子标签（如 header, main, div, fab），给它们单独加滤镜。
  */

  const STORAGE_KEY = "nightowl-color-scheme";
  const LIGHT_THEME = "light";
  const DARK_THEME = "dark";
  
  let localStorageAvailable = false;
  let currentTheme;

  // 1. 检查 localStorage
  try {
    if (localStorage) localStorageAvailable = true;
  } catch (e) { console.warn("localStorage unavailable"); }

  // 2. 注入 CSS
  function addNightOwlStyles() {
    const styleElement = document.createElement("style");
    styleElement.innerHTML = `
      /* --- 基础清理 --- */
      .nightowl-light body {
        filter: none !important;
      }
      
      /* --- 暗色模式背景 --- */
      .nightowl-dark body {
        background-color: #111; /* 只有背景色，没有 filter */
      }

      /* --- 通用反转类 (由 JS 自动添加) --- */
      .nightowl-inverted {
        filter: invert(100%) hue-rotate(20deg);
      }

      /* --- 针对悬浮元素(FAB)的特殊修正 --- */
      /* 如果你的 FAB 有特定的背景色，这里确保反转正常 */
      .nightowl-inverted.fab, 
      .nightowl-inverted.floating-action-btn {
         /* 可以在这里微调，例如 filter: invert(100%) ... */
      }

      /* --- 针对 Hypothesis 侧边栏的特殊处理 --- */
      /* Hypothesis 通常注入在 body 底部，加上这个类后会自动反转 */
      hypothesis-sidebar,
      hypothesis-adder {
         filter: invert(100%) hue-rotate(20deg) !important;
      }

      /* --- 图片/视频还原 --- */
      /* 只有被加了 inverted 类的容器内部的图片才需要还原 */
      .nightowl-inverted img, 
      .nightowl-inverted video, 
      .nightowl-inverted iframe,
      .nightowl-inverted .custom-cover-layer {
        filter: invert(100%) hue-rotate(340deg) contrast(1.1) saturate(1.1) brightness(1.6);
        opacity: 0.8;
      }

      /* Plyr 全屏修复 */
      .nightowl-inverted .plyr:fullscreen video {
        filter: none !important;
        opacity: 1;
      }

      /* 文本降权 */
      .nightowl-inverted h1, 
      .nightowl-inverted h2, 
      .nightowl-inverted p, 
      .nightowl-inverted a {
        filter: brightness(0.6);
      }
    `;
    document.head.appendChild(styleElement);
  }

  // 3. 核心逻辑：给 Body 的直系子元素切换 Class
  function toggleInvertedClass(enable) {
    // 获取 body 下所有的直系子元素
    const children = document.body.children;
    
    for (let i = 0; i < children.length; i++) {
      const child = children[i];
      const tag = child.tagName.toLowerCase();

      // 排除掉 script, style, meta 等标签，防止报错或逻辑错误
      if (tag === 'script' || tag === 'style' || tag === 'link' || tag === 'meta') {
        continue;
      }

      // 切换类名
      if (enable) {
        child.classList.add('nightowl-inverted');
      } else {
        child.classList.remove('nightowl-inverted');
      }
    }
  }

  // 4. 设置主题
  function setDarkTheme() {
    const html = document.documentElement;
    html.classList.remove("nightowl-light");
    html.classList.add("nightowl-dark");
    
    // 启用子元素滤镜
    toggleInvertedClass(true);
  }

  function setLightTheme() {
    const html = document.documentElement;
    html.classList.remove("nightowl-dark");
    html.classList.add("nightowl-light");
    
    // 移除子元素滤镜
    toggleInvertedClass(false);
  }
  
  function toggleTheme() {
    const isDark = document.documentElement.classList.contains('nightowl-dark');
    currentTheme = isDark ? LIGHT_THEME : DARK_THEME;
    currentTheme === DARK_THEME ? setDarkTheme() : setLightTheme();
    saveThemeState();
  }

  function saveThemeState() {
    if (!localStorageAvailable) return;
    try { localStorage.setItem(STORAGE_KEY, currentTheme); } catch (e) {}
  }

  // 5. 初始化
  document.addEventListener("DOMContentLoaded", () => {
    addNightOwlStyles();
    
    // 如果页面加载时已经是暗色模式（由 head 脚本决定），需要补打 class
    // 检查是否需要立即应用 dark 逻辑
    try {
      if (localStorage.getItem(STORAGE_KEY) === DARK_THEME || document.documentElement.classList.contains("nightowl-dark")) {
         toggleInvertedClass(true);
      }
    } catch(e) {}

    const darkModeSwitcher = document.getElementById("darkmode-switch");
    if (darkModeSwitcher) {
      darkModeSwitcher.addEventListener("click", (event) => {
        event.preventDefault();
        toggleTheme();
      });
    }
    
    // 监听 Hypothesis 加载 (它可能会延迟注入 dom)
    // 使用 MutationObserver 监听 body 变化，防止后加载的元素(如hypothesis)是白色的
    const observer = new MutationObserver((mutations) => {
       if (document.documentElement.classList.contains("nightowl-dark")) {
         mutations.forEach((mutation) => {
           mutation.addedNodes.forEach((node) => {
             if (node.nodeType === 1 && node.tagName !== 'SCRIPT' && node.tagName !== 'STYLE') {
               node.classList.add('nightowl-inverted');
             }
           });
         });
       }
    });
    observer.observe(document.body, { childList: true });
  });

})();
</script>