<script>
(function() {
  /*
    融合修复版：
    1. 机制：自动给 body 直系子元素加滤镜 (解决 fixed 悬浮失效问题)。 
    2. 样式：严格还原用户原始 CSS 中的图片、视频、Feature 区域还原逻辑。
  */

  const STORAGE_KEY = "nightowl-color-scheme";
  const LIGHT_THEME = "light";
  const DARK_THEME = "dark";
  
  let localStorageAvailable = false;
  let currentTheme;

  try {
    if (localStorage) localStorageAvailable = true;
  } catch (e) { console.warn("localStorage unavailable"); }

  function addNightOwlStyles() {
    const styleElement = document.createElement("style");
    styleElement.innerHTML = `
      /* --- 1. 基础环境设置 --- */
      /* 亮色模式：彻底清除滤镜，防止切换回退时残留 */
      .nightowl-light body,
      .nightowl-light .nightowl-inverted {
        filter: none !important;
      }
      
      /* 暗色模式：只设背景色，不设滤镜，保护 fixed 元素 */
      .nightowl-dark body {
        background-color: #111;
      }

      /* --- 2. 核心滤镜类 (由 JS 自动添加到 main, header, fab 等直系子元素) --- */
      /* 相当于原来的 .nightowl-dark body 规则 */
      .nightowl-inverted {
        filter: invert(100%) hue-rotate(20deg);
        background-color: inherit; /* 继承背景，防止缝隙 */
      }
      
      /* 针对 FAB/Hypothesis 侧边栏的强制反色 */
      hypothesis-sidebar,
      hypothesis-adder {
        filter: invert(100%) hue-rotate(20deg) !important;
      }

      /* --- 3. 媒体与特定区域还原 (核心修复部分) --- */
      /* 
         这里应用了你原始代码的参数：
         hue-rotate(340deg) 用于抵消父级的 20deg (360-20=340)
         恢复图片、视频、iframe、自定义封面、feature区域、以及带有 nightowl-daylight 类的元素
      */
      .nightowl-inverted img, 
      .nightowl-inverted video, 
      .nightowl-inverted iframe, 
      .nightowl-inverted .custom-cover-layer, 
      .nightowl-inverted .nightowl-daylight,
      .nightowl-inverted .feature {
        filter: invert(100%) hue-rotate(340deg) contrast(1.1) saturate(1.1) brightness(1.6);
        opacity: 0.8;
      }

      /* --- 4. 视频全屏特殊处理 (Plyr) --- */
      .nightowl-inverted video:fullscreen,
      .nightowl-inverted video:-webkit-full-screen,
      .nightowl-inverted .plyr:fullscreen video,
      .nightowl-inverted .plyr:-webkit-full-screen video,
      .nightowl-inverted .plyr:fullscreen .custom-cover-layer,
      .nightowl-inverted .plyr:-webkit-full-screen .custom-cover-layer {
        filter: none !important;
        opacity: 1;
      }

      /* --- 5. 文本与代码细节调整 (还原原始逻辑) --- */
      /* 降低高亮文字亮度 */
      .nightowl-inverted h1, .nightowl-inverted h2, .nightowl-inverted h3, 
      .nightowl-inverted h4, .nightowl-inverted h5, .nightowl-inverted h6, 
      .nightowl-inverted p, .nightowl-inverted strong, .nightowl-inverted a, 
      .nightowl-inverted li, .nightowl-inverted span, .nightowl-inverted b {
        filter: brightness(0.6);
      }

      /* 代码块微调：轻微反色以突出背景 */
      .nightowl-inverted pre {
        filter: invert(6%);
      }

      /* 列表项标记颜色 */
      .nightowl-inverted li::marker {
        color: #666;
      }
    `;
    document.head.appendChild(styleElement);
  }

  // --- JS 逻辑保持不变 (负责遍历元素) ---
  
  function toggleInvertedClass(enable) {
    const children = document.body.children;
    for (let i = 0; i < children.length; i++) {
      const child = children[i];
      const tag = child.tagName.toLowerCase();
      // 排除 script/style/meta 等非可视标签
      if (['script', 'style', 'link', 'meta', 'title'].includes(tag)) continue;
      
      if (enable) {
        child.classList.add('nightowl-inverted');
      } else {
        child.classList.remove('nightowl-inverted');
      }
    }
  }

  function setDarkTheme() {
    document.documentElement.classList.remove("nightowl-light");
    document.documentElement.classList.add("nightowl-dark");
    toggleInvertedClass(true);
  }

  function setLightTheme() {
    document.documentElement.classList.remove("nightowl-dark");
    document.documentElement.classList.add("nightowl-light");
    toggleInvertedClass(false);
  }
  
  function toggleTheme() {
    const isDark = document.documentElement.classList.contains('nightowl-dark');
    currentTheme = isDark ? LIGHT_THEME : DARK_THEME;
    currentTheme === DARK_THEME ? setDarkTheme() : setLightTheme();
    saveThemeState();
  }

  function saveThemeState() {
    if (!localStorageAvailable) return;
    try { localStorage.setItem(STORAGE_KEY, currentTheme); } catch (e) {}
  }

  document.addEventListener("DOMContentLoaded", () => {
    addNightOwlStyles();
    
    // 初始化检查
    try {
      if (localStorage.getItem(STORAGE_KEY) === DARK_THEME || document.documentElement.classList.contains("nightowl-dark")) {
         toggleInvertedClass(true);
      }
    } catch(e) {}

    const darkModeSwitcher = document.getElementById("darkmode-switch");
    if (darkModeSwitcher) {
      darkModeSwitcher.addEventListener("click", (event) => {
        event.preventDefault();
        toggleTheme();
      });
    }
    
    // 监听动态插入的元素 (如 Hypothesis)
    const observer = new MutationObserver((mutations) => {
       if (document.documentElement.classList.contains("nightowl-dark")) {
         mutations.forEach((mutation) => {
           mutation.addedNodes.forEach((node) => {
             if (node.nodeType === 1 && !['SCRIPT', 'STYLE', 'LINK'].includes(node.tagName)) {
               node.classList.add('nightowl-inverted');
             }
           });
         });
       }
    });
    observer.observe(document.body, { childList: true });
  });

})();
</script>