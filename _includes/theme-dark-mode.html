<script>
(function() {
  /*
    最终修复版 (Fixed Background Patchiness)
    1. 修正背景逻辑：移除 background-color: inherit，解决页面出现白色块的问题。
    2. 严格还原逻辑：保持图片 brightness(1.6) 和 .feature brightness(1.0) 的区别。
    3. 核心机制：继续使用"子元素反转"以保护悬浮 FAB。
  */

  const STORAGE_KEY = "nightowl-color-scheme";
  const LIGHT_THEME = "light";
  const DARK_THEME = "dark";
  
  let localStorageAvailable = false;
  let currentTheme;

  try {
    if (localStorage) localStorageAvailable = true;
  } catch (e) { console.warn("localStorage unavailable"); }

  function addNightOwlStyles() {
    const styleElement = document.createElement("style");
    styleElement.innerHTML = `
      /* --- 1. 基础清理 --- */
      .nightowl-light body,
      .nightowl-light .nightowl-inverted {
        filter: none !important;
      }
      
      /* --- 2. 暗色模式底板 --- */
      /* 必须给 body 一个深色背景，因为子元素若是透明的，就会透出这个颜色 */
      .nightowl-dark body {
        background-color: #111 !important;
        /* 注意：这里不加 filter，这是解决 fab 悬浮的关键 */
      }

      /* --- 3. 核心滤镜 (应用于直系子元素) --- */
      .nightowl-inverted {
        filter: invert(100%) hue-rotate(20deg);
        /* !!! 已删除 background-color: inherit，修复白块问题 !!! */
      }
      
      /* 强制反转 Hypothesis */
      hypothesis-sidebar,
      hypothesis-adder {
        filter: invert(100%) hue-rotate(20deg) !important;
      }

      /* --- 4. 图片/视频还原 (参数：brightness 1.6) --- */
      /* 适用于常规媒体 */
      .nightowl-inverted img, 
      .nightowl-inverted video, 
      .nightowl-inverted iframe, 
      .nightowl-inverted .custom-cover-layer, 
      .nightowl-inverted .nightowl-daylight {
        filter: invert(100%) hue-rotate(340deg) contrast(1.1) saturate(1.1) brightness(1.6);
        opacity: 0.8;
      }

      /* --- 5. .feature 区域还原 (参数：brightness 1.0) --- */
      /* 严格还原你的原始逻辑，不提亮 */
      .nightowl-inverted .feature {
        filter: invert(100%) hue-rotate(340deg) contrast(1.1) saturate(1.1) brightness(1);
        opacity: 0.8;
      }

      /* --- 6. 视频全屏修复 --- */
      .nightowl-inverted video:fullscreen,
      .nightowl-inverted video:-webkit-full-screen,
      .nightowl-inverted .plyr:fullscreen video,
      .nightowl-inverted .plyr:-webkit-full-screen video,
      .nightowl-inverted .plyr:fullscreen .custom-cover-layer,
      .nightowl-inverted .plyr:-webkit-full-screen .custom-cover-layer {
        filter: none !important;
        opacity: 1;
      }

      /* --- 7. 文本与代码细节 (保持一致) --- */
      .nightowl-inverted h1, .nightowl-inverted h2, .nightowl-inverted h3, 
      .nightowl-inverted h4, .nightowl-inverted h5, .nightowl-inverted h6, 
      .nightowl-inverted p, .nightowl-inverted strong, .nightowl-inverted a, 
      .nightowl-inverted li, .nightowl-inverted span, .nightowl-inverted b {
        filter: brightness(0.6);
      }

      .nightowl-inverted pre {
        filter: invert(6%);
      }

      .nightowl-inverted li::marker {
        color: #666;
      }
    `;
    document.head.appendChild(styleElement);
  }

  // --- JS 逻辑 (保持不变) ---
  
  function toggleInvertedClass(enable) {
    const children = document.body.children;
    for (let i = 0; i < children.length; i++) {
      const child = children[i];
      // 排除非视觉元素
      if (['script', 'style', 'link', 'meta', 'title'].includes(child.tagName.toLowerCase())) continue;
      
      if (enable) {
        child.classList.add('nightowl-inverted');
      } else {
        child.classList.remove('nightowl-inverted');
      }
    }
  }

  function setDarkTheme() {
    document.documentElement.classList.remove("nightowl-light");
    document.documentElement.classList.add("nightowl-dark");
    toggleInvertedClass(true);
  }

  function setLightTheme() {
    document.documentElement.classList.remove("nightowl-dark");
    document.documentElement.classList.add("nightowl-light");
    toggleInvertedClass(false);
  }
  
  function toggleTheme() {
    const isDark = document.documentElement.classList.contains('nightowl-dark');
    currentTheme = isDark ? LIGHT_THEME : DARK_THEME;
    currentTheme === DARK_THEME ? setDarkTheme() : setLightTheme();
    saveThemeState();
  }

  function saveThemeState() {
    if (!localStorageAvailable) return;
    try { localStorage.setItem(STORAGE_KEY, currentTheme); } catch (e) {}
  }

  document.addEventListener("DOMContentLoaded", () => {
    addNightOwlStyles();
    
    try {
      if (localStorage.getItem(STORAGE_KEY) === DARK_THEME || document.documentElement.classList.contains("nightowl-dark")) {
         toggleInvertedClass(true);
      }
    } catch(e) {}

    const darkModeSwitcher = document.getElementById("darkmode-switch");
    if (darkModeSwitcher) {
      darkModeSwitcher.addEventListener("click", (event) => {
        event.preventDefault();
        toggleTheme();
      });
    }
    
    const observer = new MutationObserver((mutations) => {
       if (document.documentElement.classList.contains("nightowl-dark")) {
         mutations.forEach((mutation) => {
           mutation.addedNodes.forEach((node) => {
             if (node.nodeType === 1 && !['SCRIPT', 'STYLE', 'LINK'].includes(node.tagName)) {
               node.classList.add('nightowl-inverted');
             }
           });
         });
       }
    });
    observer.observe(document.body, { childList: true });
  });

})();
</script>