<!-- 暗色模式功能代码开始 (v3 - 动态背景图修复版) -->
<script>
(function() {
  // --- 常量和变量定义 ---
  const STORAGE_KEY = "nightowl-color-scheme";
  const LIGHT_THEME = "light";
  const DARK_THEME = "dark";
  
  let localStorageAvailable = false;
  let currentTheme = LIGHT_THEME; // 默认主题

  // 尝试访问 localStorage
  try {
    if (localStorage) {
      localStorageAvailable = true;
    }
  } catch (e) {
    console.warn("localStorage is not available.");
  }

  // --- 核心功能函数 ---

  /**
   * 1. 注入实现暗色模式所需要的 CSS 样式
   */
  function addNightOwlStyles() {
    const styleElement = document.createElement("style");
    styleElement.innerHTML = `
      /* 防止定位不一致 */
      .nightowl-light body {
        filter: invert(0%);
      }
      
      .nightowl-dark {
        /* Firefox 的后备方案 */
        background-color: #111;
      }

      /* 核心反色逻辑，维持不变 */
      .nightowl-dark body {
        filter: invert(100%) hue-rotate(180deg);
      }

      /* --- 媒体元素规则 (您的原版) --- */
      .nightowl-dark img, .nightowl-dark video, .nightowl-dark iframe, .nightowl-dark .nightowl-daylight {
        filter: invert(100%) hue-rotate(180deg) contrast(1.1) saturate(1.2);
        opacity: 0.8;
      }
      
      /* --- 文本元素规则 (您的原版) --- */
      .nightowl-dark h1, .nightowl-dark h2, .nightowl-dark h3, .nightowl-dark h4, .nightowl-dark h5, .nightowl-dark h6, .nightowl-dark p, .nightowl-dark strong, .nightowl-dark a, .nightowl-dark li, .nightowl-dark span, .nightowl-dark b, .nightowl-dark td, .nightowl-dark th {
        filter: brightness(0.6);
      }

      /* --- 图标规则 (您的原版) --- */
      .nightowl-dark .icon {
        filter: invert(100%) hue-rotate(180deg);
      }

      /* --- 代码块规则 (您的原版) --- */
      .nightowl-dark pre {
        filter: invert(6%);
      }

      /* --- 列表标记规则 (您的原版) --- */
      .nightowl-dark li::marker {
        color: #666;
      }

      /* --- 【新增】专门处理 .feature 动态背景图的CSS --- */
      .nightowl-dark .feature {
        position: relative;
        isolation: isolate;
        /* JS 会在暗色模式下移除元素自身的背景图 */
      }
      
      .nightowl-dark .feature::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: -1;
        
        /* 关键：使用CSS变量从JS动态接收背景图URL */
        background-image: var(--feature-bg-image);
        
        /* 尽量保持原有的背景图样式 */
        background-size: cover;
        background-position: center;
        
        /* 在这个独立的伪元素上恢复颜色并应用透明度 */
        filter: invert(100%) hue-rotate(180deg);
        opacity: 0.8;
      }
    `;
    document.head.appendChild(styleElement);
  }

  /**
   * 2. 应用暗色模式
   */
  function setDarkTheme() {
    currentTheme = DARK_THEME;
    const html = document.querySelector("html");
    if (html) {
      html.classList.remove("nightowl-light");
      html.classList.add("nightowl-dark");
    }

    // 【新增】处理所有 .feature 元素的背景图
    document.querySelectorAll('.feature').forEach(el => {
      // 检查元素是否有内联的 background-image 样式
      if (el.style.backgroundImage) {
        // 将背景图URL存入CSS变量，供 ::before 伪元素使用
        el.style.setProperty('--feature-bg-image', el.style.backgroundImage);
        // 移除元素自身的背景图，防止冲突
        el.style.backgroundImage = 'none';
      }
    });
  }

  /**
   * 3. 应用亮色模式
   */
  function setLightTheme() {
    currentTheme = LIGHT_THEME;
    const html = document.querySelector("html");
    if (html) {
      html.classList.remove("nightowl-dark");
      html.classList.add("nightowl-light");
    }

    // 【新增】恢复所有 .feature 元素的背景图
    document.querySelectorAll('.feature').forEach(el => {
      const originalBg = el.style.getPropertyValue('--feature-bg-image');
      if (originalBg) {
        // 将之前保存的背景图URL恢复到元素自身
        el.style.backgroundImage = originalBg;
        // 移除CSS变量
        el.style.removeProperty('--feature-bg-image');
      }
    });
  }
  
  /**
   * 4. 根据当前主题状态应用样式
   */
  function applyTheme() {
    if (currentTheme === DARK_THEME) {
      setDarkTheme();
    } else {
      setLightTheme();
    }
  }
  
  /**
   * 5. 切换主题
   */
  function toggleTheme() {
    currentTheme = (currentTheme === DARK_THEME) ? LIGHT_THEME : DARK_THEME;
    applyTheme();
    saveThemeState();
  }

  /**
   * 6. 从 localStorage 读取已保存的主题偏好
   */
  function loadInitialTheme() {
    if (!localStorageAvailable) return;
    
    try {
      const savedTheme = localStorage.getItem(STORAGE_KEY);
      if (savedTheme && [DARK_THEME, LIGHT_THEME].includes(savedTheme)) {
        currentTheme = savedTheme;
      }
    } catch (e) {
      console.error("Failed to read theme from localStorage.", e);
    }
  }
  
  /**
   * 7. 将当前主题状态保存到 localStorage
   */
  function saveThemeState() {
    if (!localStorageAvailable) return;

    if (currentTheme !== null) {
      try {
        localStorage.setItem(STORAGE_KEY, currentTheme);
      } catch (e) {
        console.error("Failed to save theme to localStorage.", e);
      }
    }
  }

  // --- 初始化和事件绑定 ---

  document.addEventListener("DOMContentLoaded", () => {
    addNightOwlStyles();
    loadInitialTheme();
    applyTheme();
    
    const darkModeSwitcher = document.getElementById("darkmode-switch");
    if (darkModeSwitcher) {
      darkModeSwitcher.addEventListener("click", (event) => {
        event.preventDefault();
        toggleTheme();
      });
    } else {
      console.warn("Dark mode switch with id 'darkmode-switch' not found.");
    }
  });

})();
</script>
<!-- 暗色模式功能代码结束 (v3 - 动态背景图修复版) -->